<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tonnylays Construction</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- html2canvas library for export functionality -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #1a365d;
            --secondary: #2b6cb0;
            --accent: #dd6b20;
            --success: #38a169;
            --danger: #e53e3e;
            --warning: #d69e2e;
            --info: #3182ce;
            --light: #f7fafc;
            --dark: #2d3748;
            --border: #e2e8f0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            font-size: 15px;
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Mobile Menu */
        .mobile-menu {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 10px;
        }

        .mobile-menu.active {
            display: block;
        }

        .mobile-nav {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
        }

        .mobile-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 5px;
            border: none;
            background: none;
            border-radius: 8px;
            font-size: 0.7rem;
            color: var(--dark);
            transition: all 0.3s;
        }

        .mobile-nav-btn i {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }

        .mobile-nav-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Mobile Header */
        .mobile-header {
            display: none;
            background: white;
            color: var(--primary);
            padding: 15px;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .mobile-header h1 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: space-between;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--primary);
            cursor: pointer;
        }

        .mobile-nav-menu {
            display: none;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            background: white;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .mobile-nav-menu.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .mobile-nav-item {
            display: block;
            padding: 12px 15px;
            color: var(--dark);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mobile-nav-item:hover,
        .mobile-nav-item.active {
            background: var(--primary);
            color: white;
        }

        /* Main Container */
        .main-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            padding-bottom: 70px;
        }

        /* Header */
        .header {
            background: white;
            color: var(--primary);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--secondary));
        }

        .header h1 {
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header h1 i {
            color: var(--accent);
        }

        .header-controls {
            display: flex;
            gap: 8px;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            overflow-x: auto;
            background: white;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 8px;
            scrollbar-width: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            padding: 10px 15px;
            white-space: nowrap;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            background-color: #f0f7ff;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-color: var(--secondary);
            box-shadow: 0 2px 4px rgba(43, 108, 176, 0.2);
        }

        /* Content Sections */
        .content-section {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
            flex-wrap: wrap;
            gap: 10px;
        }

        .section-header h2 {
            color: var(--primary);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
            min-height: 40px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary), #4c8bf5);
            color: white;
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(66, 153, 225, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #48bb78);
            color: white;
            box-shadow: 0 2px 4px rgba(72, 187, 120, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(72, 187, 120, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #fc8181);
            color: white;
            box-shadow: 0 2px 4px rgba(245, 101, 101, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(245, 101, 101, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #ed8936);
            color: white;
            box-shadow: 0 2px 4px rgba(237, 137, 54, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(237, 137, 54, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info), #63b3ed);
            color: white;
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.3);
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(66, 153, 225, 0.4);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
            min-height: 32px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--secondary);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th {
            background: linear-gradient(to bottom, var(--light), #edf2f7);
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background-color: #f8fafc;
        }

        /* Day Works Table Styles */
        .day-works-table th,
        .day-works-table td {
            padding: 8px 10px;
            font-size: 0.9rem;
        }

        .day-works-table .editable {
            background-color: #fffde7;
            padding: 4px 6px !important;
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 3px;
        }

        .day-works-table .editable:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.2);
        }

        .day-works-table .total-cell {
            background-color: #e8f5e9;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .day-works-table .total-cell:hover {
            background-color: #d4edda;
        }

        .day-works-table .totals-row {
            background: linear-gradient(135deg, var(--primary), var(--secondary)) !important;
            color: white;
            font-weight: bold;
        }

        .day-works-table .day-of-week {
            font-size: 0.8rem;
            color: var(--dark);
            display: block;
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95rem;
            background: white;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* Attendance Grid - ENHANCED */
        .attendance-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            border-radius: 12px;
            color: white;
        }

        .attendance-controls label {
            color: white;
        }

        .attendance-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .attendance-grid-container {
            overflow-x: auto;
            border-radius: 12px;
            margin-bottom: 15px;
            background: white;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .attendance-grid {
            min-width: 800px;
            border-collapse: separate;
            border-spacing: 5px;
        }

        .attendance-grid th {
            text-align: center;
            padding: 12px 8px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 8px;
            border: none;
        }

        .attendance-grid td {
            text-align: center;
            padding: 10px 8px;
            border: none;
        }

        .day-cell {
            min-width: 50px;
            height: 50px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 1.1rem;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            text-align: center;
            line-height: 50px;
        }

        .day-cell:hover {
            transform: scale(1.05);
            border-color: var(--secondary);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1;
        }

        .day-cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 10px;
            z-index: -1;
        }

        .day-cell.present {
            background: linear-gradient(135deg, #38a169, #2f855a);
            color: white;
            border: 3px solid #2f855a !important;
            box-shadow: 0 3px 6px rgba(56, 161, 105, 0.3);
        }

        .day-cell.present::before {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
        }

        .day-cell.absent {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
            border: 3px solid #c53030 !important;
            box-shadow: 0 3px 6px rgba(229, 62, 62, 0.3);
        }

        .day-cell.absent::before {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
        }

        .day-cell.empty {
            background: #f7fafc;
            border: 3px solid var(--border) !important;
            color: var(--dark);
        }

        .worker-row {
            border-top: 2px solid var(--border);
        }

        .worker-name-cell {
            font-weight: 600;
            white-space: nowrap;
            padding: 12px;
            background: linear-gradient(135deg, #4a5568, #2d3748);
            color: white;
            width: 150px;
            min-width: 150px;
            max-width: 150px;
            border-radius: 8px;
            border: 3px solid var(--dark);
            position: sticky;
            left: 0;
            z-index: 2;
        }

        .worker-name-cell::after {
            content: attr(data-role);
            display: block;
            font-size: 0.8rem;
            color: #cbd5e0;
            font-weight: normal;
            margin-top: 4px;
        }

        /* Search Box */
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box input {
            padding-left: 40px;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--dark);
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
            border: 2px solid var(--border);
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--secondary));
        }

        .stat-card {
            text-align: center;
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }

        .stat-label {
            color: var(--dark);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        /* Role Breakdown Enhanced */
        .role-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .role-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .role-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: white;
        }

        .role-amount {
            font-size: 1.8rem;
            font-weight: bold;
            color: white;
        }

        .role-count {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Sub-tabs */
        .sub-tabs {
            display: flex;
            overflow-x: auto;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .sub-tab {
            padding: 10px 20px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            border-bottom: 3px solid transparent;
        }

        .sub-tab:hover {
            color: var(--secondary);
        }

        .sub-tab.active {
            color: var(--secondary);
            border-bottom-color: var(--secondary);
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 15px;
            backdrop-filter: blur(3px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Sites List Enhanced */
        .sites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .site-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 2px solid var(--border);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .site-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .site-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--accent), var(--secondary));
        }

        .site-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .site-name {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .site-actions {
            display: flex;
            gap: 5px;
        }

        .workers-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .worker-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .worker-list-item:hover {
            background: #e9ecef;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 2px solid transparent;
        }

        .status-pending {
            background: linear-gradient(135deg, #feebc8, #ed8936);
            color: #744210;
            border-color: #ed8936;
        }

        .status-paid {
            background: linear-gradient(135deg, #c6f6d5, #38a169);
            color: #22543d;
            border-color: #38a169;
        }

        .status-deducted {
            background: linear-gradient(135deg, #bee3f8, #3182ce);
            color: #2c5282;
            border-color: #3182ce;
        }

        .status-active {
            background: linear-gradient(135deg, #c6f6d5, #38a169);
            color: #22543d;
            border-color: #38a169;
        }

        .status-inactive {
            background: linear-gradient(135deg, #fed7d7, #e53e3e);
            color: #742a2a;
            border-color: #e53e3e;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Invoice Preview - Mobile Optimized */
        .invoice-preview-modal .modal-content {
            max-width: 95%;
            width: 95%;
        }

        .invoice-preview-content {
            padding: 20px;
            background: #f8f9fa;
        }

        .invoice-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
            border: 3px solid white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .invoice-header::before {
            content: 'üèóÔ∏è';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 3rem;
            opacity: 0.2;
        }

        .invoice-header h2 {
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .invoice-header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .invoice-company {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid var(--accent);
        }

        .invoice-company h4 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .invoice-company p {
            margin: 5px 0;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .invoice-company i {
            color: var(--accent);
            width: 20px;
        }

        /* Rate Table Styles */
        .rates-table .editable-rate {
            background-color: #e8f5e9;
            padding: 4px 6px !important;
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 3px;
        }

        .rates-table .editable-rate:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.2);
        }

        /* Payment Status */
        .payment-status-select {
            padding: 6px 12px;
            border-radius: 6px;
            border: 2px solid var(--border);
            font-weight: 600;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-status-select:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .payment-paid {
            background-color: #f0fff4;
            color: #22543d;
            text-decoration: line-through;
            opacity: 0.7;
        }

        /* Worker Actions in Attendance */
        .worker-action-cell {
            position: sticky;
            left: 150px;
            z-index: 2;
            background: white;
            border-right: 2px solid var(--border);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .mobile-header {
                display: block;
            }

            .header {
                display: none;
            }

            .nav-tabs {
                display: none;
            }

            .mobile-menu {
                display: grid;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .content-section {
                padding: 12px;
            }

            .section-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .section-header h2 {
                text-align: center;
                font-size: 1.2rem;
            }

            .btn {
                width: 100%;
                padding: 12px;
            }

            .action-buttons {
                width: 100%;
                justify-content: center;
            }

            .attendance-grid {
                min-width: 100%;
            }

            .worker-name-cell {
                width: 120px;
                min-width: 120px;
                max-width: 120px;
                font-size: 0.9rem;
            }

            .day-cell {
                min-width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .sites-grid {
                grid-template-columns: 1fr;
            }

            .invoice-preview-modal .modal-content {
                max-width: 100%;
                width: 100%;
                margin: 10px;
            }

            .mobile-nav {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (min-width: 769px) {
            .mobile-menu {
                display: none;
            }

            .mobile-header {
                display: none;
            }

            .mobile-nav-menu {
                display: none !important;
            }
        }

        /* Alerts */
        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease;
            border: 2px solid transparent;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
            color: #22543d;
            border-color: #9ae6b4;
        }

        .alert-error {
            background: linear-gradient(135deg, #fed7d7, #fc8181);
            color: #742a2a;
            border-color: #fc8181;
        }

        .close-alert {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: inherit;
            padding: 0 5px;
        }

        /* Save Attendance Button */
        .save-attendance-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            padding: 0;
        }

        .save-attendance-btn i {
            font-size: 1.5rem;
        }
    </style>
</head>

<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <h1>
            <span><i class="fas fa-hard-hat"></i> Tonnylays</span>
            <button class="menu-toggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
        </h1>
        <div class="mobile-nav-menu" id="mobileNavMenu">
            <a href="#" class="mobile-nav-item active" onclick="switchTab('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="#" class="mobile-nav-item" onclick="switchTab('workers')">
                <i class="fas fa-users"></i> Workers
            </a>
            <a href="#" class="mobile-nav-item" onclick="switchTab('attendance')">
                <i class="fas fa-clipboard-check"></i> Attendance
            </a>
            <a href="#" class="mobile-nav-item" onclick="switchTab('dayworks')">
                <i class="fas fa-calculator"></i> Day Works
            </a>
            <a href="#" class="mobile-nav-item" onclick="switchTab('payroll')">
                <i class="fas fa-money-check-alt"></i> Payroll
            </a>
            <a href="#" class="mobile-nav-item" onclick="switchTab('payroll-payments')">
                <i class="fas fa-credit-card"></i> Payroll Payments
            </a>
            <a href="#" class="mobile-nav-item" onclick="switchTab('loans')">
                <i class="fas fa-hand-holding-usd"></i> Loans/Credit
            </a>
            <a href="#" class="mobile-nav-item" onclick="switchTab('sites')">
                <i class="fas fa-map-marker-alt"></i> Sites
            </a>
            <a href="#" class="mobile-nav-item" onclick="switchTab('expenses')">
                <i class="fas fa-receipt"></i> Expenses
            </a>
            <a href="#" class="mobile-nav-item" onclick="switchTab('invoices')">
                <i class="fas fa-file-invoice"></i> Invoices
            </a>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-menu">
        <div class="mobile-nav">
            <button class="mobile-nav-btn active" onclick="switchMobileTab('dashboard')">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchMobileTab('workers')">
                <i class="fas fa-users"></i>
                <span>Workers</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchMobileTab('attendance')">
                <i class="fas fa-clipboard-check"></i>
                <span>Attendance</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchMobileTab('dayworks')">
                <i class="fas fa-calculator"></i>
                <span>Day Works</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchMobileTab('payroll')">
                <i class="fas fa-money-check-alt"></i>
                <span>Payroll</span>
            </button>
        </div>
    </div>

    <div class="main-container">
        <!-- Header -->
        <header class="header">
            <h1><i class="fas fa-hard-hat"></i> Tonnylays Construction</h1>
            <div class="header-controls">
                <button class="btn btn-primary btn-sm" onclick="saveAllData()">
                    <i class="fas fa-save"></i> Save All
                </button>
                <button class="btn btn-info btn-sm" onclick="refreshAllData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-primary btn-sm" onclick="backupData()">
                    <i class="fas fa-download"></i> Backup
                </button>
                <button class="btn btn-success btn-sm" onclick="showModal('restoreModal')">
                    <i class="fas fa-upload"></i> Restore
                </button>
            </div>
        </header>

        <!-- Desktop Navigation -->
        <nav class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </div>
            <div class="nav-tab" onclick="switchTab('workers')">
                <i class="fas fa-users"></i> Workers
            </div>
            <div class="nav-tab" onclick="switchTab('attendance')">
                <i class="fas fa-clipboard-check"></i> Attendance
            </div>
            <div class="nav-tab" onclick="switchTab('dayworks')">
                <i class="fas fa-calculator"></i> Day Works
            </div>
            <div class="nav-tab" onclick="switchTab('payroll')">
                <i class="fas fa-money-check-alt"></i> Payroll
            </div>
            <div class="nav-tab" onclick="switchTab('payroll-payments')">
                <i class="fas fa-credit-card"></i> Payroll Payments
            </div>
            <div class="nav-tab" onclick="switchTab('loans')">
                <i class="fas fa-hand-holding-usd"></i> Loans/Credit
            </div>
            <div class="nav-tab" onclick="switchTab('sites')">
                <i class="fas fa-map-marker-alt"></i> Sites
            </div>
            <div class="nav-tab" onclick="switchTab('expenses')">
                <i class="fas fa-receipt"></i> Expenses
            </div>
            <div class="nav-tab" onclick="switchTab('invoices')">
                <i class="fas fa-file-invoice"></i> Invoices
            </div>
        </nav>

        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <div class="section-header">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h2>
                <select id="dashboardSiteFilter" onchange="updateDashboard()" style="width: 200px; padding: 8px 12px;">
                    <option value="all">All Sites</option>
                </select>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card stat-card">
                    <div class="stat-label">Total Workers</div>
                    <div id="totalWorkers" class="stat-number">0</div>
                    <div class="stat-sub">Active: <span id="activeWorkers">0</span></div>
                </div>

                <div class="dashboard-card stat-card">
                    <div class="stat-label">Active Sites</div>
                    <div id="activeSites" class="stat-number">0</div>
                    <div class="stat-sub">Active workers assigned</div>
                </div>

                <div class="dashboard-card stat-card">
                    <div class="stat-label">Current Payroll</div>
                    <div id="currentPayroll" class="stat-number">R0</div>
                    <div class="stat-sub">Based on attendance</div>
                </div>

                <div class="dashboard-card stat-card">
                    <div class="stat-label">Pending Loans</div>
                    <div id="pendingLoans" class="stat-number">R0</div>
                    <div class="stat-sub">To be collected</div>
                </div>
            </div>

            <div class="section-header">
                <h2><i class="fas fa-chart-bar"></i> Payroll Breakdown by Role</h2>
            </div>

            <div id="rolePayrollBreakdown" class="role-breakdown">
                <!-- Will be populated by JavaScript -->
            </div>

            <div class="card">
                <div class="card-header">Quick Actions</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; padding: 15px;">
                    <button class="btn btn-primary" onclick="switchTab('attendance')">
                        <i class="fas fa-clipboard-check"></i> Mark Attendance
                    </button>
                    <button class="btn btn-success" onclick="switchTab('payroll')">
                        <i class="fas fa-calculator"></i> Calculate Payroll
                    </button>
                    <button class="btn btn-warning" onclick="switchTab('loans')">
                        <i class="fas fa-hand-holding-usd"></i> Add Loan/Credit
                    </button>
                    <button class="btn btn-danger" onclick="switchTab('expenses')">
                        <i class="fas fa-receipt"></i> Record Expense
                    </button>
                </div>
            </div>
        </section>

        <!-- Workers Section -->
        <section id="workers" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> Workers Management</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showModal('workerModal')">
                        <i class="fas fa-plus"></i> Add Worker
                    </button>
                    <button class="btn btn-success" onclick="exportWorkersExcel()">
                        <i class="fas fa-file-excel"></i> Export
                    </button>
                    <button class="btn btn-warning" onclick="showModal('importExcelModal')">
                        <i class="fas fa-file-import"></i> Import
                    </button>
                </div>
            </div>

            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="workerSearch" placeholder="Search workers by name, surname, role or ID..."
                    onkeyup="filterWorkers()">
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Surname</th>
                            <th>ID Number</th>
                            <th>Role</th>
                            <th>Daily Rate</th>
                            <th>Bank</th>
                            <th>Account</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="workersTableBody">
                        <!-- Workers will be populated here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Attendance Section -->
        <section id="attendance" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-clipboard-check"></i> Attendance Register</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showModal('fortnightModal')">
                        <i class="fas fa-calendar-plus"></i> New Fortnight
                    </button>
                    <button class="btn btn-warning" onclick="showModal('manageFortnightsModal')">
                        <i class="fas fa-calendar-alt"></i> Manage
                    </button>
                </div>
            </div>

            <div class="attendance-controls">
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label for="attendanceSite">Site</label>
                    <select id="attendanceSite" onchange="loadAttendanceGrid()">
                        <option value="">Select Site</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label for="fortnightSelect">Fortnight</label>
                    <select id="fortnightSelect" onchange="loadAttendanceGrid()">
                        <option value="">Select Fortnight</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label>&nbsp;</label>
                    <button class="btn btn-success" onclick="showModal('addWorkersToSiteModal')">
                        <i class="fas fa-user-plus"></i> Add Workers
                    </button>
                </div>
            </div>

            <!-- Search Box for Workers -->
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="attendanceSearch" placeholder="Search workers by name or role..."
                    onkeyup="filterAttendanceWorkers()">
            </div>

            <div class="attendance-grid-container">
                <table class="attendance-grid" id="attendanceGrid">
                    <thead>
                        <tr id="attendanceHeader">
                            <th class="worker-name-cell">Worker</th>
                            <th class="worker-action-cell">Actions</th>
                            <!-- Dates will be populated here -->
                        </tr>
                    </thead>
                    <tbody id="attendanceBody">
                        <!-- Workers and attendance will be populated here -->
                    </tbody>
                </table>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>Attendance Summary</span>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="saveAttendance()" id="saveAttendanceBtn"
                            style="display: none;">
                            <i class="fas fa-save"></i> Save Attendance
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="exportAttendancePDF()">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn btn-sm btn-success" onclick="exportAttendanceExcel()">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                    </div>
                </div>
                <div id="attendanceSummary">
                    <p>Select site and fortnight to view summary</p>
                </div>
            </div>
        </section>

        <!-- Day Works Section -->
        <section id="dayworks" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-calculator"></i> Day Works Calculator</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showModal('ratesModal')">
                        <i class="fas fa-cog"></i> Edit Rates
                    </button>
                    <button class="btn btn-success" onclick="exportDayWorksClientReport()">
                        <i class="fas fa-file-export"></i> Client Report
                    </button>
                    <button class="btn btn-info" onclick="exportDayWorksFullReport()">
                        <i class="fas fa-file-alt"></i> Full Report
                    </button>
                </div>
            </div>

            <div class="attendance-controls">
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label for="dayWorksSite">Site</label>
                    <select id="dayWorksSite" onchange="loadDayWorksFromAttendance()">
                        <option value="">Select Site</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label for="dayWorksFortnight">Fortnight</label>
                    <select id="dayWorksFortnight" onchange="loadDayWorksFromAttendance()">
                        <option value="">Select Fortnight</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label>&nbsp;</label>
                    <button class="btn btn-success" onclick="calculateAllDayWorksTotals()">
                        <i class="fas fa-calculator"></i> Calculate
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="day-works-table" id="dayWorksTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Day</th>
                            <th>Bricklayer</th>
                            <th>Labourers</th>
                            <th>Foreman</th>
                            <th>Transport</th>
                            <th>Hours</th>
                            <th>O/T Hours</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="dayWorksBody">
                        <!-- Day works data will be populated here -->
                    </tbody>
                    <tfoot>
                        <tr class="totals-row">
                            <td colspan="2">TOTALS</td>
                            <td id="total-bricklayer">0</td>
                            <td id="total-labourers">0</td>
                            <td id="total-foreman">0</td>
                            <td id="total-transport">0</td>
                            <td id="total-hours">0</td>
                            <td id="total-overtime">0</td>
                            <td id="grand-total">R0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="card">
                <div class="card-header">Notes</div>
                <div style="padding: 15px; font-size: 0.9rem;">
                    <p><strong>Note:</strong> Overtime hours are entered manually. Monday-Thursday: 9 normal hours. Friday: 6 hours + 3.5 overtime. Weekend: all overtime.</p>
                    <p><strong>Export:</strong> Client report shows only essential columns. Full report includes all data.</p>
                </div>
            </div>
        </section>

        <!-- Payroll Section -->
        <section id="payroll" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-money-check-alt"></i> Payroll Calculator</h2>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="showModal('payrollHistoryModal')">
                        <i class="fas fa-history"></i> History
                    </button>
                </div>
            </div>

            <div class="sub-tabs">
                <div class="sub-tab active" onclick="switchSubTab('payroll', 'single')">Single Site</div>
                <div class="sub-tab" onclick="switchSubTab('payroll', 'combined')">Combined Sites</div>
            </div>

            <div id="payroll-single" class="sub-tab-content active">
                <div class="attendance-controls">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="payrollSite">Site</label>
                        <select id="payrollSite" onchange="loadPayroll()">
                            <option value="">Select Site</option>
                        </select>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="payrollFortnight">Fortnight</label>
                        <select id="payrollFortnight" onchange="loadPayroll()">
                            <option value="">Select Fortnight</option>
                        </select>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>&nbsp;</label>
                        <button class="btn btn-success" onclick="calculatePayroll()">
                            <i class="fas fa-calculator"></i> Calculate
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="payrollTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Days</th>
                                <th>Rate</th>
                                <th>Gross</th>
                                <th>Loans</th>
                                <th>Credit</th>
                                <th>Net Pay</th>
                            </tr>
                        </thead>
                        <tbody id="payrollTableBody">
                            <!-- Payroll will be populated here -->
                        </tbody>
                        <tfoot>
                            <tr id="payrollTotalRow"
                                style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;">
                                <td colspan="4" style="text-align: right; font-weight: bold;">TOTAL:</td>
                                <td id="totalGross">R0</td>
                                <td id="totalLoans">R0</td>
                                <td id="totalCredit">R0</td>
                                <td id="totalNet" style="font-weight: bold;">R0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div style="text-align: right; margin-top: 15px;">
                    <button class="btn btn-primary" onclick="exportPayrollPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button class="btn btn-success" onclick="savePayroll()">
                        <i class="fas fa-save"></i> Save Payroll
                    </button>
                </div>
            </div>

            <div id="payroll-combined" class="sub-tab-content">
                <div class="attendance-controls">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="combinedStartDate">Start Date</label>
                        <input type="date" id="combinedStartDate" onchange="loadCombinedPayroll()">
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="combinedEndDate">End Date</label>
                        <input type="date" id="combinedEndDate" onchange="loadCombinedPayroll()">
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>&nbsp;</label>
                        <button class="btn btn-success" onclick="calculateCombinedPayroll()">
                            <i class="fas fa-calculator"></i> Calculate
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="combinedPayrollTable">
                        <thead>
                            <tr>
                                <th>Worker</th>
                                <th>Sites Worked</th>
                                <th>Total Days</th>
                                <th>Avg Rate</th>
                                <th>Gross</th>
                                <th>Loans</th>
                                <th>Credit</th>
                                <th>Net Pay</th>
                            </tr>
                        </thead>
                        <tbody id="combinedPayrollTableBody">
                            <!-- Combined payroll will be populated here -->
                        </tbody>
                        <tfoot>
                            <tr style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;">
                                <td colspan="4" style="text-align: right; font-weight: bold;">TOTAL:</td>
                                <td id="combinedTotalGross">R0</td>
                                <td id="combinedTotalLoans">R0</td>
                                <td id="combinedTotalCredit">R0</td>
                                <td id="combinedTotalNet" style="font-weight: bold;">R0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div style="text-align: right; margin-top: 15px;">
                    <button class="btn btn-primary" onclick="exportCombinedPayrollPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                </div>
            </div>
        </section>

        <!-- Payroll Payments Section -->
        <section id="payroll-payments" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-credit-card"></i> Payroll Payments</h2>
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="markAllAsPaid()">
                        <i class="fas fa-check-circle"></i> Mark All Paid
                    </button>
                    <button class="btn btn-primary" onclick="exportPaymentsPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                </div>
            </div>

            <div class="attendance-controls">
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label for="paymentsSite">Site</label>
                    <select id="paymentsSite" onchange="loadPayrollPayments()">
                        <option value="">Select Site</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label for="paymentsFortnight">Fortnight</label>
                    <select id="paymentsFortnight" onchange="loadPayrollPayments()">
                        <option value="">Select Fortnight</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label>&nbsp;</label>
                    <button class="btn btn-info" onclick="loadPayrollPayments()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table id="paymentsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Account</th>
                            <th>Net Pay</th>
                            <th>Payment Status</th>
                            <th>Payment Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody">
                        <!-- Payments will be populated here -->
                    </tbody>
                    <tfoot>
                        <tr style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;">
                            <td colspan="3" style="text-align: right; font-weight: bold;">TOTAL:</td>
                            <td id="paymentsTotalNet" style="font-weight: bold;">R0</td>
                            <td id="paymentsStatusSummary"></td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </section>

        <!-- Loans/Credit Section -->
        <section id="loans" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-hand-holding-usd"></i> Loans & Credit Management</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showModal('addLoanModal')">
                        <i class="fas fa-plus"></i> Add Loan/Credit
                    </button>
                </div>
            </div>

            <div class="sub-tabs">
                <div class="sub-tab active" onclick="switchSubTab('loans', 'loans')">Loans (They Owe Us)</div>
                <div class="sub-tab" onclick="switchSubTab('loans', 'credit')">Credit (We Owe Them)</div>
                <div class="sub-tab" onclick="switchSubTab('loans', 'all')">All Transactions</div>
            </div>

            <div id="loans-loans" class="sub-tab-content active">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Worker</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="loansTableBody">
                            <!-- Loans will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="loans-credit" class="sub-tab-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Worker</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="creditTableBody">
                            <!-- Credit will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="loans-all" class="sub-tab-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Worker</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allLoansTableBody">
                            <!-- All transactions will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Sites Section -->
        <section id="sites" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-map-marker-alt"></i> Sites Management</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showModal('siteModal')">
                        <i class="fas fa-plus"></i> Add Site
                    </button>
                </div>
            </div>

            <div class="sites-grid" id="sitesGrid">
                <!-- Sites will be populated here -->
            </div>

            <div class="card">
                <div class="card-header">Site Statistics</div>
                <div id="siteStatistics" style="padding: 15px;">
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--primary);" id="totalSites">0
                            </div>
                            <div>Total Sites</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--success);"
                                id="activeSiteCount">0</div>
                            <div>Active Sites</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: var(--info);"
                                id="totalAssignedWorkers">0</div>
                            <div>Assigned Workers</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Expenses/Income Section -->
        <section id="expenses" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-receipt"></i> Expense & Income Tracker</h2>
                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="showModal('expenseModal')">
                        <i class="fas fa-minus-circle"></i> Add Expense
                    </button>
                    <button class="btn btn-success" onclick="showModal('incomeModal')">
                        <i class="fas fa-plus-circle"></i> Add Income
                    </button>
                    <button class="btn btn-primary" onclick="exportTransactionsExcel()">
                        <i class="fas fa-file-excel"></i> Export
                    </button>
                </div>
            </div>

            <div class="attendance-controls">
                <div class="form-group" style="flex: 1; min-width: 150px;">
                    <select id="expenseTypeFilter" onchange="loadTransactions()">
                        <option value="all">All</option>
                        <option value="expense">Expenses</option>
                        <option value="income">Income</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1; min-width: 150px;">
                    <select id="expensePeriodFilter" onchange="loadTransactions()">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="fortnight">This Fortnight</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1; min-width: 150px;">
                    <select id="expenseSiteFilter" onchange="loadTransactions()">
                        <option value="all">All Sites</option>
                    </select>
                </div>
            </div>

            <div class="dashboard-grid">
                <div>
                    <div class="card">
                        <div class="card-header">Recent Transactions</div>
                        <div id="transactionsList">
                            <p>No transactions yet</p>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="card">
                        <div class="card-header">Summary</div>
                        <div style="padding: 15px;">
                            <div style="margin-bottom: 15px;">
                                <h4 style="color: var(--success);">Total Income</h4>
                                <div id="totalIncome" style="font-size: 1.5rem; font-weight: bold;">R0</div>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <h4 style="color: var(--danger);">Total Expenses</h4>
                                <div id="totalExpenses" style="font-size: 1.5rem; font-weight: bold;">R0</div>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <h4>Net Balance</h4>
                                <div id="netBalance" style="font-size: 1.5rem; font-weight: bold;">R0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Invoices Section -->
        <section id="invoices" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-file-invoice"></i> Invoice Generator</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="startNewInvoice()">
                        <i class="fas fa-plus"></i> New Invoice
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="form-row">
                    <div class="form-group">
                        <label for="invoiceTo">Client Name *</label>
                        <input type="text" id="invoiceTo" placeholder="Client Name">
                    </div>
                    <div class="form-group">
                        <label for="invoiceNumber">Invoice # *</label>
                        <input type="text" id="invoiceNumber" placeholder="INV-001">
                    </div>
                </div>

                <div class="form-group">
                    <label for="invoiceAddress">Client Address *</label>
                    <textarea id="invoiceAddress" rows="2" placeholder="Client address"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="invoiceDate">Date</label>
                        <input type="date" id="invoiceDate">
                    </div>
                    <div class="form-group">
                        <label for="invoiceDueDate">Due Date</label>
                        <input type="date" id="invoiceDueDate">
                    </div>
                </div>

                <div class="form-group">
                    <label>Items</label>
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <input type="text" id="itemDesc" placeholder="Description">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <input type="number" id="itemQty" placeholder="Qty" value="1" min="1">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <input type="number" id="itemRate" placeholder="Rate" step="0.01">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <button class="btn btn-success" onclick="addInvoiceItem()">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table id="invoiceItemsTable">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Qty</th>
                                <th>Rate</th>
                                <th>Amount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceItemsTableBody">
                            <!-- Items will be populated here -->
                        </tbody>
                    </table>
                </div>

                <button class="btn btn-primary" onclick="showInvoicePreview()" style="width: 100%; margin-top: 15px;">
                    <i class="fas fa-eye"></i> Preview Invoice
                </button>
            </div>

            <div class="card">
                <div class="card-header">Saved Invoices</div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTableBody">
                            <!-- Invoices will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <!-- ====================== -->
    <!-- MODALS -->
    <!-- ====================== -->

    <!-- Worker Modal -->
    <div id="workerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Add Worker</h3>
                <button class="close-modal" onclick="hideModal('workerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="workerName">First Name *</label>
                        <input type="text" id="workerName" required>
                    </div>
                    <div class="form-group">
                        <label for="workerSurname">Surname *</label>
                        <input type="text" id="workerSurname" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="workerId">ID Number *</label>
                        <input type="text" id="workerId" required>
                    </div>
                    <div class="form-group">
                        <label for="workerPhone">Phone *</label>
                        <input type="tel" id="workerPhone" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="workerRole">Role *</label>
                        <select id="workerRole" required>
                            <option value="">Select Role</option>
                            <option value="Bricklayer">Bricklayer</option>
                            <option value="Labourer">Labourer</option>
                            <option value="Plasterer">Plasterer</option>
                            <option value="Plaster Operator">Plaster Operator</option>
                            <option value="Plaster Labourer">Plaster Labourer</option>
                            <option value="Foreman">Foreman</option>
                            <option value="Transport">Transport</option>
                            <option value="Driver">Driver</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="Office Admin">Office Admin</option>
                            <option value="Technician">Technician</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="workerRate">Daily Rate (R) *</label>
                        <input type="number" id="workerRate" step="0.01" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="workerBank">Bank *</label>
                        <select id="workerBank" required>
                            <option value="">Select Bank</option>
                            <option value="FNB">FNB</option>
                            <option value="Standard Bank">Standard Bank</option>
                            <option value="Absa">Absa</option>
                            <option value="Nedbank">Nedbank</option>
                            <option value="Capitec">Capitec</option>
                            <option value="Tymebank">Tymebank</option>
                            <option value="Bank Zero">Bank Zero</option>
                            <option value="Discovery Bank">Discovery Bank</option>
                            <option value="African Bank">African Bank</option>
                            <option value="Investec">Investec</option>
                            <option value="Bidvest Bank">Bidvest Bank</option>
                            <option value="Sasfin Bank">Sasfin Bank</option>
                            <option value="Grindrod Bank">Grindrod Bank</option>
                            <option value="Access Bank">Access Bank</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="workerAccount">Account # *</label>
                        <input type="text" id="workerAccount" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="workerActive" checked> Active Worker
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('workerModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveWorker()">Save Worker</button>
            </div>
        </div>
    </div>

    <!-- Edit Worker Modal -->
    <div id="editWorkerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-edit"></i> Edit Worker</h3>
                <button class="close-modal" onclick="hideModal('editWorkerModal')">&times;</button>
            </div>
            <div class="modal-body" id="editWorkerModalBody">
                <!-- Populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('editWorkerModal')">Cancel</button>
                <button class="btn btn-success" onclick="updateWorker()">Update Worker</button>
            </div>
        </div>
    </div>

    <!-- Rates Modal -->
    <div id="ratesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cog"></i> Day Works Rates</h3>
                <button class="close-modal" onclick="hideModal('ratesModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="table-container">
                    <table class="rates-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Rate (R)</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="ratesBody">
                            <!-- Rates will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div class="last-updated" id="ratesUpdated" style="font-size: 0.9rem; margin-top: 10px; color: var(--dark);">
                    Rates last updated: Not yet saved
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('ratesModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveRateChanges()">Save Rate Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Loan Modal -->
    <div id="addLoanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-hand-holding-usd"></i> Add Loan/Credit</h3>
                <button class="close-modal" onclick="hideModal('addLoanModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="loanType">Type *</label>
                    <select id="loanType" onchange="toggleLoanFields()">
                        <option value="loan">Loan (They Owe Us)</option>
                        <option value="credit">Credit (We Owe Them)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="loanWorker">Worker *</label>
                    <select id="loanWorker" required>
                        <option value="">Select Worker</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="loanAmount">Amount (R) *</label>
                        <input type="number" id="loanAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="loanDate">Date *</label>
                        <input type="date" id="loanDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="loanDescription">Description *</label>
                    <input type="text" id="loanDescription" placeholder="e.g., Advance payment" required>
                </div>

                <div class="form-group" id="loanDeductField">
                    <label>
                        <input type="checkbox" id="loanDeduct" checked> Deduct from next payroll
                    </label>
                </div>

                <div class="form-group">
                    <label for="loanStatus">Status *</label>
                    <select id="loanStatus" required>
                        <option value="pending">Pending</option>
                        <option value="paid">Paid</option>
                        <option value="deducted">Deducted</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('addLoanModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveLoan()">Save</button>
            </div>
        </div>
    </div>

    <!-- Edit Loan Modal -->
    <div id="editLoanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Loan/Credit</h3>
                <button class="close-modal" onclick="hideModal('editLoanModal')">&times;</button>
            </div>
            <div class="modal-body" id="editLoanModalBody">
                <!-- Populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('editLoanModal')">Cancel</button>
                <button class="btn btn-success" onclick="updateLoan()">Update</button>
            </div>
        </div>
    </div>

    <!-- Site Modal -->
    <div id="siteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-map-marker-alt"></i> Add Site</h3>
                <button class="close-modal" onclick="hideModal('siteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="siteName">Site Name *</label>
                    <input type="text" id="siteName" placeholder="e.g., Paarl, Cape Town" required>
                </div>

                <div class="form-group">
                    <label for="siteAddress">Address</label>
                    <textarea id="siteAddress" rows="2" placeholder="Site address"></textarea>
                </div>

                <div class="form-group">
                    <label for="siteForeman">Assigned Foreman</label>
                    <select id="siteForeman">
                        <option value="">Select Foreman</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="siteActive" checked> Active Site
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('siteModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveSite()">Save Site</button>
            </div>
        </div>
    </div>

    <!-- Edit Site Modal -->
    <div id="editSiteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Site</h3>
                <button class="close-modal" onclick="hideModal('editSiteModal')">&times;</button>
            </div>
            <div class="modal-body" id="editSiteModalBody">
                <!-- Populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('editSiteModal')">Cancel</button>
                <button class="btn btn-success" onclick="updateSite()">Update Site</button>
            </div>
        </div>
    </div>

    <!-- Add Workers to Site Modal -->
    <div id="addWorkersToSiteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Add Workers to Site</h3>
                <button class="close-modal" onclick="hideModal('addWorkersToSiteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="addWorkersSiteSelect">Select Site *</label>
                    <select id="addWorkersSiteSelect" onchange="updateAvailableWorkersList()">
                        <option value="">Select Site</option>
                    </select>
                </div>

                <div class="search-box" style="margin-bottom: 15px;">
                    <i class="fas fa-search"></i>
                    <input type="text" id="workerSearchInput" placeholder="Search workers..."
                        onkeyup="filterWorkerSearch()">
                </div>

                <div class="form-group">
                    <label>Available Workers (Sorted by Role)</label>
                    <div id="availableWorkersList" style="max-height: 300px; overflow-y: auto;">
                        <p>Select a site first</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('addWorkersToSiteModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveWorkersToSite()">Add Selected</button>
            </div>
        </div>
    </div>

    <!-- Fortnight Modal -->
    <div id="fortnightModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-plus"></i> Create Fortnight</h3>
                <button class="close-modal" onclick="hideModal('fortnightModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="fortnightSiteSelect">Site *</label>
                    <select id="fortnightSiteSelect" required>
                        <option value="">Select Site</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="fortnightStartDate">Start Date *</label>
                    <input type="date" id="fortnightStartDate" required>
                </div>

                <div class="form-group">
                    <label for="fortnightEndDate">End Date</label>
                    <input type="date" id="fortnightEndDate" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('fortnightModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveFortnight()">Create Fortnight</button>
            </div>
        </div>
    </div>

    <!-- Manage Fortnights Modal -->
    <div id="manageFortnightsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-alt"></i> Manage Fortnights</h3>
                <button class="close-modal" onclick="hideModal('manageFortnightsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Site</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fortnightsList">
                            <!-- Fortnights will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('manageFortnightsModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Payroll History Modal -->
    <div id="payrollHistoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-history"></i> Payroll History</h3>
                <button class="close-modal" onclick="hideModal('payrollHistoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Site</th>
                                <th>Fortnight</th>
                                <th>Workers</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="payrollHistoryBody">
                            <!-- Payroll history will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('payrollHistoryModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-minus-circle"></i> Add Expense</h3>
                <button class="close-modal" onclick="hideModal('expenseModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="expenseSite">Site</label>
                    <select id="expenseSite">
                        <option value="">All Sites</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="expenseAmount">Amount (R) *</label>
                        <input type="number" id="expenseAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseDate">Date *</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="expenseCategory">Category *</label>
                    <select id="expenseCategory" required>
                        <option value="">Select Category</option>
                        <option value="petrol">Petrol</option>
                        <option value="equipment">Equipment</option>
                        <option value="vehicle">Vehicle Maintenance</option>
                        <option value="materials">Materials</option>
                        <option value="tools">Tools</option>
                        <option value="salaries">Salaries</option>
                        <option value="loan">Loans</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="expenseDescription">Description *</label>
                    <input type="text" id="expenseDescription" placeholder="e.g., Diesel for truck" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('expenseModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveExpense()">Save Expense</button>
            </div>
        </div>
    </div>

    <!-- Income Modal -->
    <div id="incomeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Add Income</h3>
                <button class="close-modal" onclick="hideModal('incomeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="incomeSite">Site</label>
                    <select id="incomeSite">
                        <option value="">All Sites</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="incomeAmount">Amount (R) *</label>
                        <input type="number" id="incomeAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="incomeDate">Date *</label>
                        <input type="date" id="incomeDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="incomeCategory">Category *</label>
                    <select id="incomeCategory" required>
                        <option value="">Select Category</option>
                        <option value="payment">Client Payment</option>
                        <option value="advance">Advance Payment</option>
                        <option value="loan_repayment">Loan Repayment</option>
                        <option value="refund">Refund</option>
                        <option value="bonus">Bonus</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="incomeDescription">Description *</label>
                    <input type="text" id="incomeDescription" placeholder="e.g., Payment from client" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('incomeModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveIncome()">Save Income</button>
            </div>
        </div>
    </div>

    <!-- Import Excel Modal -->
    <div id="importExcelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-import"></i> Import Data</h3>
                <button class="close-modal" onclick="hideModal('importExcelModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <i class="fas fa-info-circle"></i> Upload Excel file with appropriate columns
                </div>

                <div class="form-group">
                    <label for="importType">Import Type</label>
                    <select id="importType" onchange="updateImportInstructions()">
                        <option value="workers">Workers</option>
                        <option value="transactions">Expenses/Income</option>
                        <option value="loans">Loans/Credit</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="excelFile">Select File *</label>
                    <input type="file" id="excelFile" accept=".xlsx,.xls">
                </div>

                <div id="importInstructions">
                    <p><strong>Workers columns:</strong> Name, Surname, ID, Phone, Role, DailyRate, Bank, Account</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('importExcelModal')">Cancel</button>
                <button class="btn btn-success" onclick="importData()">Import</button>
            </div>
        </div>
    </div>

    <!-- Restore Backup Modal -->
    <div id="restoreModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-upload"></i> Restore Backup</h3>
                <button class="close-modal" onclick="hideModal('restoreModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-triangle"></i> This will replace all current data!
                </div>

                <div class="form-group">
                    <label for="backupFile">Select Backup File</label>
                    <input type="file" id="backupFile" accept=".json">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('restoreModal')">Cancel</button>
                <button class="btn btn-success" onclick="restoreBackup()">Restore</button>
            </div>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div id="invoicePreviewModal" class="modal invoice-preview-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice"></i> Invoice Preview</h3>
                <button class="close-modal" onclick="hideModal('invoicePreviewModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="invoice-preview-content" id="invoicePreviewContent">
                    <!-- Invoice preview will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('invoicePreviewModal')">Close</button>
                <button class="btn btn-primary" onclick="generateInvoicePDF()">
                    <i class="fas fa-file-pdf"></i> Download PDF
                </button>
                <button class="btn btn-success" onclick="saveInvoice()">
                    <i class="fas fa-save"></i> Save Invoice
                </button>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 3000; max-width: 400px;"></div>

    <script>
        // ======================
        // APPLICATION SETUP
        // ======================

        document.addEventListener('DOMContentLoaded', function () {
            initApp();
        });

        // Data structure
        let appData = {
            workers: [],
            sites: [],
            siteAssignments: [],
            fortnights: [],
            attendance: [],
            loans: [],
            expenses: [],
            payrolls: [],
            invoices: [],
            dayWorksData: [],
            dayWorksRates: {
                bricklayer: 63.99,
                bricklayerOvertime: 74.10,
                labour: 37.04,
                labourOvertime: 42.62,
                foremen: 87.08,
                foremenOvertime: 93.23,
                transport: 5.0,
                normalHours: 9.0
            },
            payments: []
        };

        // Current state
        let currentState = {
            editWorkerId: null,
            editSiteId: null,
            editLoanId: null,
            invoiceItems: [],
            attendanceChanged: false,
            filteredWorkers: [],
            currentDayWorksSite: null,
            currentDayWorksFortnight: null
        };

        // Day Works rate descriptions
        const rateDescriptions = {
            bricklayer: "Bricklayer hourly rate",
            bricklayerOvertime: "Bricklayer overtime hourly rate",
            labour: "Labourer hourly rate",
            labourOvertime: "Labourer overtime hourly rate",
            foremen: "Foreman hourly rate",
            foremenOvertime: "Foreman overtime hourly rate",
            transport: "Transport rate per km",
            normalHours: "Standard hours per day"
        };

        // Initialize app
        function initApp() {
            loadData();
            setupEventListeners();
            setDefaultDates();
            renderAll();
            updateFortnightSelectors();
            populateRatesTable();

            showNotification('Tonnylays Construction System Loaded', 'success');
        }

        // Load data from localStorage
        function loadData() {
            const savedData = localStorage.getItem('tonnylaysData');
            if (savedData) {
                try {
                    appData = JSON.parse(savedData);
                    // Ensure all arrays exist
                    appData.workers = appData.workers || [];
                    appData.sites = appData.sites || [];
                    appData.siteAssignments = appData.siteAssignments || [];
                    appData.fortnights = appData.fortnights || [];
                    appData.attendance = appData.attendance || [];
                    appData.loans = appData.loans || [];
                    appData.expenses = appData.expenses || [];
                    appData.payrolls = appData.payrolls || [];
                    appData.invoices = appData.invoices || [];
                    appData.dayWorksData = appData.dayWorksData || [];
                    appData.dayWorksRates = appData.dayWorksRates || {
                        bricklayer: 63.99,
                        bricklayerOvertime: 74.10,
                        labour: 37.04,
                        labourOvertime: 42.62,
                        foremen: 87.08,
                        foremenOvertime: 93.23,
                        transport: 5.0,
                        normalHours: 9.0
                    };
                    appData.payments = appData.payments || [];
                } catch (e) {
                    console.error('Error loading data:', e);
                    appData = {
                        workers: [], sites: [], siteAssignments: [], fortnights: [],
                        attendance: [], loans: [], expenses: [], payrolls: [], invoices: [],
                        dayWorksData: [], payments: [],
                        dayWorksRates: {
                            bricklayer: 63.99,
                            bricklayerOvertime: 74.10,
                            labour: 37.04,
                            labourOvertime: 42.62,
                            foremen: 87.08,
                            foremenOvertime: 93.23,
                            transport: 5.0,
                            normalHours: 9.0
                        }
                    };
                }
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('tonnylaysData', JSON.stringify(appData));
        }

        // Save all data (new function)
        function saveAllData() {
            saveData();
            showNotification('All data saved successfully', 'success');
        }

        // Refresh all data (new function)
        function refreshAllData() {
            loadData();
            renderAll();
            updateFortnightSelectors();
            populateRatesTable();
            
            // Refresh current view
            const activeSection = document.querySelector('.content-section.active');
            if (activeSection) {
                const sectionId = activeSection.id;
                if (sectionId === 'attendance') {
                    loadAttendanceGrid();
                } else if (sectionId === 'payroll') {
                    loadPayroll();
                } else if (sectionId === 'dayworks') {
                    loadDayWorksFromAttendance();
                } else if (sectionId === 'payroll-payments') {
                    loadPayrollPayments();
                } else if (sectionId === 'expenses') {
                    loadTransactions();
                }
            }
            
            showNotification('Data refreshed successfully', 'success');
        }

        // Set default dates
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];

            // Set invoice dates
            document.getElementById('invoiceDate').value = today;
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];

            // Set expense/income dates
            document.getElementById('expenseDate').value = today;
            document.getElementById('incomeDate').value = today;
            document.getElementById('loanDate').value = today;

            // Set fortnight start date
            document.getElementById('fortnightStartDate').value = today;
            updateFortnightEndDate();

            // Set combined payroll dates
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 13);
            document.getElementById('combinedStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('combinedEndDate').value = today;

            // Generate invoice number
            updateInvoiceNumber();
        }

        // Update fortnight end date
        function updateFortnightEndDate() {
            const startDate = document.getElementById('fortnightStartDate').value;
            if (startDate) {
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 13);
                document.getElementById('fortnightEndDate').value = endDate.toISOString().split('T')[0];
            }
        }

        // Update invoice number
        function updateInvoiceNumber() {
            const count = appData.invoices.length + 1;
            document.getElementById('invoiceNumber').value = `INV-${count.toString().padStart(3, '0')}`;
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('fortnightStartDate').addEventListener('change', updateFortnightEndDate);
        }

        // ======================
        // NAVIGATION
        // ======================

        // Toggle mobile menu
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileNavMenu');
            menu.classList.toggle('active');
        }

        // Switch tab (desktop)
        function switchTab(tabId) {
            // Update desktop tabs
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => btn.classList.remove('active'));

            // Activate selected tab
            const tabElement = document.querySelector(`.nav-tab[onclick="switchTab('${tabId}')"]`);
            if (tabElement) tabElement.classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // Update mobile menu
            const mobileItem = document.querySelector(`.mobile-nav-item[onclick="switchTab('${tabId}')"]`);
            if (mobileItem) mobileItem.classList.add('active');

            const mobileBtn = document.querySelector(`.mobile-nav-btn[onclick="switchMobileTab('${tabId}')"]`);
            if (mobileBtn) mobileBtn.classList.add('active');

            // Close mobile menu if open
            document.getElementById('mobileNavMenu').classList.remove('active');

            // Special handling for tabs
            if (tabId === 'attendance') {
                loadAttendanceGrid();
            } else if (tabId === 'payroll') {
                loadPayroll();
            } else if (tabId === 'dayworks') {
                loadDayWorksFromAttendance();
            } else if (tabId === 'payroll-payments') {
                loadPayrollPayments();
            } else if (tabId === 'loans') {
                renderLoans();
            } else if (tabId === 'expenses') {
                loadTransactions();
            } else if (tabId === 'invoices') {
                renderInvoices();
            }
        }

        // Switch mobile tab
        function switchMobileTab(tabId) {
            switchTab(tabId);
        }

        // Switch sub-tab
        function switchSubTab(section, subTab) {
            // Hide all sub-tabs in this section
            document.querySelectorAll(`#${section} .sub-tab-content`).forEach(tab => tab.style.display = 'none');
            document.querySelectorAll(`#${section} .sub-tab`).forEach(tab => tab.classList.remove('active'));

            // Show selected sub-tab
            const targetElement = document.getElementById(`${section}-${subTab}`);
            if (targetElement) {
                targetElement.style.display = 'block';
                targetElement.classList.add('active');
            }

            // Find and activate the clicked tab
            const clickedTab = event.target.closest('.sub-tab');
            if (clickedTab) {
                clickedTab.classList.add('active');
            }

            // Load data if needed
            if (section === 'loans') {
                renderLoans();
            } else if (section === 'payroll') {
                if (subTab === 'single') {
                    loadPayroll();
                } else if (subTab === 'combined') {
                    loadCombinedPayroll();
                }
            }
        }

        // Show modal
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            // Special handling for specific modals
            if (modalId === 'addLoanModal') {
                populateLoanWorkerDropdown();
            } else if (modalId === 'manageFortnightsModal') {
                loadFortnightsList();
            } else if (modalId === 'payrollHistoryModal') {
                renderPayrollHistory();
            } else if (modalId === 'ratesModal') {
                populateRatesTable();
            }
        }

        // Hide modal
        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ======================
        // NOTIFICATIONS
        // ======================

        // Show notification
        function showNotification(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();

            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.id = alertId;
            alert.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    <span>${message}</span>
                </div>
                <button class="close-alert" onclick="document.getElementById('${alertId}').remove()">&times;</button>
            `;

            container.appendChild(alert);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (document.getElementById(alertId)) {
                    document.getElementById(alertId).remove();
                }
            }, 3000);
        }

        // ======================
        // DASHBOARD
        // ======================

        // Render all components
        function renderAll() {
            renderDashboard();
            renderWorkers();
            renderSites();
            updateSiteFilters();
            renderLoans();
            loadTransactions();
            renderInvoices();
        }

        // Render dashboard with FIXED calculations
        function renderDashboard() {
            // Update statistics
            const totalWorkers = appData.workers.length;
            const activeWorkers = appData.workers.filter(w => w.active).length;
            const activeSites = appData.sites.filter(s => s.active).length;

            document.getElementById('totalWorkers').textContent = totalWorkers;
            document.getElementById('activeWorkers').textContent = activeWorkers;
            document.getElementById('activeSites').textContent = activeSites;

            // Calculate current payroll from attendance (FIXED)
            let currentPayroll = 0;
            const siteId = document.getElementById('dashboardSiteFilter').value;

            // Get all attendance records
            let attendanceRecords = appData.attendance.filter(record => record.status === 'P');

            // Filter by site if selected
            if (siteId && siteId !== 'all') {
                attendanceRecords = attendanceRecords.filter(record => record.siteId === siteId);
            }

            // Calculate payroll based on actual attendance
            attendanceRecords.forEach(record => {
                const worker = appData.workers.find(w => w.id === record.workerId);
                if (worker && worker.active) {
                    currentPayroll += worker.dailyRate;
                }
            });

            document.getElementById('currentPayroll').textContent = 'R' + currentPayroll.toLocaleString();

            // Calculate pending loans
            const pendingLoans = appData.loans
                .filter(l => l.type === 'loan' && l.status === 'pending')
                .reduce((sum, loan) => sum + loan.amount, 0);

            document.getElementById('pendingLoans').textContent = 'R' + pendingLoans.toLocaleString();

            // Update role payroll breakdown (ACTUAL, not estimated)
            updateRolePayrollBreakdown();

            // Update site filter
            updateDashboardSiteFilter();
        }

        // Update role payroll breakdown with ACTUAL attendance data
        function updateRolePayrollBreakdown() {
            const breakdownDiv = document.getElementById('rolePayrollBreakdown');
            const siteId = document.getElementById('dashboardSiteFilter').value;

            // Get workers based on filter
            let workers = appData.workers.filter(w => w.active);

            if (siteId && siteId !== 'all') {
                const assignedWorkerIds = appData.siteAssignments
                    .filter(a => a.siteId === siteId && !a.endDate)
                    .map(a => a.workerId);
                workers = workers.filter(w => assignedWorkerIds.includes(w.id));
            }

            // Group by role and calculate ACTUAL payroll from attendance
            const rolePayroll = {};

            workers.forEach(worker => {
                if (!rolePayroll[worker.role]) {
                    rolePayroll[worker.role] = {
                        count: 0,
                        payroll: 0,
                        workers: []
                    };
                }
                rolePayroll[worker.role].count++;
                rolePayroll[worker.role].workers.push(worker.id);
            });

            // Calculate actual payroll from attendance for each role
            let attendanceRecords = appData.attendance.filter(record => record.status === 'P');
            
            if (siteId && siteId !== 'all') {
                attendanceRecords = attendanceRecords.filter(record => record.siteId === siteId);
            }

            Object.keys(rolePayroll).forEach(role => {
                const roleWorkers = rolePayroll[role].workers;
                let roleTotal = 0;

                roleWorkers.forEach(workerId => {
                    const worker = appData.workers.find(w => w.id === workerId);
                    if (worker) {
                        // Count attendance days for this worker
                        const workerAttendanceDays = attendanceRecords.filter(
                            record => record.workerId === workerId
                        ).length;

                        roleTotal += workerAttendanceDays * worker.dailyRate;
                    }
                });

                rolePayroll[role].payroll = roleTotal;
            });

            // Create role cards
            let html = '';
            const sortedRoles = Object.keys(rolePayroll).sort();

            sortedRoles.forEach(role => {
                const data = rolePayroll[role];
                html += `
                    <div class="role-card">
                        <div class="role-title">${role}</div>
                        <div class="role-amount">R${data.payroll.toLocaleString()}</div>
                        <div class="role-count">${data.count} worker${data.count !== 1 ? 's' : ''}</div>
                    </div>
                `;
            });

            if (sortedRoles.length === 0) {
                html = '<div class="role-card"><div class="role-title">No Data</div><div class="role-amount">R0</div></div>';
            }

            breakdownDiv.innerHTML = html;
        }

        // Update dashboard when site filter changes
        function updateDashboard() {
            renderDashboard();
        }

        // Update dashboard site filter
        function updateDashboardSiteFilter() {
            const filter = document.getElementById('dashboardSiteFilter');
            const currentValue = filter.value;

            filter.innerHTML = '<option value="all">All Sites</option>';
            appData.sites
                .filter(s => s.active)
                .forEach(site => {
                    const option = document.createElement('option');
                    option.value = site.id;
                    option.textContent = site.name;
                    filter.appendChild(option);
                });

            if (currentValue) filter.value = currentValue;
        }

        // ======================
        // WORKER MANAGEMENT
        // ======================

        // Save new worker
        function saveWorker() {
            const name = document.getElementById('workerName').value.trim();
            const surname = document.getElementById('workerSurname').value.trim();
            const idNumber = document.getElementById('workerId').value.trim();
            const phone = document.getElementById('workerPhone').value.trim();
            const role = document.getElementById('workerRole').value;
            const dailyRate = parseFloat(document.getElementById('workerRate').value);
            const bank = document.getElementById('workerBank').value;
            const account = document.getElementById('workerAccount').value.trim();
            const active = document.getElementById('workerActive').checked;

            // Validate
            if (!name || !surname || !idNumber || !phone || !role || !dailyRate || !bank || !account) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (dailyRate <= 0) {
                showNotification('Daily rate must be higher than 0', 'error');
                return;
            }

            // Check for duplicate ID
            const duplicate = appData.workers.find(w => w.idNumber === idNumber);
            if (duplicate) {
                showNotification('Worker with this ID number already exists', 'error');
                return;
            }

            // Add worker
            const worker = {
                id: generateId(),
                name,
                surname,
                idNumber,
                phone,
                role,
                dailyRate,
                bank,
                account,
                active,
                createdAt: new Date().toISOString()
            };

            appData.workers.push(worker);
            saveData();
            renderWorkers();
            hideModal('workerModal');
            showNotification('Worker added successfully', 'success');
        }

        // Show edit worker modal
        function showEditWorkerModal(workerId) {
            const worker = appData.workers.find(w => w.id === workerId);
            if (!worker) return;

            currentState.editWorkerId = workerId;

            const modalBody = document.getElementById('editWorkerModalBody');
            modalBody.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input type="text" id="editWorkerName" value="${worker.name}" required>
                    </div>
                    <div class="form-group">
                        <label>Surname *</label>
                        <input type="text" id="editWorkerSurname" value="${worker.surname}" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ID Number *</label>
                        <input type="text" id="editWorkerId" value="${worker.idNumber}" required>
                    </div>
                    <div class="form-group">
                        <label>Phone *</label>
                        <input type="tel" id="editWorkerPhone" value="${worker.phone}" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Role *</label>
                        <select id="editWorkerRole" required>
                            <option value="">Select Role</option>
                            <option value="Bricklayer" ${worker.role === 'Bricklayer' ? 'selected' : ''}>Bricklayer</option>
                            <option value="Labourer" ${worker.role === 'Labourer' ? 'selected' : ''}>Labourer</option>
                            <option value="Plasterer" ${worker.role === 'Plasterer' ? 'selected' : ''}>Plasterer</option>
                            <option value="Plaster Operator" ${worker.role === 'Plaster Operator' ? 'selected' : ''}>Plaster Operator</option>
                            <option value="Plaster Labourer" ${worker.role === 'Plaster Labourer' ? 'selected' : ''}>Plaster Labourer</option>
                            <option value="Foreman" ${worker.role === 'Foreman' ? 'selected' : ''}>Foreman</option>
                            <option value="Transport" ${worker.role === 'Transport' ? 'selected' : ''}>Transport</option>
                            <option value="Driver" ${worker.role === 'Driver' ? 'selected' : ''}>Driver</option>
                            <option value="Supervisor" ${worker.role === 'Supervisor' ? 'selected' : ''}>Supervisor</option>
                            <option value="Office Admin" ${worker.role === 'Office Admin' ? 'selected' : ''}>Office Admin</option>
                            <option value="Technician" ${worker.role === 'Technician' ? 'selected' : ''}>Technician</option>
                            <option value="Electrician" ${worker.role === 'Electrician' ? 'selected' : ''}>Electrician</option>
                            <option value="Plumber" ${worker.role === 'Plumber' ? 'selected' : ''}>Plumber</option>
                            <option value="Carpenter" ${worker.role === 'Carpenter' ? 'selected' : ''}>Carpenter</option>
                            <option value="Painter" ${worker.role === 'Painter' ? 'selected' : ''}>Painter</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Daily Rate (R) *</label>
                        <input type="number" id="editWorkerRate" value="${worker.dailyRate}" step="0.01" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Bank *</label>
                        <select id="editWorkerBank" required>
                            <option value="">Select Bank</option>
                            <option value="FNB" ${worker.bank === 'FNB' ? 'selected' : ''}>FNB</option>
                            <option value="Standard Bank" ${worker.bank === 'Standard Bank' ? 'selected' : ''}>Standard Bank</option>
                            <option value="Absa" ${worker.bank === 'Absa' ? 'selected' : ''}>Absa</option>
                            <option value="Nedbank" ${worker.bank === 'Nedbank' ? 'selected' : ''}>Nedbank</option>
                            <option value="Capitec" ${worker.bank === 'Capitec' ? 'selected' : ''}>Capitec</option>
                            <option value="Tymebank" ${worker.bank === 'Tymebank' ? 'selected' : ''}>Tymebank</option>
                            <option value="Bank Zero" ${worker.bank === 'Bank Zero' ? 'selected' : ''}>Bank Zero</option>
                            <option value="Discovery Bank" ${worker.bank === 'Discovery Bank' ? 'selected' : ''}>Discovery Bank</option>
                            <option value="African Bank" ${worker.bank === 'African Bank' ? 'selected' : ''}>African Bank</option>
                            <option value="Investec" ${worker.bank === 'Investec' ? 'selected' : ''}>Investec</option>
                            <option value="Bidvest Bank" ${worker.bank === 'Bidvest Bank' ? 'selected' : ''}>Bidvest Bank</option>
                            <option value="Sasfin Bank" ${worker.bank === 'Sasfin Bank' ? 'selected' : ''}>Sasfin Bank</option>
                            <option value="Grindrod Bank" ${worker.bank === 'Grindrod Bank' ? 'selected' : ''}>Grindrod Bank</option>
                            <option value="Access Bank" ${worker.bank === 'Access Bank' ? 'selected' : ''}>Access Bank</option>
                            <option value="Mercantile Bank" ${worker.bank === 'Mercantile Bank' ? 'selected' : ''}>Mercantile Bank</option>
                            <option value="HBZ Bank" ${worker.bank === 'HBZ Bank' ? 'selected' : ''}>HBZ Bank</option>
                            <option value="Ubank" ${worker.bank === 'Ubank' ? 'selected' : ''}>Ubank</option>
                            <option value="Postbank" ${worker.bank === 'Postbank' ? 'selected' : ''}>Postbank</option>
                            <option value="Other" ${worker.bank === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Account # *</label>
                        <input type="text" id="editWorkerAccount" value="${worker.account}" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editWorkerActive" ${worker.active ? 'checked' : ''}> Active Worker
                    </label>
                </div>
            `;

            showModal('editWorkerModal');
        }

        // Update worker
        function updateWorker() {
            const worker = appData.workers.find(w => w.id === currentState.editWorkerId);
            if (!worker) return;

            worker.name = document.getElementById('editWorkerName').value.trim();
            worker.surname = document.getElementById('editWorkerSurname').value.trim();
            worker.idNumber = document.getElementById('editWorkerId').value.trim();
            worker.phone = document.getElementById('editWorkerPhone').value.trim();
            worker.role = document.getElementById('editWorkerRole').value;
            worker.dailyRate = parseFloat(document.getElementById('editWorkerRate').value);
            worker.bank = document.getElementById('editWorkerBank').value;
            worker.account = document.getElementById('editWorkerAccount').value.trim();
            worker.active = document.getElementById('editWorkerActive').checked;
            worker.updatedAt = new Date().toISOString();

            saveData();
            renderWorkers();
            hideModal('editWorkerModal');
            showNotification('Worker updated successfully', 'success');

            currentState.editWorkerId = null;
        }

        // Filter workers
        function filterWorkers() {
            const searchTerm = document.getElementById('workerSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#workersTableBody tr');

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const name = cells[0].textContent.toLowerCase();
                const surname = cells[1].textContent.toLowerCase();
                const idNumber = cells[2].textContent.toLowerCase();
                const role = cells[3].textContent.toLowerCase();
                
                if (name.includes(searchTerm) || surname.includes(searchTerm) || 
                    idNumber.includes(searchTerm) || role.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Render workers table (sorted by role, then first name)
        function renderWorkers() {
            const tbody = document.getElementById('workersTableBody');
            tbody.innerHTML = '';

            // Sort workers by role, then first name
            const sortedWorkers = [...appData.workers].sort((a, b) => {
                if (a.role !== b.role) return a.role.localeCompare(b.role);
                return a.name.localeCompare(b.name);
            });

            sortedWorkers.forEach(worker => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${worker.name}</td>
                    <td>${worker.surname}</td>
                    <td>${worker.idNumber}</td>
                    <td>${worker.role}</td>
                    <td>R${worker.dailyRate.toLocaleString()}</td>
                    <td>${worker.bank}</td>
                    <td>${worker.account}</td>
                    <td><span class="status-badge ${worker.active ? 'status-active' : 'status-inactive'}">${worker.active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="showEditWorkerModal('${worker.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteWorker('${worker.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Delete worker
        function deleteWorker(workerId) {
            if (!confirm('Are you sure you want to delete this worker?')) return;

            const worker = appData.workers.find(w => w.id === workerId);
            if (!worker) return;

            // Check if worker has records
            const hasLoans = appData.loans.some(l => l.workerId === workerId);
            const hasAttendance = appData.attendance.some(a => a.workerId === workerId);

            if (hasLoans || hasAttendance) {
                if (!confirm('Worker has records. Deactivate instead?')) return;
                worker.active = false;
                saveData();
                renderWorkers();
                showNotification('Worker deactivated', 'success');
                return;
            }

            // Remove worker
            appData.workers = appData.workers.filter(w => w.id !== workerId);

            // Remove site assignments
            appData.siteAssignments = appData.siteAssignments.filter(a => a.workerId !== workerId);

            saveData();
            renderWorkers();
            showNotification('Worker deleted successfully', 'success');
        }

        // Export workers to Excel
        function exportWorkersExcel() {
            const data = appData.workers.map(worker => [
                worker.name,
                worker.surname,
                worker.idNumber,
                worker.phone,
                worker.role,
                worker.dailyRate,
                worker.bank,
                worker.account,
                worker.active ? 'Active' : 'Inactive'
            ]);

            const ws = XLSX.utils.aoa_to_sheet([
                ['Name', 'Surname', 'ID Number', 'Phone', 'Role', 'Daily Rate', 'Bank', 'Account', 'Status'],
                ...data
            ]);

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Workers');
            XLSX.writeFile(wb, `Tonnylays_Workers_${new Date().toISOString().split('T')[0]}.xlsx`);

            showNotification('Workers exported successfully', 'success');
        }

        // ======================
        // SITE MANAGEMENT
        // ======================

        // Render sites with compact worker list
        function renderSites() {
            const grid = document.getElementById('sitesGrid');
            grid.innerHTML = '';

            appData.sites.forEach(site => {
                // Get assigned workers (sorted by role then name)
                const assignedWorkerIds = appData.siteAssignments
                    .filter(a => a.siteId === site.id && !a.endDate)
                    .map(a => a.workerId);

                const assignedWorkers = appData.workers
                    .filter(w => assignedWorkerIds.includes(w.id) && w.active)
                    .sort((a, b) => {
                        if (a.role !== b.role) return a.role.localeCompare(b.role);
                        return a.name.localeCompare(b.name);
                    });

                // Get foreman name
                const foreman = site.foreman ? appData.workers.find(w => w.id === site.foreman) : null;

                const siteCard = document.createElement('div');
                siteCard.className = 'site-card';
                siteCard.innerHTML = `
                    <div class="site-card-header">
                        <div class="site-name">${site.name}</div>
                        <div class="site-actions">
                            <button class="btn btn-sm btn-primary" onclick="showEditSiteModal('${site.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSite('${site.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    ${site.address ? `<div style="font-size: 0.9rem; color: var(--dark); margin-bottom: 8px;">${site.address}</div>` : ''}
                    
                    ${foreman ? `<div style="font-size: 0.9rem; margin-bottom: 8px;"><strong>Foreman:</strong> ${foreman.name} ${foreman.surname}</div>` : ''}
                    
                    <div style="font-size: 0.9rem; margin-bottom: 10px;">
                        <strong>Assigned Workers:</strong> ${assignedWorkers.length}
                    </div>
                    
                    ${assignedWorkers.length > 0 ? `
                        <div class="workers-list">
                            ${assignedWorkers.slice(0, 5).map(w => `
                                <div class="worker-list-item">
                                    <div>${w.name} ${w.surname}</div>
                                    <div style="font-size: 0.8rem; color: var(--dark);">${w.role}</div>
                                </div>
                            `).join('')}
                            ${assignedWorkers.length > 5 ? `
                                <div style="text-align: center; padding: 5px; color: var(--dark);">
                                    +${assignedWorkers.length - 5} more workers
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div style="text-align: center; padding: 15px; color: var(--dark);">
                            No workers assigned
                        </div>
                    `}
                    
                    <div style="margin-top: 15px; display: flex; gap: 5px;">
                        <button class="btn btn-sm btn-success" style="flex: 1;" onclick="assignWorkersToSite('${site.id}')">
                            <i class="fas fa-user-plus"></i> Add Workers
                        </button>
                    </div>
                `;

                grid.appendChild(siteCard);
            });

            // Update site statistics
            updateSiteStatistics();
        }

        // Show edit site modal
        function showEditSiteModal(siteId) {
            const site = appData.sites.find(s => s.id === siteId);
            if (!site) return;

            currentState.editSiteId = siteId;

            // Populate foreman dropdown (sorted by role)
            let foremanOptions = '<option value="">Select Foreman</option>';
            appData.workers
                .filter(w => w.role === 'Foreman' && w.active)
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(foreman => {
                    foremanOptions += `<option value="${foreman.id}" ${site.foreman === foreman.id ? 'selected' : ''}>${foreman.name} ${foreman.surname}</option>`;
                });

            const modalBody = document.getElementById('editSiteModalBody');
            modalBody.innerHTML = `
                <div class="form-group">
                    <label>Site Name *</label>
                    <input type="text" id="editSiteName" value="${site.name}" required>
                </div>
                
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="editSiteAddress" rows="2">${site.address || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label>Foreman</label>
                    <select id="editSiteForeman">
                        ${foremanOptions}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editSiteActive" ${site.active ? 'checked' : ''}> Active Site
                    </label>
                </div>
            `;

            showModal('editSiteModal');
        }

        // Save new site
        function saveSite() {
            const name = document.getElementById('siteName').value.trim();
            const address = document.getElementById('siteAddress').value.trim();
            const foreman = document.getElementById('siteForeman').value;
            const active = document.getElementById('siteActive').checked;

            if (!name) {
                showNotification('Site name is required', 'error');
                return;
            }

            const site = {
                id: generateId(),
                name,
                address,
                foreman: foreman || null,
                active,
                createdAt: new Date().toISOString()
            };

            appData.sites.push(site);
            saveData();
            renderSites();
            updateSiteFilters();
            hideModal('siteModal');
            showNotification('Site added successfully', 'success');
        }

        // Update site
        function updateSite() {
            const site = appData.sites.find(s => s.id === currentState.editSiteId);
            if (!site) return;

            site.name = document.getElementById('editSiteName').value.trim();
            site.address = document.getElementById('editSiteAddress').value.trim();
            site.foreman = document.getElementById('editSiteForeman').value || null;
            site.active = document.getElementById('editSiteActive').checked;
            site.updatedAt = new Date().toISOString();

            saveData();
            renderSites();
            updateSiteFilters();
            hideModal('editSiteModal');
            showNotification('Site updated successfully', 'success');

            currentState.editSiteId = null;
        }

        // Delete site
        function deleteSite(siteId) {
            if (!confirm('Are you sure? This will also remove all attendance and payroll data for this site.')) return;

            // Remove site
            appData.sites = appData.sites.filter(s => s.id !== siteId);

            // Remove related data
            appData.siteAssignments = appData.siteAssignments.filter(a => a.siteId !== siteId);
            appData.fortnights = appData.fortnights.filter(f => f.siteId !== siteId);
            appData.attendance = appData.attendance.filter(a => a.siteId !== siteId);

            saveData();
            renderSites();
            updateSiteFilters();
            showNotification('Site deleted successfully', 'success');
        }

        // Update site statistics
        function updateSiteStatistics() {
            document.getElementById('totalSites').textContent = appData.sites.length;
            document.getElementById('activeSiteCount').textContent = appData.sites.filter(s => s.active).length;

            const totalAssigned = appData.siteAssignments
                .filter(a => !a.endDate)
                .length;
            document.getElementById('totalAssignedWorkers').textContent = totalAssigned;
        }

        // Update site filters in dropdowns
        function updateSiteFilters() {
            const selectors = [
                'dashboardSiteFilter',
                'attendanceSite',
                'payrollSite',
                'dayWorksSite',
                'paymentsSite',
                'addWorkersSiteSelect',
                'fortnightSiteSelect',
                'expenseSiteFilter',
                'expenseSite',
                'incomeSite'
            ];

            selectors.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                if (select) {
                    const currentValue = select.value;
                    const isAllSites = selectorId.includes('Filter') || selectorId === 'expenseSite' || selectorId === 'incomeSite';

                    select.innerHTML = isAllSites ? '<option value="all">All Sites</option>' : '<option value="">Select Site</option>';

                    appData.sites
                        .filter(s => s.active)
                        .sort((a, b) => a.name.localeCompare(b.name))
                        .forEach(site => {
                            const option = document.createElement('option');
                            option.value = site.id;
                            option.textContent = site.name;
                            select.appendChild(option);
                        });

                    if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                        select.value = currentValue;
                    }
                }
            });
        }

        // ======================
        // ATTENDANCE MANAGEMENT
        // ======================

        // Load attendance grid with improved UI
        function loadAttendanceGrid() {
            const siteId = document.getElementById('attendanceSite').value;
            const fortnightId = document.getElementById('fortnightSelect').value;

            if (!siteId || !fortnightId) {
                clearAttendanceGrid();
                return;
            }

            const fortnight = appData.fortnights.find(f => f.id === fortnightId);
            if (!fortnight) return;

            // Generate dates
            const dates = [];
            const currentDate = new Date(fortnight.startDate);
            for (let i = 0; i < 14; i++) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Update header
            updateAttendanceHeader(dates);

            // Get assigned workers sorted by role then name (only workers assigned to this site)
            const assignedWorkerIds = appData.siteAssignments
                .filter(a => a.siteId === siteId && !a.endDate)
                .map(a => a.workerId);

            const assignedWorkers = appData.workers
                .filter(w => assignedWorkerIds.includes(w.id) && w.active)
                .sort((a, b) => {
                    if (a.role !== b.role) return a.role.localeCompare(b.role);
                    if (a.name !== b.name) return a.name.localeCompare(b.name);
                    return a.surname.localeCompare(b.surname);
                });

            // Store filtered workers for search
            currentState.filteredWorkers = assignedWorkers;

            // Populate attendance body
            updateAttendanceBody(assignedWorkers, siteId, fortnightId, dates);

            // Update summary with FIXED calculations
            updateAttendanceSummary(siteId, fortnightId, assignedWorkers, dates);

            // Show save button
            document.getElementById('saveAttendanceBtn').style.display = 'block';
        }

        // Clear attendance grid
        function clearAttendanceGrid() {
            document.getElementById('attendanceHeader').innerHTML = '<th class="worker-name-cell">Worker</th><th class="worker-action-cell">Actions</th>';
            document.getElementById('attendanceBody').innerHTML = '<tr><td colspan="16" style="text-align: center; padding: 20px;">Select site and fortnight</td></tr>';
            document.getElementById('attendanceSummary').innerHTML = '<p>Select site and fortnight to view summary</p>';
            document.getElementById('saveAttendanceBtn').style.display = 'none';
        }

        // Update attendance header
        function updateAttendanceHeader(dates) {
            const headerRow = document.getElementById('attendanceHeader');
            headerRow.innerHTML = '<th class="worker-name-cell">Worker</th><th class="worker-action-cell">Actions</th>';

            dates.forEach(dateStr => {
                const th = document.createElement('th');
                th.textContent = formatDateShort(dateStr);
                th.title = formatDate(dateStr);
                headerRow.appendChild(th);
            });
        }

        // Update attendance body with remove buttons
        function updateAttendanceBody(workers, siteId, fortnightId, dates) {
            const attendanceBody = document.getElementById('attendanceBody');
            attendanceBody.innerHTML = '';

            if (workers.length === 0) {
                attendanceBody.innerHTML = `
                    <tr>
                        <td colspan="16" style="text-align: center; padding: 20px;">
                            No workers assigned. Click "Add Workers" to assign workers to this site.
                        </td>
                    </tr>
                `;
                return;
            }

            workers.forEach(worker => {
                const row = document.createElement('tr');
                row.className = 'worker-row';

                // Worker name cell with role
                const nameCell = document.createElement('td');
                nameCell.className = 'worker-name-cell';
                nameCell.textContent = `${worker.name} ${worker.surname}`;
                nameCell.dataset.role = worker.role;
                row.appendChild(nameCell);

                // Action cell with remove button
                const actionCell = document.createElement('td');
                actionCell.className = 'worker-action-cell';
                actionCell.innerHTML = `
                    <button class="btn btn-sm btn-danger" onclick="removeWorkerFromAttendance('${worker.id}', '${siteId}')" title="Remove from attendance">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                row.appendChild(actionCell);

                // Attendance cells
                dates.forEach(dateStr => {
                    const cell = document.createElement('td');
                    cell.className = 'day-cell empty';
                    cell.dataset.workerId = worker.id;
                    cell.dataset.date = dateStr;
                    cell.dataset.siteId = siteId;
                    cell.onclick = () => toggleAttendance(cell);

                    // Get existing attendance
                    const existingAttendance = appData.attendance.find(a =>
                        a.workerId === worker.id &&
                        a.siteId === siteId &&
                        a.date === dateStr
                    );

                    if (existingAttendance) {
                        cell.textContent = existingAttendance.status;
                        cell.className = `day-cell ${existingAttendance.status === 'P' ? 'present' : 'absent'}`;
                    }

                    row.appendChild(cell);
                });

                attendanceBody.appendChild(row);
            });
        }

        // Remove worker from attendance (new function)
        function removeWorkerFromAttendance(workerId, siteId) {
            if (!confirm('Remove this worker from attendance? This will not delete the worker, just remove them from this site\'s attendance.')) return;

            // Remove site assignment
            const assignmentIndex = appData.siteAssignments.findIndex(a => 
                a.workerId === workerId && 
                a.siteId === siteId && 
                !a.endDate
            );

            if (assignmentIndex !== -1) {
                appData.siteAssignments[assignmentIndex].endDate = new Date().toISOString().split('T')[0];
            }

            // Remove attendance records for this worker at this site
            appData.attendance = appData.attendance.filter(a => 
                !(a.workerId === workerId && a.siteId === siteId)
            );

            saveData();
            loadAttendanceGrid();
            showNotification('Worker removed from attendance', 'success');
        }

        // Toggle attendance status
        function toggleAttendance(cell) {
            const workerId = cell.dataset.workerId;
            const date = cell.dataset.date;
            const siteId = cell.dataset.siteId;

            // Cycle status: empty ‚Üí P ‚Üí A ‚Üí empty
            const currentStatus = cell.textContent;
            let newStatus = '';
            let newClass = 'empty';

            if (currentStatus === '') {
                newStatus = 'P';
                newClass = 'present';
            } else if (currentStatus === 'P') {
                newStatus = 'A';
                newClass = 'absent';
            }

            cell.textContent = newStatus;
            cell.className = `day-cell ${newClass}`;

            // Update or create attendance record
            const existingIndex = appData.attendance.findIndex(a =>
                a.workerId === workerId &&
                a.siteId === siteId &&
                a.date === date
            );

            if (newStatus === '') {
                // Remove if clearing
                if (existingIndex !== -1) {
                    appData.attendance.splice(existingIndex, 1);
                }
            } else {
                const attendanceRecord = {
                    id: existingIndex !== -1 ? appData.attendance[existingIndex].id : generateId(),
                    workerId,
                    siteId,
                    date,
                    status: newStatus,
                    createdAt: new Date().toISOString()
                };

                if (existingIndex !== -1) {
                    appData.attendance[existingIndex] = attendanceRecord;
                } else {
                    appData.attendance.push(attendanceRecord);
                }
            }

            currentState.attendanceChanged = true;
            updateAttendanceSummaryFromUI();
        }

        // Filter attendance workers by search
        function filterAttendanceWorkers() {
            const searchTerm = document.getElementById('attendanceSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#attendanceBody tr');

            if (!searchTerm) {
                rows.forEach(row => row.style.display = '');
                return;
            }

            rows.forEach(row => {
                const nameCell = row.querySelector('.worker-name-cell');
                if (nameCell) {
                    const workerName = nameCell.textContent.toLowerCase();
                    const workerRole = nameCell.dataset.role.toLowerCase();
                    if (workerName.includes(searchTerm) || workerRole.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        }

        // Update attendance summary with FIXED calculations
        function updateAttendanceSummary(siteId, fortnightId, workers, dates) {
            const summaryDiv = document.getElementById('attendanceSummary');

            if (workers.length === 0) {
                summaryDiv.innerHTML = '<p>No workers assigned</p>';
                return;
            }

            let presentCount = 0;
            let absentCount = 0;
            let totalPayroll = 0;

            // Count attendance from data
            workers.forEach(worker => {
                dates.forEach(date => {
                    const attendance = appData.attendance.find(a =>
                        a.workerId === worker.id &&
                        a.siteId === siteId &&
                        a.date === date
                    );

                    if (attendance) {
                        if (attendance.status === 'P') {
                            presentCount++;
                            totalPayroll += worker.dailyRate;
                        } else if (attendance.status === 'A') {
                            absentCount++;
                        }
                    }
                });
            });

            const totalSlots = workers.length * dates.length;
            const notMarkedCount = totalSlots - presentCount - absentCount;

            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, #38a169, #2f855a); padding: 15px; border-radius: 12px; text-align: center; color: white; border: 3px solid white;">
                        <div style="font-size: 2rem; font-weight: bold;">${presentCount}</div>
                        <div>Present</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e53e3e, #c53030); padding: 15px; border-radius: 12px; text-align: center; color: white; border: 3px solid white;">
                        <div style="font-size: 2rem; font-weight: bold;">${absentCount}</div>
                        <div>Absent</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #d69e2e, #b7791f); padding: 15px; border-radius: 12px; text-align: center; color: white; border: 3px solid white;">
                        <div style="font-size: 2rem; font-weight: bold;">${notMarkedCount}</div>
                        <div>Not Marked</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4c8bf5, #2b6cb0); padding: 15px; border-radius: 12px; text-align: center; color: white; border: 3px solid white;">
                        <div style="font-size: 2rem; font-weight: bold;">R${totalPayroll.toLocaleString()}</div>
                        <div>Payroll Value</div>
                    </div>
                </div>
            `;

            summaryDiv.innerHTML = html;
        }

        // Update attendance summary from UI
        function updateAttendanceSummaryFromUI() {
            const siteId = document.getElementById('attendanceSite').value;
            const fortnightId = document.getElementById('fortnightSelect').value;

            if (!siteId || !fortnightId) return;

            const fortnight = appData.fortnights.find(f => f.id === fortnightId);
            if (!fortnight) return;

            // Generate dates
            const dates = [];
            const currentDate = new Date(fortnight.startDate);
            for (let i = 0; i < 14; i++) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Get assigned workers
            const assignedWorkerIds = appData.siteAssignments
                .filter(a => a.siteId === siteId && !a.endDate)
                .map(a => a.workerId);

            const assignedWorkers = appData.workers
                .filter(w => assignedWorkerIds.includes(w.id) && w.active);

            updateAttendanceSummary(siteId, fortnightId, assignedWorkers, dates);
        }

        // Save attendance
        function saveAttendance() {
            saveData();
            currentState.attendanceChanged = false;
            document.getElementById('saveAttendanceBtn').style.display = 'none';
            showNotification('Attendance saved successfully', 'success');
        }

        // Assign workers to site
        function assignWorkersToSite(siteId) {
            document.getElementById('addWorkersSiteSelect').value = siteId;
            updateAvailableWorkersList();
            showModal('addWorkersToSiteModal');
        }

        // Update available workers list with sorting and search
        function updateAvailableWorkersList() {
            const siteId = document.getElementById('addWorkersSiteSelect').value;
            const workersListDiv = document.getElementById('availableWorkersList');

            if (!siteId) {
                workersListDiv.innerHTML = '<p>Select a site first</p>';
                return;
            }

            // Get workers already assigned
            const assignedWorkerIds = appData.siteAssignments
                .filter(a => a.siteId === siteId && !a.endDate)
                .map(a => a.workerId);

            // Get available workers (active and not assigned) sorted by role then name
            const availableWorkers = appData.workers
                .filter(w => w.active && !assignedWorkerIds.includes(w.id))
                .sort((a, b) => {
                    if (a.role !== b.role) return a.role.localeCompare(b.role);
                    return a.name.localeCompare(b.name);
                });

            if (availableWorkers.length === 0) {
                workersListDiv.innerHTML = '<p>No available workers</p>';
                return;
            }

            let html = '';
            availableWorkers.forEach(worker => {
                html += `
                    <div class="worker-list-item" data-worker-id="${worker.id}" data-worker-name="${worker.name} ${worker.surname}" data-worker-role="${worker.role}">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; width: 100%;">
                            <input type="checkbox" class="worker-checkbox" value="${worker.id}">
                            <div style="flex: 1;">
                                <div style="font-weight: bold;">${worker.name} ${worker.surname}</div>
                                <div style="font-size: 0.85rem; color: var(--dark);">${worker.role} - R${worker.dailyRate}/day</div>
                            </div>
                        </label>
                    </div>
                `;
            });

            workersListDiv.innerHTML = html;
        }

        // Filter worker search
        function filterWorkerSearch() {
            const searchTerm = document.getElementById('workerSearchInput').value.toLowerCase();
            const workerItems = document.querySelectorAll('#availableWorkersList .worker-list-item');

            workerItems.forEach(item => {
                const workerName = item.dataset.workerName.toLowerCase();
                const workerRole = item.dataset.workerRole.toLowerCase();
                if (workerName.includes(searchTerm) || workerRole.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Save workers to site
        function saveWorkersToSite() {
            const siteId = document.getElementById('addWorkersSiteSelect').value;

            if (!siteId) {
                showNotification('Please select a site', 'error');
                return;
            }

            const checkboxes = document.querySelectorAll('.worker-checkbox:checked');

            if (checkboxes.length === 0) {
                showNotification('Please select at least one worker', 'error');
                return;
            }

            let addedCount = 0;
            checkboxes.forEach(checkbox => {
                const workerId = checkbox.value;

                // Check if already assigned
                const existing = appData.siteAssignments.find(a =>
                    a.workerId === workerId &&
                    a.siteId === siteId &&
                    !a.endDate
                );

                if (!existing) {
                    const assignment = {
                        id: generateId(),
                        workerId,
                        siteId,
                        startDate: new Date().toISOString().split('T')[0],
                        endDate: null,
                        createdAt: new Date().toISOString()
                    };

                    appData.siteAssignments.push(assignment);
                    addedCount++;
                }
            });

            saveData();
            renderSites();

            // Update attendance grid if viewing this site
            const currentSite = document.getElementById('attendanceSite').value;
            if (currentSite === siteId) {
                loadAttendanceGrid();
            }

            hideModal('addWorkersToSiteModal');
            showNotification(`Added ${addedCount} workers to site`, 'success');
        }

        // Export attendance PDF
        function exportAttendancePDF() {
            const siteId = document.getElementById('attendanceSite').value;
            const fortnightId = document.getElementById('fortnightSelect').value;

            if (!siteId || !fortnightId) {
                showNotification('Please select site and fortnight', 'error');
                return;
            }

            showNotification('Exporting to PDF...', 'success');
            // PDF export implementation would go here
        }

        // Export attendance Excel
        function exportAttendanceExcel() {
            const siteId = document.getElementById('attendanceSite').value;
            const fortnightId = document.getElementById('fortnightSelect').value;

            if (!siteId || !fortnightId) {
                showNotification('Please select site and fortnight', 'error');
                return;
            }

            const site = appData.sites.find(s => s.id === siteId);
            const fortnight = appData.fortnights.find(f => f.id === fortnightId);

            if (!site || !fortnight) return;

            // Get data
            const assignedWorkerIds = appData.siteAssignments
                .filter(a => a.siteId === siteId && !a.endDate)
                .map(a => a.workerId);

            const workers = appData.workers
                .filter(w => assignedWorkerIds.includes(w.id) && w.active)
                .sort((a, b) => {
                    if (a.role !== b.role) return a.role.localeCompare(b.role);
                    return a.name.localeCompare(b.name);
                });

            const dates = [];
            const currentDate = new Date(fortnight.startDate);
            for (let i = 0; i < 14; i++) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Create worksheet
            const wsData = [
                ['TONNILAYS - ATTENDANCE REGISTER'],
                [`Site: ${site.name}`],
                [`Period: ${formatDate(fortnight.startDate)} - ${formatDate(fortnight.endDate)}`],
                [`Date: ${new Date().toLocaleDateString()}`],
                [],
                ['Worker', 'Role', ...dates.map(d => formatDateShort(d))]
            ];

            workers.forEach(worker => {
                const row = [`${worker.name} ${worker.surname}`, worker.role];

                dates.forEach(date => {
                    const attendance = appData.attendance.find(a =>
                        a.workerId === worker.id &&
                        a.siteId === siteId &&
                        a.date === date
                    );
                    row.push(attendance ? attendance.status : '');
                });

                wsData.push(row);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Attendance');

            XLSX.writeFile(wb, `Attendance_${site.name}_${fortnight.startDate}.xlsx`);
            showNotification('Attendance exported to Excel', 'success');
        }

        // ======================
        // DAY WORKS MANAGEMENT
        // ======================

        // Populate rates table
        function populateRatesTable() {
            const ratesBody = document.getElementById('ratesBody');
            ratesBody.innerHTML = '';

            // Create rate rows
            const rateKeys = [
                'bricklayer', 'bricklayerOvertime', 
                'labour', 'labourOvertime', 
                'foremen', 'foremenOvertime', 
                'transport', 'normalHours'
            ];

            rateKeys.forEach((key) => {
                const row = ratesBody.insertRow();
                const displayName = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                
                row.innerHTML = `
                    <td>${displayName}</td>
                    <td><input type="number" class="editable-rate rate-input" id="rate-${key}" value="${appData.dayWorksRates[key]}" data-key="${key}" step="0.01" min="0"></td>
                    <td>${rateDescriptions[key] || ''}</td>
                `;
                
                // Add event listener to rate input
                const rateInput = document.getElementById(`rate-${key}`);
                rateInput.addEventListener('change', handleRateChange);
            });
        }

        // Handle rate changes
        function handleRateChange(event) {
            const input = event.target;
            const key = input.getAttribute('data-key');
            const value = parseFloat(input.value) || 0;
            
            // Update the rates object
            appData.dayWorksRates[key] = value;
            
            // Show warning that changes need to be saved
            document.getElementById('ratesUpdated').innerHTML = 
                '<span style="color: #e74c3c;">Rates edited - click "Save Rate Changes" to apply to all calculations</span>';
        }

        // Save rate changes
        function saveRateChanges() {
            saveData();
            
            // Update the last saved timestamp
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('ratesUpdated').innerHTML = 
                `Rates last updated: ${timeString} - All calculations updated`;
            
            // Recalculate day works if loaded
            if (currentState.currentDayWorksSite && currentState.currentDayWorksFortnight) {
                loadDayWorksFromAttendance();
            }
            
            showNotification('Rates saved successfully', 'success');
        }

        // Load day works from attendance data
        function loadDayWorksFromAttendance() {
            const siteId = document.getElementById('dayWorksSite').value;
            const fortnightId = document.getElementById('dayWorksFortnight').value;

            if (!siteId || !fortnightId) {
                clearDayWorksTable();
                return;
            }

            const site = appData.sites.find(s => s.id === siteId);
            const fortnight = appData.fortnights.find(f => f.id === fortnightId);

            if (!site || !fortnight) {
                clearDayWorksTable();
                return;
            }

            currentState.currentDayWorksSite = siteId;
            currentState.currentDayWorksFortnight = fortnightId;

            // Generate dates for the fortnight
            const dates = [];
            const currentDate = new Date(fortnight.startDate);
            for (let i = 0; i < 14; i++) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Get attendance data for this site and fortnight
            const attendanceRecords = appData.attendance.filter(a => 
                a.siteId === siteId && 
                dates.includes(a.date) && 
                a.status === 'P'
            );

            // Group by date and role
            const dayWorksByDate = {};

            dates.forEach(date => {
                dayWorksByDate[date] = {
                    bricklayer: 0,
                    labourers: 0,
                    foreman: 0,
                    transport: 0,
                    hours: appData.dayWorksRates.normalHours,
                    overtime: 0
                };
            });

            // Calculate counts by role for each day
            attendanceRecords.forEach(record => {
                const worker = appData.workers.find(w => w.id === record.workerId);
                if (!worker) return;

                const date = record.date;
                if (!dayWorksByDate[date]) return;

                // Determine overtime based on day of week
                const dayOfWeek = new Date(date).getDay();
                let overtime = 0;
                let hours = appData.dayWorksRates.normalHours;

                if (dayOfWeek === 5) { // Friday
                    hours = 6;
                    overtime = 3.5;
                } else if (dayOfWeek === 0 || dayOfWeek === 6) { // Weekend
                    hours = 0;
                    overtime = appData.dayWorksRates.normalHours;
                }

                // Add to appropriate role
                if (worker.role === 'Bricklayer') {
                    dayWorksByDate[date].bricklayer++;
                } else if (worker.role === 'Labourer') {
                    dayWorksByDate[date].labourers++;
                } else if (worker.role === 'Foreman') {
                    dayWorksByDate[date].foreman++;
                } else if (worker.role === 'Transport' || worker.role === 'Driver') {
                    dayWorksByDate[date].transport++;
                }

                // Set hours and overtime
                dayWorksByDate[date].hours = hours;
                dayWorksByDate[date].overtime = overtime;
            });

            // Convert to array and sort by date
            const dayWorksData = Object.keys(dayWorksByDate)
                .sort((a, b) => new Date(a) - new Date(b))
                .map(date => ({
                    date: date,
                    ...dayWorksByDate[date]
                }));

            // Update table
            updateDayWorksTable(dayWorksData);
        }

        // Clear day works table
        function clearDayWorksTable() {
            const tbody = document.getElementById('dayWorksBody');
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Select site and fortnight</td></tr>';
            updateDayWorksTotals();
        }

        // Update day works table
        function updateDayWorksTable(data) {
            const tbody = document.getElementById('dayWorksBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">No day works data for selected period</td></tr>';
                updateDayWorksTotals();
                return;
            }

            data.forEach((rowData, index) => {
                const row = tbody.insertRow();
                const dayOfWeek = getDayOfWeek(rowData.date);
                
                // Calculate total for this row
                const calculation = calculateDayWorksRowTotal(rowData);
                
                row.innerHTML = `
                    <td>
                        <input type="text" class="editable date-input" value="${formatDateShort(rowData.date)}" data-index="${index}" data-field="date">
                    </td>
                    <td><span class="day-of-week">${dayOfWeek}</span></td>
                    <td><input type="number" class="editable bricklayer-input" value="${rowData.bricklayer}" data-index="${index}" data-field="bricklayer" min="0" step="1"></td>
                    <td><input type="number" class="editable labourers-input" value="${rowData.labourers}" data-index="${index}" data-field="labourers" min="0" step="1"></td>
                    <td><input type="number" class="editable foreman-input" value="${rowData.foreman}" data-index="${index}" data-field="foreman" min="0" step="1"></td>
                    <td><input type="number" class="editable transport-input" value="${rowData.transport}" data-index="${index}" data-field="transport" min="0" step="1"></td>
                    <td><input type="number" class="editable hours-input" value="${rowData.hours}" data-index="${index}" data-field="hours" min="0" step="0.5"></td>
                    <td><input type="number" class="editable overtime-input" value="${rowData.overtime}" data-index="${index}" data-field="overtime" min="0" step="0.5"></td>
                    <td class="total-cell" id="dayworks-total-${index}">${formatCurrency(calculation.total)}</td>
                `;
                
                // Add event listeners to the inputs for real-time calculation
                const inputs = row.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('input', handleDayWorksInputChange);
                    input.addEventListener('change', handleDayWorksInputChange);
                });
            });

            // Store the data
            appData.dayWorksData = data;
            updateDayWorksTotals();
        }

        // Calculate day works row total
        function calculateDayWorksRowTotal(rowData) {
            // Get values from the row, default to 0 if empty
            const bricklayer = parseFloat(rowData.bricklayer) || 0;
            const labourers = parseFloat(rowData.labourers) || 0;
            const foreman = parseFloat(rowData.foreman) || 0;
            const transport = parseFloat(rowData.transport) || 0;
            const hours = parseFloat(rowData.hours) || 0;
            const overtime = parseFloat(rowData.overtime) || 0;
            
            // Calculate normal hours (total hours minus overtime)
            const normalHours = Math.max(0, hours - overtime);
            
            // Calculate costs using current rates
            const bricklayerCost = (bricklayer * normalHours * appData.dayWorksRates.bricklayer) + 
                                  (bricklayer * overtime * appData.dayWorksRates.bricklayerOvertime);
            
            const labourersCost = (labourers * normalHours * appData.dayWorksRates.labour) + 
                                 (labourers * overtime * appData.dayWorksRates.labourOvertime);
            
            const foremanCost = (foreman * normalHours * appData.dayWorksRates.foremen) + 
                               (foreman * overtime * appData.dayWorksRates.foremenOvertime);
            
            const transportCost = transport * appData.dayWorksRates.transport;
            
            // Total cost
            const total = bricklayerCost + labourersCost + foremanCost + transportCost;
            
            return {
                total: Math.round(total * 100) / 100,
                breakdown: {
                    bricklayerCost: Math.round(bricklayerCost * 100) / 100,
                    labourersCost: Math.round(labourersCost * 100) / 100,
                    foremanCost: Math.round(foremanCost * 100) / 100,
                    transportCost: Math.round(transportCost * 100) / 100,
                    normalHours: normalHours,
                    overtimeHours: overtime
                }
            };
        }

        // Handle day works input changes
        function handleDayWorksInputChange(event) {
            const input = event.target;
            const index = input.getAttribute('data-index');
            const field = input.getAttribute('data-field');
            const value = input.value;
            
            // Update the data array
            appData.dayWorksData[index][field] = field === 'date' ? value : parseFloat(value) || 0;
            
            // Recalculate and update the total for this row
            updateDayWorksRowTotal(index);
            
            // Update totals
            updateDayWorksTotals();
        }

        // Update day works row total
        function updateDayWorksRowTotal(index) {
            if (!appData.dayWorksData[index]) return;
            
            const calculation = calculateDayWorksRowTotal(appData.dayWorksData[index]);
            const totalCell = document.getElementById(`dayworks-total-${index}`);
            if (totalCell) {
                totalCell.textContent = formatCurrency(calculation.total);
            }
        }

        // Update day works totals
        function updateDayWorksTotals() {
            let totalBricklayer = 0;
            let totalLabourers = 0;
            let totalForeman = 0;
            let totalTransport = 0;
            let totalHours = 0;
            let totalOvertime = 0;
            let grandTotal = 0;
            
            appData.dayWorksData.forEach((data, index) => {
                const bricklayer = parseFloat(data.bricklayer) || 0;
                const labourers = parseFloat(data.labourers) || 0;
                const foreman = parseFloat(data.foreman) || 0;
                const transport = parseFloat(data.transport) || 0;
                const hours = parseFloat(data.hours) || 0;
                const overtime = parseFloat(data.overtime) || 0;
                
                totalBricklayer += bricklayer;
                totalLabourers += labourers;
                totalForeman += foreman;
                totalTransport += transport;
                totalHours += hours;
                totalOvertime += overtime;
                
                const calculation = calculateDayWorksRowTotal(data);
                grandTotal += calculation.total;
            });
            
            // Update totals row
            document.getElementById('total-bricklayer').textContent = totalBricklayer;
            document.getElementById('total-labourers').textContent = totalLabourers;
            document.getElementById('total-foreman').textContent = totalForeman;
            document.getElementById('total-transport').textContent = totalTransport;
            document.getElementById('total-hours').textContent = totalHours;
            document.getElementById('total-overtime').textContent = totalOvertime;
            document.getElementById('grand-total').textContent = formatCurrency(grandTotal);
        }

        // Calculate all day works totals
        function calculateAllDayWorksTotals() {
            for (let i = 0; i < appData.dayWorksData.length; i++) {
                updateDayWorksRowTotal(i);
            }
            updateDayWorksTotals();
            showNotification('All day works totals calculated', 'success');
        }

        // Get day of week
        function getDayOfWeek(dateStr) {
            const date = new Date(dateStr);
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return days[date.getDay()];
        }

        // Format currency
        function formatCurrency(value) {
            return 'R' + value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        // Export day works client report
        function exportDayWorksClientReport() {
            const siteId = document.getElementById('dayWorksSite').value;
            const fortnightId = document.getElementById('dayWorksFortnight').value;

            if (!siteId || !fortnightId) {
                showNotification('Please select site and fortnight', 'error');
                return;
            }

            const site = appData.sites.find(s => s.id === siteId);
            const fortnight = appData.fortnights.find(f => f.id === fortnightId);

            if (!site || !fortnight) return;

            // Create client report table
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.fontFamily = 'Arial, sans-serif';
            table.style.fontSize = '14px';
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const headers = ['Date', 'Day', 'Bricklayer', 'Labourers', 'Foreman', 'Transport'];
            
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                th.style.backgroundColor = '#3498db';
                th.style.color = 'white';
                th.style.padding = '10px';
                th.style.textAlign = 'left';
                th.style.border = '1px solid #ddd';
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            
            appData.dayWorksData.forEach(data => {
                if (data.bricklayer > 0 || data.labourers > 0 || data.foreman > 0) {
                    const row = document.createElement('tr');
                    const cells = [
                        formatDateShort(data.date),
                        getDayOfWeek(data.date),
                        data.bricklayer,
                        data.labourers,
                        data.foreman,
                        data.transport
                    ];
                    
                    cells.forEach((cellText, index) => {
                        const td = document.createElement('td');
                        td.textContent = cellText;
                        td.style.padding = '8px';
                        td.style.border = '1px solid #ddd';
                        if (index % 2 === 0) {
                            td.style.backgroundColor = '#f9f9f9';
                        }
                        row.appendChild(td);
                    });
                    
                    tbody.appendChild(row);
                }
            });
            
            table.appendChild(tbody);
            
            // Add title
            const container = document.createElement('div');
            const title = document.createElement('h2');
            title.textContent = 'Day Works Report - Client View';
            title.style.textAlign = 'center';
            title.style.color = '#2c3e50';
            title.style.marginBottom = '15px';
            
            const dateStamp = document.createElement('div');
            dateStamp.textContent = 'Generated: ' + new Date().toLocaleDateString();
            dateStamp.style.textAlign = 'center';
            dateStamp.style.color = '#7f8c8d';
            dateStamp.style.marginBottom = '20px';
            dateStamp.style.fontSize = '12px';
            
            container.appendChild(title);
            container.appendChild(dateStamp);
            container.appendChild(table);
            
            document.body.appendChild(container);
            
            html2canvas(container, {
                scale: 2,
                backgroundColor: '#ffffff',
                logging: false
            }).then(canvas => {
                document.body.removeChild(container);
                
                const link = document.createElement('a');
                link.download = 'DayWorks_Client_Report_' + new Date().toISOString().slice(0,10) + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
            
            showNotification('Client report exported', 'success');
        }

        // Export day works full report
        function exportDayWorksFullReport() {
            const siteId = document.getElementById('dayWorksSite').value;
            const fortnightId = document.getElementById('dayWorksFortnight').value;

            if (!siteId || !fortnightId) {
                showNotification('Please select site and fortnight', 'error');
                return;
            }

            const site = appData.sites.find(s => s.id === siteId);
            const fortnight = appData.fortnights.find(f => f.id === fortnightId);

            if (!site || !fortnight) return;

            const originalTable = document.getElementById('dayWorksTable');
            const clonedTable = originalTable.cloneNode(true);
            
            // Remove input elements and show values
            clonedTable.querySelectorAll('input').forEach(input => {
                const td = input.parentElement;
                td.textContent = input.value;
                td.style.padding = '6px 8px';
            });
            
            // Create container
            const container = document.createElement('div');
            const title = document.createElement('h2');
            title.textContent = 'Day Works Report - Full Details';
            title.style.textAlign = 'center';
            title.style.color = '#2c3e50';
            title.style.marginBottom = '15px';
            
            const dateStamp = document.createElement('div');
            dateStamp.textContent = 'Generated: ' + new Date().toLocaleDateString();
            dateStamp.style.textAlign = 'center';
            dateStamp.style.color = '#7f8c8d';
            dateStamp.style.marginBottom = '20px';
            dateStamp.style.fontSize = '12px';
            
            container.appendChild(title);
            container.appendChild(dateStamp);
            container.appendChild(clonedTable);
            
            document.body.appendChild(container);
            
            html2canvas(container, {
                scale: 2,
                backgroundColor: '#ffffff',
                logging: false
            }).then(canvas => {
                document.body.removeChild(container);
                
                const link = document.createElement('a');
                link.download = 'DayWorks_Full_Report_' + new Date().toISOString().slice(0,10) + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
            
            showNotification('Full report exported', 'success');
        }

        // ======================
        // FORTNIGHT MANAGEMENT
        // ======================

        // Save fortnight
        function saveFortnight() {
            const siteId = document.getElementById('fortnightSiteSelect').value;
            const startDate = document.getElementById('fortnightStartDate').value;
            const endDate = document.getElementById('fortnightEndDate').value;

            if (!siteId || !startDate) {
                showNotification('Please select site and start date', 'error');
                return;
            }

            // Check for overlapping fortnights
            const overlapping = appData.fortnights.find(f =>
                f.siteId === siteId &&
                ((new Date(startDate) >= new Date(f.startDate) && new Date(startDate) <= new Date(f.endDate)) ||
                    (new Date(endDate) >= new Date(f.startDate) && new Date(endDate) <= new Date(f.endDate)))
            );

            if (overlapping) {
                showNotification('Fortnight overlaps with existing fortnight', 'error');
                return;
            }

            const fortnight = {
                id: generateId(),
                siteId,
                startDate,
                endDate,
                createdAt: new Date().toISOString()
            };

            appData.fortnights.push(fortnight);
            saveData();

            // Update dropdowns IMMEDIATELY
            updateFortnightSelectors();
            hideModal('fortnightModal');
            showNotification('Fortnight created successfully', 'success');

            // Auto-select the new fortnight
            document.getElementById('attendanceSite').value = siteId;
            document.getElementById('fortnightSelect').value = fortnight.id;

            // Load attendance grid
            setTimeout(() => {
                loadAttendanceGrid();
                switchTab('attendance');
            }, 100);
        }

        // Update fortnight selectors
        function updateFortnightSelectors() {
            // Attendance fortnight selector
            const fortnightSelect = document.getElementById('fortnightSelect');
            const dayWorksFortnight = document.getElementById('dayWorksFortnight');
            const payrollFortnight = document.getElementById('payrollFortnight');
            const paymentsFortnight = document.getElementById('paymentsFortnight');

            const selectors = [fortnightSelect, dayWorksFortnight, payrollFortnight, paymentsFortnight];

            selectors.forEach(select => {
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Select Fortnight</option>';

                    // Sort fortnights by start date (newest first)
                    appData.fortnights
                        .sort((a, b) => new Date(b.startDate) - new Date(a.startDate))
                        .forEach(fortnight => {
                            const site = appData.sites.find(s => s.id === fortnight.siteId);
                            if (!site) return;

                            const option = document.createElement('option');
                            option.value = fortnight.id;
                            option.textContent = `${site.name} - ${formatDate(fortnight.startDate)} to ${formatDate(fortnight.endDate)}`;
                            select.appendChild(option);
                        });

                    if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                        select.value = currentValue;
                    }
                }
            });
        }

        // Load fortnights list for management
        function loadFortnightsList() {
            const tbody = document.getElementById('fortnightsList');
            tbody.innerHTML = '';

            appData.fortnights
                .sort((a, b) => new Date(b.startDate) - new Date(a.startDate))
                .forEach(fortnight => {
                    const site = appData.sites.find(s => s.id === fortnight.siteId);
                    if (!site) return;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${site.name}</td>
                        <td>${formatDate(fortnight.startDate)}</td>
                        <td>${formatDate(fortnight.endDate)}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteFortnight('${fortnight.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
        }

        // Delete fortnight
        function deleteFortnight(fortnightId) {
            if (!confirm('Delete this fortnight? All attendance data for this period will be lost.')) return;

            appData.fortnights = appData.fortnights.filter(f => f.id !== fortnightId);
            appData.attendance = appData.attendance.filter(a => a.fortnightId !== fortnightId);

            saveData();
            updateFortnightSelectors();
            loadFortnightsList();
            showNotification('Fortnight deleted', 'success');
        }

        // ======================
        // PAYROLL CALCULATION
        // ======================

        // Load payroll
        function loadPayroll() {
            document.getElementById('payrollTableBody').innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 20px;">
                        Select site and fortnight, then click Calculate
                    </td>
                </tr>
            `;

            updatePayrollTotals(0, 0, 0, 0);
        }

        // Calculate payroll
        function calculatePayroll() {
            const siteId = document.getElementById('payrollSite').value;
            const fortnightId = document.getElementById('payrollFortnight').value;

            if (!siteId || !fortnightId) {
                showNotification('Please select site and fortnight', 'error');
                return;
            }

            const site = appData.sites.find(s => s.id === siteId);
            const fortnight = appData.fortnights.find(f => f.id === fortnightId);

            if (!site || !fortnight) {
                showNotification('Invalid site or fortnight', 'error');
                return;
            }

            // Get assigned workers
            const assignedWorkerIds = appData.siteAssignments
                .filter(a => a.siteId === siteId && !a.endDate)
                .map(a => a.workerId);

            const assignedWorkers = appData.workers
                .filter(w => assignedWorkerIds.includes(w.id) && w.active)
                .sort((a, b) => {
                    if (a.role !== b.role) return a.role.localeCompare(b.role);
                    return a.name.localeCompare(b.name);
                });

            // Generate dates
            const dates = [];
            const currentDate = new Date(fortnight.startDate);
            for (let i = 0; i < 14; i++) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Calculate payroll
            const payrollData = [];
            let totalGross = 0, totalLoans = 0, totalCredit = 0, totalNet = 0;

            assignedWorkers.forEach(worker => {
                // Count present days
                let presentDays = 0;
                dates.forEach(date => {
                    const attendance = appData.attendance.find(a =>
                        a.workerId === worker.id &&
                        a.siteId === siteId &&
                        a.date === date
                    );
                    if (attendance && attendance.status === 'P') presentDays++;
                });

                const grossPay = presentDays * worker.dailyRate;

                // Get loans (they owe us)
                const workerLoans = appData.loans.filter(l =>
                    l.workerId === worker.id &&
                    l.type === 'loan' &&
                    l.status === 'pending'
                );
                const totalLoansAmount = workerLoans.reduce((sum, loan) => sum + loan.amount, 0);

                // Get credit (we owe them)
                const workerCredit = appData.loans.filter(l =>
                    l.workerId === worker.id &&
                    l.type === 'credit' &&
                    l.status === 'pending'
                );
                const totalCreditAmount = workerCredit.reduce((sum, credit) => sum + credit.amount, 0);

                const netPay = grossPay - totalLoansAmount + totalCreditAmount;

                totalGross += grossPay;
                totalLoans += totalLoansAmount;
                totalCredit += totalCreditAmount;
                totalNet += netPay;

                payrollData.push({
                    worker,
                    presentDays,
                    grossPay,
                    loans: totalLoansAmount,
                    credit: totalCreditAmount,
                    netPay
                });
            });

            // Render payroll table
            renderPayrollTable(payrollData);
            updatePayrollTotals(totalGross, totalLoans, totalCredit, totalNet);
        }

        // Render payroll table
        function renderPayrollTable(payrollData) {
            const tbody = document.getElementById('payrollTableBody');
            tbody.innerHTML = '';

            if (payrollData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px;">
                            No workers assigned
                        </td>
                    </tr>
                `;
                return;
            }

            payrollData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.worker.name} ${data.worker.surname}</td>
                    <td>${data.worker.role}</td>
                    <td>${data.presentDays}</td>
                    <td>R${data.worker.dailyRate.toLocaleString()}</td>
                    <td>R${data.grossPay.toLocaleString()}</td>
                    <td>R${data.loans.toLocaleString()}</td>
                    <td>R${data.credit.toLocaleString()}</td>
                    <td style="font-weight: bold;">R${data.netPay.toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update payroll totals
        function updatePayrollTotals(gross, loans, credit, net) {
            document.getElementById('totalGross').textContent = 'R' + gross.toLocaleString();
            document.getElementById('totalLoans').textContent = 'R' + loans.toLocaleString();
            document.getElementById('totalCredit').textContent = 'R' + credit.toLocaleString();
            document.getElementById('totalNet').textContent = 'R' + net.toLocaleString();
        }

        // Save payroll
        function savePayroll() {
            const siteId = document.getElementById('payrollSite').value;
            const fortnightId = document.getElementById('payrollFortnight').value;

            if (!siteId || !fortnightId) {
                showNotification('Please calculate payroll first', 'error');
                return;
            }

            // Get payroll data from table
            const rows = document.querySelectorAll('#payrollTableBody tr');
            const payrollItems = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 8) {
                    const name = cells[0].textContent;
                    const worker = appData.workers.find(w =>
                        `${w.name} ${w.surname}` === name
                    );

                    if (worker) {
                        payrollItems.push({
                            workerId: worker.id,
                            presentDays: parseInt(cells[2].textContent),
                            grossPay: parseFloat(cells[4].textContent.replace('R', '').replace(/,/g, '')),
                            loans: parseFloat(cells[5].textContent.replace('R', '').replace(/,/g, '')),
                            credit: parseFloat(cells[6].textContent.replace('R', '').replace(/,/g, '')),
                            netPay: parseFloat(cells[7].textContent.replace('R', '').replace(/,/g, ''))
                        });
                    }
                }
            });

            if (payrollItems.length === 0) return;

            const payroll = {
                id: generateId(),
                siteId,
                fortnightId,
                items: payrollItems,
                totalGross: parseFloat(document.getElementById('totalGross').textContent.replace('R', '').replace(/,/g, '')),
                totalLoans: parseFloat(document.getElementById('totalLoans').textContent.replace('R', '').replace(/,/g, '')),
                totalCredit: parseFloat(document.getElementById('totalCredit').textContent.replace('R', '').replace(/,/g, '')),
                totalNet: parseFloat(document.getElementById('totalNet').textContent.replace('R', '').replace(/,/g, '')),
                createdAt: new Date().toISOString()
            };

            appData.payrolls.push(payroll);

            // Mark loans as deducted and create income records for loan repayments
            payrollItems.forEach(item => {
                if (item.loans > 0) {
                    appData.loans.forEach(loan => {
                        if (loan.workerId === item.workerId && loan.type === 'loan' && loan.status === 'pending') {
                            loan.status = 'deducted';
                            loan.payrollId = payroll.id;

                            // Create income record for loan repayment
                            const worker = appData.workers.find(w => w.id === item.workerId);
                            if (worker) {
                                const income = {
                                    id: generateId(),
                                    type: 'income',
                                    siteId: siteId,
                                    amount: loan.amount,
                                    date: new Date().toISOString().split('T')[0],
                                    category: 'loan_repayment',
                                    description: `Loan repayment from ${worker.name} ${worker.surname}`,
                                    status: 'received',
                                    createdAt: new Date().toISOString()
                                };
                                appData.expenses.push(income);
                            }
                        }
                    });
                }

                if (item.credit > 0) {
                    appData.loans.forEach(credit => {
                        if (credit.workerId === item.workerId && credit.type === 'credit' && credit.status === 'pending') {
                            credit.status = 'paid';
                            credit.payrollId = payroll.id;
                        }
                    });
                }
            });

            saveData();
            loadTransactions(); // Refresh transactions to show new income
            showNotification('Payroll saved successfully', 'success');
        }

        // Load combined payroll
        function loadCombinedPayroll() {
            document.getElementById('combinedPayrollTableBody').innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 20px;">
                        Select date range, then click Calculate
                    </td>
                </tr>
            `;

            updateCombinedPayrollTotals(0, 0, 0, 0);
        }

        // Calculate combined payroll for workers across multiple sites
        function calculateCombinedPayroll() {
            const startDate = document.getElementById('combinedStartDate').value;
            const endDate = document.getElementById('combinedEndDate').value;

            if (!startDate || !endDate) {
                showNotification('Please select start and end dates', 'error');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);

            if (start > end) {
                showNotification('Start date must be before end date', 'error');
                return;
            }

            // Get all active workers
            const activeWorkers = appData.workers.filter(w => w.active);

            // Calculate payroll for each worker across all sites
            const combinedData = [];
            let totalGross = 0, totalLoans = 0, totalCredit = 0, totalNet = 0;

            activeWorkers.forEach(worker => {
                // Get attendance for this worker across all sites within date range
                const workerAttendance = appData.attendance.filter(a =>
                    a.workerId === worker.id &&
                    a.status === 'P' &&
                    new Date(a.date) >= start &&
                    new Date(a.date) <= end
                );

                if (workerAttendance.length === 0) return;

                // Group by site
                const sitesWorked = {};
                workerAttendance.forEach(record => {
                    const site = appData.sites.find(s => s.id === record.siteId);
                    if (site) {
                        if (!sitesWorked[site.id]) {
                            sitesWorked[site.id] = {
                                siteName: site.name,
                                days: 0
                            };
                        }
                        sitesWorked[site.id].days++;
                    }
                });

                const totalDays = workerAttendance.length;
                const grossPay = totalDays * worker.dailyRate;

                // Get loans and credit
                const workerLoans = appData.loans.filter(l =>
                    l.workerId === worker.id &&
                    l.type === 'loan' &&
                    l.status === 'pending'
                );
                const totalLoansAmount = workerLoans.reduce((sum, loan) => sum + loan.amount, 0);

                const workerCredit = appData.loans.filter(l =>
                    l.workerId === worker.id &&
                    l.type === 'credit' &&
                    l.status === 'pending'
                );
                const totalCreditAmount = workerCredit.reduce((sum, credit) => sum + credit.amount, 0);

                const netPay = grossPay - totalLoansAmount + totalCreditAmount;

                totalGross += grossPay;
                totalLoans += totalLoansAmount;
                totalCredit += totalCreditAmount;
                totalNet += netPay;

                const sitesList = Object.values(sitesWorked)
                    .map(s => `${s.siteName} (${s.days} days)`)
                    .join(', ');

                combinedData.push({
                    worker,
                    sitesList,
                    totalDays,
                    grossPay,
                    loans: totalLoansAmount,
                    credit: totalCreditAmount,
                    netPay
                });
            });

            // Render combined payroll table
            renderCombinedPayrollTable(combinedData);
            updateCombinedPayrollTotals(totalGross, totalLoans, totalCredit, totalNet);
        }

        // Render combined payroll table
        function renderCombinedPayrollTable(payrollData) {
            const tbody = document.getElementById('combinedPayrollTableBody');
            tbody.innerHTML = '';

            if (payrollData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px;">
                            No workers with attendance in selected period
                        </td>
                    </tr>
                `;
                return;
            }

            payrollData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.worker.name} ${data.worker.surname}</td>
                    <td>${data.sitesList}</td>
                    <td>${data.totalDays}</td>
                    <td>R${data.worker.dailyRate.toLocaleString()}</td>
                    <td>R${data.grossPay.toLocaleString()}</td>
                    <td>R${data.loans.toLocaleString()}</td>
                    <td>R${data.credit.toLocaleString()}</td>
                    <td style="font-weight: bold;">R${data.netPay.toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update combined payroll totals
        function updateCombinedPayrollTotals(gross, loans, credit, net) {
            document.getElementById('combinedTotalGross').textContent = 'R' + gross.toLocaleString();
            document.getElementById('combinedTotalLoans').textContent = 'R' + loans.toLocaleString();
            document.getElementById('combinedTotalCredit').textContent = 'R' + credit.toLocaleString();
            document.getElementById('combinedTotalNet').textContent = 'R' + net.toLocaleString();
        }

        // Render payroll history
        function renderPayrollHistory() {
            const tbody = document.getElementById('payrollHistoryBody');
            tbody.innerHTML = '';

            appData.payrolls
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .forEach(payroll => {
                    const site = appData.sites.find(s => s.id === payroll.siteId);
                    const fortnight = appData.fortnights.find(f => f.id === payroll.fortnightId);

                    if (site && fortnight) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDate(payroll.createdAt)}</td>
                            <td>${site.name}</td>
                            <td>${formatDate(fortnight.startDate)} - ${formatDate(fortnight.endDate)}</td>
                            <td>${payroll.items.length}</td>
                            <td>R${payroll.totalNet.toLocaleString()}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="viewPayroll('${payroll.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    }
                });
        }

        // View payroll
        function viewPayroll(payrollId) {
            const payroll = appData.payrolls.find(p => p.id === payrollId);
            if (!payroll) return;

            // Switch to payroll tab
            switchTab('payroll');

            document.getElementById('payrollSite').value = payroll.siteId;
            document.getElementById('payrollFortnight').value = payroll.fortnightId;

            // Calculate to show data
            setTimeout(() => calculatePayroll(), 100);
            hideModal('payrollHistoryModal');
        }

        // Export payroll PDF
        function exportPayrollPDF() {
            const siteId = document.getElementById('payrollSite').value;
            const fortnightId = document.getElementById('payrollFortnight').value;

            if (!siteId || !fortnightId) {
                showNotification('Please calculate payroll first', 'error');
                return;
            }

            showNotification('Exporting to PDF...', 'success');
            // PDF export implementation would go here
        }

        // Export combined payroll PDF
        function exportCombinedPayrollPDF() {
            showNotification('Exporting to PDF...', 'success');
            // PDF export implementation would go here
        }

        // ======================
        // PAYROLL PAYMENTS
        // ======================

        // Load payroll payments
        function loadPayrollPayments() {
            const siteId = document.getElementById('paymentsSite').value;
            const fortnightId = document.getElementById('paymentsFortnight').value;

            if (!siteId || !fortnightId) {
                document.getElementById('paymentsTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px;">
                            Select site and fortnight
                        </td>
                    </tr>
                `;
                updatePaymentsTotals(0);
                return;
            }

            const site = appData.sites.find(s => s.id === siteId);
            const fortnight = appData.fortnights.find(f => f.id === fortnightId);

            if (!site || !fortnight) return;

            // Get assigned workers
            const assignedWorkerIds = appData.siteAssignments
                .filter(a => a.siteId === siteId && !a.endDate)
                .map(a => a.workerId);

            const assignedWorkers = appData.workers
                .filter(w => assignedWorkerIds.includes(w.id) && w.active)
                .sort((a, b) => {
                    if (a.role !== b.role) return a.role.localeCompare(b.role);
                    return a.name.localeCompare(b.name);
                });

            // Generate dates
            const dates = [];
            const currentDate = new Date(fortnight.startDate);
            for (let i = 0; i < 14; i++) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Calculate payroll and get existing payments
            const paymentData = [];
            let totalNet = 0;

            assignedWorkers.forEach(worker => {
                // Count present days
                let presentDays = 0;
                dates.forEach(date => {
                    const attendance = appData.attendance.find(a =>
                        a.workerId === worker.id &&
                        a.siteId === siteId &&
                        a.date === date
                    );
                    if (attendance && attendance.status === 'P') presentDays++;
                });

                if (presentDays === 0) return;

                const grossPay = presentDays * worker.dailyRate;

                // Get loans and credit
                const workerLoans = appData.loans.filter(l =>
                    l.workerId === worker.id &&
                    l.type === 'loan' &&
                    l.status === 'pending'
                );
                const totalLoansAmount = workerLoans.reduce((sum, loan) => sum + loan.amount, 0);

                const workerCredit = appData.loans.filter(l =>
                    l.workerId === worker.id &&
                    l.type === 'credit' &&
                    l.status === 'pending'
                );
                const totalCreditAmount = workerCredit.reduce((sum, credit) => sum + credit.amount, 0);

                const netPay = grossPay - totalLoansAmount + totalCreditAmount;

                // Get existing payment record
                const existingPayment = appData.payments.find(p =>
                    p.workerId === worker.id &&
                    p.siteId === siteId &&
                    p.fortnightId === fortnightId
                );

                paymentData.push({
                    worker,
                    netPay,
                    paymentStatus: existingPayment ? existingPayment.status : 'pending',
                    paymentDate: existingPayment ? existingPayment.paymentDate : null,
                    paymentId: existingPayment ? existingPayment.id : null
                });

                totalNet += netPay;
            });

            // Render payments table
            renderPaymentsTable(paymentData);
            updatePaymentsTotals(totalNet);
        }

        // Render payments table
        function renderPaymentsTable(paymentData) {
            const tbody = document.getElementById('paymentsTableBody');
            tbody.innerHTML = '';

            if (paymentData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px;">
                            No workers with attendance in selected period
                        </td>
                    </tr>
                `;
                return;
            }

            paymentData.forEach(data => {
                const row = document.createElement('tr');
                row.id = `payment-row-${data.worker.id}`;
                if (data.paymentStatus === 'paid') {
                    row.className = 'payment-paid';
                }

                row.innerHTML = `
                    <td>${data.worker.name} ${data.worker.surname}</td>
                    <td>${data.worker.role}</td>
                    <td>${data.worker.account} (${data.worker.bank})</td>
                    <td>R${data.netPay.toLocaleString()}</td>
                    <td>
                        <select class="payment-status-select" data-worker-id="${data.worker.id}" onchange="updatePaymentStatus('${data.worker.id}')">
                            <option value="pending" ${data.paymentStatus === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="paid" ${data.paymentStatus === 'paid' ? 'selected' : ''}>Paid</option>
                        </select>
                    </td>
                    <td>${data.paymentDate ? formatDate(data.paymentDate) : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="recordPayment('${data.worker.id}')" ${data.paymentStatus === 'paid' ? 'disabled' : ''}>
                            <i class="fas fa-money-check-alt"></i> Record
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update payment status
        function updatePaymentStatus(workerId) {
            const siteId = document.getElementById('paymentsSite').value;
            const fortnightId = document.getElementById('paymentsFortnight').value;
            const select = document.querySelector(`select[data-worker-id="${workerId}"]`);
            const status = select.value;

            // Find or create payment record
            const existingIndex = appData.payments.findIndex(p =>
                p.workerId === workerId &&
                p.siteId === siteId &&
                p.fortnightId === fortnightId
            );

            if (existingIndex !== -1) {
                appData.payments[existingIndex].status = status;
                if (status === 'paid' && !appData.payments[existingIndex].paymentDate) {
                    appData.payments[existingIndex].paymentDate = new Date().toISOString().split('T')[0];
                }
            } else {
                const payment = {
                    id: generateId(),
                    workerId,
                    siteId,
                    fortnightId,
                    status,
                    paymentDate: status === 'paid' ? new Date().toISOString().split('T')[0] : null,
                    createdAt: new Date().toISOString()
                };
                appData.payments.push(payment);
            }

            saveData();
            
            // Update row appearance
            const row = document.getElementById(`payment-row-${workerId}`);
            if (status === 'paid') {
                row.className = 'payment-paid';
                row.querySelector('button').disabled = true;
            } else {
                row.className = '';
                row.querySelector('button').disabled = false;
            }

            updatePaymentsStatusSummary();
        }

        // Record payment
        function recordPayment(workerId) {
            const siteId = document.getElementById('paymentsSite').value;
            const fortnightId = document.getElementById('paymentsFortnight').value;

            // Update status to paid
            const select = document.querySelector(`select[data-worker-id="${workerId}"]`);
            select.value = 'paid';
            updatePaymentStatus(workerId);

            showNotification('Payment recorded', 'success');
        }

        // Mark all as paid
        function markAllAsPaid() {
            const siteId = document.getElementById('paymentsSite').value;
            const fortnightId = document.getElementById('paymentsFortnight').value;

            if (!siteId || !fortnightId) {
                showNotification('Please select site and fortnight first', 'error');
                return;
            }

            if (!confirm('Mark all payments as paid?')) return;

            // Get all payment rows
            const selects = document.querySelectorAll('.payment-status-select');
            selects.forEach(select => {
                select.value = 'paid';
                updatePaymentStatus(select.dataset.workerId);
            });

            showNotification('All payments marked as paid', 'success');
        }

        // Update payments totals
        function updatePaymentsTotals(totalNet) {
            document.getElementById('paymentsTotalNet').textContent = 'R' + totalNet.toLocaleString();
            updatePaymentsStatusSummary();
        }

        // Update payments status summary
        function updatePaymentsStatusSummary() {
            const siteId = document.getElementById('paymentsSite').value;
            const fortnightId = document.getElementById('paymentsFortnight').value;

            if (!siteId || !fortnightId) {
                document.getElementById('paymentsStatusSummary').textContent = '';
                return;
            }

            const paymentsForPeriod = appData.payments.filter(p =>
                p.siteId === siteId &&
                p.fortnightId === fortnightId
            );

            const paidCount = paymentsForPeriod.filter(p => p.status === 'paid').length;
            const pendingCount = paymentsForPeriod.filter(p => p.status === 'pending').length;
            const totalCount = paidCount + pendingCount;

            document.getElementById('paymentsStatusSummary').textContent = 
                `${paidCount} paid, ${pendingCount} pending (${totalCount} total)`;
        }

        // Export payments PDF
        function exportPaymentsPDF() {
            const siteId = document.getElementById('paymentsSite').value;
            const fortnightId = document.getElementById('paymentsFortnight').value;

            if (!siteId || !fortnightId) {
                showNotification('Please select site and fortnight first', 'error');
                return;
            }

            showNotification('Exporting payments to PDF...', 'success');
            // PDF export implementation would go here
        }

        // ======================
        // LOANS & CREDIT MANAGEMENT
        // ======================

        // Populate loan worker dropdown (sorted by role)
        function populateLoanWorkerDropdown() {
            const select = document.getElementById('loanWorker');
            select.innerHTML = '<option value="">Select Worker</option>';

            appData.workers
                .filter(w => w.active)
                .sort((a, b) => {
                    if (a.role !== b.role) return a.role.localeCompare(b.role);
                    return a.name.localeCompare(b.name);
                })
                .forEach(worker => {
                    const option = document.createElement('option');
                    option.value = worker.id;
                    option.textContent = `${worker.name} ${worker.surname} (${worker.role})`;
                    select.appendChild(option);
                });
        }

        // Toggle loan fields based on type
        function toggleLoanFields() {
            const loanType = document.getElementById('loanType').value;
            const deductField = document.getElementById('loanDeductField');

            if (loanType === 'loan') {
                deductField.style.display = 'block';
                document.getElementById('loanStatus').innerHTML = `
                    <option value="pending">Pending</option>
                    <option value="paid">Paid</option>
                    <option value="deducted">Deducted</option>
                `;
            } else {
                deductField.style.display = 'none';
                document.getElementById('loanStatus').innerHTML = `
                    <option value="pending">Pending</option>
                    <option value="paid">Paid</option>
                `;
            }
        }

        // Save loan/credit
        function saveLoan() {
            const type = document.getElementById('loanType').value;
            const workerId = document.getElementById('loanWorker').value;
            const amount = parseFloat(document.getElementById('loanAmount').value);
            const date = document.getElementById('loanDate').value;
            const description = document.getElementById('loanDescription').value.trim();
            const deduct = type === 'loan' ? document.getElementById('loanDeduct').checked : false;
            const status = document.getElementById('loanStatus').value;

            if (!workerId || !amount || !date || !description) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            if (amount <= 0) {
                showNotification('Amount must be greater than 0', 'error');
                return;
            }

            const loan = {
                id: generateId(),
                type,
                workerId,
                amount,
                date,
                description,
                deduct,
                status,
                createdAt: new Date().toISOString()
            };

            appData.loans.push(loan);
            saveData();
            renderLoans();
            hideModal('addLoanModal');
            showNotification(`${type === 'loan' ? 'Loan' : 'Credit'} added successfully`, 'success');
        }

        // Show edit loan modal
        function showEditLoanModal(loanId) {
            const loan = appData.loans.find(l => l.id === loanId);
            if (!loan) return;

            currentState.editLoanId = loanId;
            const worker = appData.workers.find(w => w.id === loan.workerId);

            const modalBody = document.getElementById('editLoanModalBody');
            modalBody.innerHTML = `
                <div class="form-group">
                    <label>Type</label>
                    <select id="editLoanType" disabled>
                        <option value="loan" ${loan.type === 'loan' ? 'selected' : ''}>Loan (They Owe Us)</option>
                        <option value="credit" ${loan.type === 'credit' ? 'selected' : ''}>Credit (We Owe Them)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Worker</label>
                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;">
                        ${worker ? `${worker.name} ${worker.surname} (${worker.role})` : 'Unknown Worker'}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Amount (R) *</label>
                        <input type="number" id="editLoanAmount" value="${loan.amount}" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="editLoanDate" value="${loan.date}" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Description *</label>
                    <input type="text" id="editLoanDescription" value="${loan.description}" required>
                </div>

                ${loan.type === 'loan' ? `
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="editLoanDeduct" ${loan.deduct ? 'checked' : ''}> Deduct from next payroll
                        </label>
                    </div>
                ` : ''}

                <div class="form-group">
                    <label>Status *</label>
                    <select id="editLoanStatus" class="loan-status-select">
                        <option value="pending" ${loan.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="paid" ${loan.status === 'paid' ? 'selected' : ''}>Paid</option>
                        ${loan.type === 'loan' ? '<option value="deducted" ' + (loan.status === 'deducted' ? 'selected' : '') + '>Deducted</option>' : ''}
                    </select>
                </div>
            `;

            showModal('editLoanModal');
        }

        // Update loan
        function updateLoan() {
            const loan = appData.loans.find(l => l.id === currentState.editLoanId);
            if (!loan) return;

            loan.amount = parseFloat(document.getElementById('editLoanAmount').value);
            loan.date = document.getElementById('editLoanDate').value;
            loan.description = document.getElementById('editLoanDescription').value.trim();
            if (loan.type === 'loan') {
                loan.deduct = document.getElementById('editLoanDeduct').checked;
            }
            loan.status = document.getElementById('editLoanStatus').value;
            loan.updatedAt = new Date().toISOString();

            // If loan status changed to paid and it's a loan, create income record
            if (loan.type === 'loan' && loan.status === 'paid') {
                const worker = appData.workers.find(w => w.id === loan.workerId);
                if (worker) {
                    const income = {
                        id: generateId(),
                        type: 'income',
                        siteId: null,
                        amount: loan.amount,
                        date: new Date().toISOString().split('T')[0],
                        category: 'loan_repayment',
                        description: `Loan repayment from ${worker.name} ${worker.surname}`,
                        status: 'received',
                        createdAt: new Date().toISOString()
                    };
                    appData.expenses.push(income);
                }
            }

            saveData();
            renderLoans();
            loadTransactions(); // Refresh transactions
            hideModal('editLoanModal');
            showNotification('Transaction updated successfully', 'success');

            currentState.editLoanId = null;
        }

        // Render loans
        function renderLoans() {
            renderLoansTable('loans', 'loan');
            renderLoansTable('credit', 'credit');
            renderAllLoansTable();
        }

        // Render loans table
        function renderLoansTable(tabId, type) {
            const tbody = document.getElementById(`${tabId}TableBody`);
            tbody.innerHTML = '';

            const loans = appData.loans
                .filter(l => l.type === type)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (loans.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px;">No ${type}s found</td></tr>`;
                return;
            }

            loans.forEach(loan => {
                const worker = appData.workers.find(w => w.id === loan.workerId);
                if (!worker) return;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(loan.date)}</td>
                    <td>${worker.name} ${worker.surname}</td>
                    <td>R${loan.amount.toLocaleString()}</td>
                    <td>${loan.description || '-'}</td>
                    <td><span class="status-badge status-${loan.status}">${loan.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="showEditLoanModal('${loan.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteLoan('${loan.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // Render all loans table
        function renderAllLoansTable() {
            const tbody = document.getElementById('allLoansTableBody');
            tbody.innerHTML = '';

            const allLoans = [...appData.loans]
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (allLoans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No transactions found</td></tr>';
                return;
            }

            allLoans.forEach(loan => {
                const worker = appData.workers.find(w => w.id === loan.workerId);
                if (!worker) return;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(loan.date)}</td>
                    <td>${worker.name} ${worker.surname}</td>
                    <td>${loan.type === 'loan' ? 'Loan (They Owe)' : 'Credit (We Owe)'}</td>
                    <td>R${loan.amount.toLocaleString()}</td>
                    <td>${loan.description || '-'}</td>
                    <td><span class="status-badge status-${loan.status}">${loan.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="showEditLoanModal('${loan.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteLoan('${loan.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // Delete loan
        function deleteLoan(loanId) {
            if (!confirm('Delete this transaction?')) return;

            appData.loans = appData.loans.filter(l => l.id !== loanId);
            saveData();
            renderLoans();
            showNotification('Transaction deleted', 'success');
        }

        // ======================
        // EXPENSES & INCOME
        // ======================

        // Save expense
        function saveExpense() {
            const siteId = document.getElementById('expenseSite').value || null;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const description = document.getElementById('expenseDescription').value.trim();

            if (!amount || !date || !category || !description) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            if (amount <= 0) {
                showNotification('Amount must be higher than 0', 'error');
                return;
            }

            const expense = {
                id: generateId(),
                type: 'expense',
                siteId,
                amount,
                date,
                category,
                description,
                createdAt: new Date().toISOString()
            };

            appData.expenses.push(expense);
            saveData();
            loadTransactions();
            hideModal('expenseModal');
            showNotification('Expense added', 'success');
        }

        // Save income
        function saveIncome() {
            const siteId = document.getElementById('incomeSite').value || null;
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const date = document.getElementById('incomeDate').value;
            const category = document.getElementById('incomeCategory').value;
            const description = document.getElementById('incomeDescription').value.trim();

            if (!amount || !date || !category || !description) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            if (amount <= 0) {
                showNotification('Amount must be greater than 0', 'error');
                return;
            }

            const income = {
                id: generateId(),
                type: 'income',
                siteId,
                amount,
                date,
                category,
                description,
                createdAt: new Date().toISOString()
            };

            appData.expenses.push(income);
            saveData();
            loadTransactions();
            hideModal('incomeModal');
            showNotification('Income added', 'success');
        }

        // Load transactions with edit/remove buttons
        function loadTransactions() {
            const typeFilter = document.getElementById('expenseTypeFilter').value;
            const periodFilter = document.getElementById('expensePeriodFilter').value;
            const siteFilter = document.getElementById('expenseSiteFilter').value;

            // Filter transactions
            let filtered = appData.expenses;

            if (typeFilter !== 'all') {
                filtered = filtered.filter(t => t.type === typeFilter);
            }

            if (periodFilter !== 'all') {
                const now = new Date();
                const startDate = new Date();

                switch (periodFilter) {
                    case 'today':
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'week':
                        startDate.setDate(now.getDate() - 7);
                        break;
                    case 'fortnight':
                        startDate.setDate(now.getDate() - 14);
                        break;
                    case 'month':
                        startDate.setMonth(now.getMonth() - 1);
                        break;
                    case 'year':
                        startDate.setFullYear(now.getFullYear() - 1);
                        break;
                }

                filtered = filtered.filter(t => new Date(t.date) >= startDate);
            }

            if (siteFilter !== 'all') {
                filtered = filtered.filter(t => t.siteId === siteFilter);
            }

            // Sort by date
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Render transactions
            renderTransactionsList(filtered);

            // Update summary
            updateTransactionsSummary();
        }

        // Render transactions list with edit/remove buttons
        function renderTransactionsList(transactions) {
            const container = document.getElementById('transactionsList');

            if (transactions.length === 0) {
                container.innerHTML = '<p>No transactions found</p>';
                return;
            }

            let html = '';
            transactions.slice(0, 10).forEach(transaction => {
                const siteName = transaction.siteId ?
                    appData.sites.find(s => s.id === transaction.siteId)?.name || 'Unknown' :
                    'General';

                html += `
                    <div class="transaction-card" style="margin-bottom: 10px; padding: 12px; background: white; border-radius: 8px; border-left: 4px solid ${transaction.type === 'income' ? 'var(--success)' : 'var(--danger)'};">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold;">${transaction.description}</div>
                                <div style="font-size: 0.85rem; color: var(--dark); margin-top: 4px;">
                                    ${formatDate(transaction.date)} ‚Ä¢ ${transaction.category} ‚Ä¢ ${siteName}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="font-weight: bold; color: ${transaction.type === 'income' ? 'var(--success)' : 'var(--danger)'};">
                                    ${transaction.type === 'income' ? '+' : '-'}R${transaction.amount.toLocaleString()}
                                </div>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-primary" onclick="editTransaction('${transaction.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteTransaction('${transaction.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Edit transaction (placeholder - you can implement this)
        function editTransaction(transactionId) {
            showNotification('Edit transaction feature coming soon', 'info');
        }

        // Delete transaction
        function deleteTransaction(transactionId) {
            if (!confirm('Delete this transaction?')) return;

            appData.expenses = appData.expenses.filter(t => t.id !== transactionId);
            saveData();
            loadTransactions();
            showNotification('Transaction deleted', 'success');
        }

        // Export transactions to Excel
        function exportTransactionsExcel() {
            const data = appData.expenses.map(transaction => [
                formatDate(transaction.date),
                transaction.type === 'income' ? 'Income' : 'Expense',
                transaction.category,
                transaction.description,
                transaction.siteId ? (appData.sites.find(s => s.id === transaction.siteId)?.name || 'Unknown') : 'General',
                transaction.amount,
                transaction.type === 'income' ? '+' : '-'
            ]);

            const ws = XLSX.utils.aoa_to_sheet([
                ['Date', 'Type', 'Category', 'Description', 'Site', 'Amount', 'Sign'],
                ...data
            ]);

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Transactions');
            XLSX.writeFile(wb, `Tonnylays_Transactions_${new Date().toISOString().split('T')[0]}.xlsx`);

            showNotification('Transactions exported successfully', 'success');
        }

        // Update transactions summary
        function updateTransactionsSummary() {
            let totalIncome = 0;
            let totalExpenses = 0;

            appData.expenses.forEach(t => {
                if (t.type === 'income') totalIncome += t.amount;
                else totalExpenses += t.amount;
            });

            const net = totalIncome - totalExpenses;

            document.getElementById('totalIncome').textContent = 'R' + totalIncome.toLocaleString();
            document.getElementById('totalExpenses').textContent = 'R' + totalExpenses.toLocaleString();
            document.getElementById('netBalance').textContent = 'R' + net.toLocaleString();
            document.getElementById('netBalance').style.color = net >= 0 ? 'var(--success)' : 'var(--danger)';
        }

        // Update import instructions
        function updateImportInstructions() {
            const importType = document.getElementById('importType').value;
            const instructions = document.getElementById('importInstructions');

            if (importType === 'workers') {
                instructions.innerHTML = '<p><strong>Workers columns:</strong> Name, Surname, ID, Phone, Role, DailyRate, Bank, Account</p>';
            } else if (importType === 'transactions') {
                instructions.innerHTML = '<p><strong>Transactions columns:</strong> Date, Type (expense/income), Category, Description, Site (optional), Amount</p>';
            } else if (importType === 'loans') {
                instructions.innerHTML = '<p><strong>Loans columns:</strong> Date, Type (loan/credit), Worker (ID or Name), Amount, Description, Status</p>';
            }
        }

        // Import data
        function importData() {
            const importType = document.getElementById('importType').value;
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];

            if (!file) {
                showNotification('Please select an Excel file', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // Skip header
                    const rows = jsonData.slice(1);
                    let imported = 0;
                    let skipped = 0;

                    if (importType === 'workers') {
                        rows.forEach(row => {
                            if (row.length >= 8) {
                                const [name, surname, idNumber, phone, role, dailyRate, bank, account, status] = row;

                                if (!name || !surname || !idNumber || !role) {
                                    skipped++;
                                    return;
                                }

                                // Check for duplicates
                                const duplicate = appData.workers.find(w => w.idNumber === idNumber);
                                if (duplicate) {
                                    skipped++;
                                    return;
                                }

                                const worker = {
                                    id: generateId(),
                                    name: name.toString(),
                                    surname: surname.toString(),
                                    idNumber: idNumber.toString(),
                                    phone: phone ? phone.toString() : '',
                                    role: role.toString(),
                                    dailyRate: parseFloat(dailyRate) || 0,
                                    bank: bank ? bank.toString() : 'Other',
                                    account: account ? account.toString() : '',
                                    active: status ? (status === 'Active' || status === 'active' || status === true) : true,
                                    createdAt: new Date().toISOString()
                                };

                                appData.workers.push(worker);
                                imported++;
                            }
                        });
                        saveData();
                        renderWorkers();
                        showNotification(`Imported ${imported} workers, skipped ${skipped}`, 'success');
                    } else if (importType === 'transactions') {
                        // Import transactions logic
                        showNotification('Transactions import feature coming soon', 'success');
                    } else if (importType === 'loans') {
                        // Import loans logic
                        showNotification('Loans import feature coming soon', 'success');
                    }

                    hideModal('importExcelModal');
                    fileInput.value = '';

                } catch (error) {
                    showNotification('Error importing file: ' + error.message, 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // ======================
        // INVOICES
        // ======================

        // Start new invoice
        function startNewInvoice() {
            // Clear form
            document.getElementById('invoiceTo').value = '';
            document.getElementById('invoiceAddress').value = '';
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];

            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];

            // Clear items
            currentState.invoiceItems = [];
            renderInvoiceItems();

            // Update invoice number
            updateInvoiceNumber();

            showNotification('New invoice started', 'success');
        }

        // Add invoice item
        function addInvoiceItem() {
            const description = document.getElementById('itemDesc').value.trim();
            const quantity = parseFloat(document.getElementById('itemQty').value);
            const rate = parseFloat(document.getElementById('itemRate').value);

            if (!description || !quantity || !rate) {
                showNotification('Please fill all item fields', 'error');
                return;
            }

            if (quantity <= 0 || rate <= 0) {
                showNotification('Quantity and rate must be higher than 0', 'error');
                return;
            }

            const item = {
                id: generateId(),
                description,
                quantity,
                rate,
                amount: quantity * rate
            };

            currentState.invoiceItems.push(item);
            renderInvoiceItems();

            // Clear form
            document.getElementById('itemDesc').value = '';
            document.getElementById('itemQty').value = '1';
            document.getElementById('itemRate').value = '';
        }

        // Remove invoice item
        function removeInvoiceItem(itemId) {
            currentState.invoiceItems = currentState.invoiceItems.filter(item => item.id !== itemId);
            renderInvoiceItems();
        }

        // Render invoice items
        function renderInvoiceItems() {
            const tbody = document.getElementById('invoiceItemsTableBody');
            tbody.innerHTML = '';

            currentState.invoiceItems.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.description}</td>
                    <td>${item.quantity}</td>
                    <td>R${item.rate.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                    <td>R${item.amount.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeInvoiceItem('${item.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Show invoice preview with construction theme
        function showInvoicePreview() {
            const to = document.getElementById('invoiceTo').value.trim();
            const address = document.getElementById('invoiceAddress').value.trim();
            const date = document.getElementById('invoiceDate').value;
            const dueDate = document.getElementById('invoiceDueDate').value;
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();

            if (!to || !address || currentState.invoiceItems.length === 0) {
                showNotification('Please fill client details and add items', 'error');
                return;
            }

            // Calculate totals
            let subtotal = 0;
            currentState.invoiceItems.forEach(item => {
                subtotal += item.amount;
            });

            const vat = subtotal * 0;
            const total = subtotal + vat;

            // Build preview with construction theme
            const preview = document.getElementById('invoicePreviewContent');
            preview.innerHTML = `
                <div class="invoice-header">
                    <h2><i class="fas fa-hard-hat"></i> TONNY LAYS CONSTRUCTION</h2>
                    <div class="subtitle">Quality Construction Services</div>
                    <div style="font-size: 1.2rem; margin-top: 10px; background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; display: inline-block;">
                        INVOICE #${invoiceNumber}
                    </div>
                </div>
                
                <div class="invoice-company">
                    <h4><i class="fas fa-building"></i> FROM:</h4>
                    <p><strong>Tonny Lays Pty Ltd</strong></p>
                    <p><i class="fas fa-envelope"></i> Email: itonmuleya@yahoo.com</p>
                    <p><i class="fas fa-phone"></i> Phone: 073 062 6432</p>
                </div>
                
                <div class="invoice-company">
                    <h4><i class="fas fa-user"></i> TO:</h4>
                    <p><strong>${to}</strong></p>
                    <p>${address.replace(/\n/g, '<br>')}</p>
                    <p><i class="fas fa-calendar"></i> Invoice Date: ${formatDate(date)}</p>
                    <p><i class="fas fa-calendar-check"></i> Due Date: ${formatDate(dueDate)}</p>
                </div>
                
                <div style="background: white; border-radius: 10px; overflow: hidden; margin: 20px 0; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;">
                                <th style="padding: 15px; text-align: left;">Description</th>
                                <th style="padding: 15px; text-align: center;">Qty</th>
                                <th style="padding: 15px; text-align: right;">Rate</th>
                                <th style="padding: 15px; text-align: right;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentState.invoiceItems.map(item => `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 15px;">${item.description}</td>
                                    <td style="padding: 15px; text-align: center;">${item.quantity}</td>
                                    <td style="padding: 15px; text-align: right;">R${item.rate.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                                    <td style="padding: 15px; text-align: right;">R${item.amount.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                    <div style="max-width: 300px; margin-left: auto;">
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border);">
                            <span>Subtotal:</span>
                            <span>R${subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border);">
                            <span>VAT (0%):</span>
                            <span>R${vat.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 15px 0; font-size: 1.2rem; font-weight: bold; color: var(--primary);">
                            <span>TOTAL:</span>
                            <span>R${total.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; text-align: center; border: 3px solid white;">
                    <p style="font-size: 1.1rem; font-weight: bold; margin-bottom: 10px;">Thank you for your business!</p>
                    <p style="margin-top: 10px; font-size: 0.9rem; opacity: 0.9;">üèóÔ∏è Building Dreams, Creating Excellence üèóÔ∏è</p>
                </div>
            `;

            showModal('invoicePreviewModal');
        }

        // Generate invoice PDF
        function generateInvoicePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const to = document.getElementById('invoiceTo').value.trim();
            const address = document.getElementById('invoiceAddress').value.trim();
            const date = document.getElementById('invoiceDate').value;
            const dueDate = document.getElementById('invoiceDueDate').value;
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();

            // Calculate totals
            let subtotal = 0;
            currentState.invoiceItems.forEach(item => {
                subtotal += item.amount;
            });

            const vat = subtotal * 0;
            const total = subtotal + vat;

            // Header with construction theme
            doc.setFillColor(26, 54, 93);
            doc.rect(0, 0, 220, 40, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.text('TONNY LAYS CONSTRUCTION', 105, 15, { align: 'center' });

            doc.setFontSize(14);
            doc.text('Quality Construction Services', 105, 25, { align: 'center' });

            doc.setFontSize(18);
            doc.text('INVOICE', 105, 35, { align: 'center' });

            // Invoice number and dates
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.text(`Invoice #: ${invoiceNumber}`, 14, 50);
            doc.text(`Date: ${formatDate(date)}`, 14, 57);
            doc.text(`Due: ${formatDate(dueDate)}`, 14, 64);

            // From/To details
            doc.setFontSize(14);
            doc.text('From:', 14, 80);
            doc.setFontSize(12);
            doc.text('Tonny Lays Pty Ltd', 14, 87);
            doc.text('Email: itonmuleya@yahoo.com', 14, 94);
            doc.text('Phone: 073 062 6432', 14, 101);

            doc.setFontSize(14);
            doc.text('To:', 120, 80);
            doc.setFontSize(12);

            // Break address into lines
            const addressLines = doc.splitTextToSize(to, 80);
            let yPos = 87;
            addressLines.forEach(line => {
                doc.text(line, 120, yPos);
                yPos += 7;
            });

            const addrLines = doc.splitTextToSize(address, 80);
            addrLines.forEach(line => {
                doc.text(line, 120, yPos);
                yPos += 7;
            });

            // Items table
            const tableData = [['Description', 'Quantity', 'Rate', 'Amount']];

            currentState.invoiceItems.forEach(item => {
                tableData.push([
                    item.description,
                    item.quantity.toString(),
                    'R' + item.rate.toLocaleString(undefined, { minimumFractionDigits: 2 }),
                    'R' + item.amount.toLocaleString(undefined, { minimumFractionDigits: 2 })
                ]);
            });

            doc.autoTable({
                startY: 110,
                head: [tableData[0]],
                body: tableData.slice(1),
                theme: 'grid',
                styles: { fontSize: 10, cellPadding: 5 },
                headStyles: { fillColor: [26, 54, 93], textColor: [255, 255, 255] },
                columnStyles: {
                    0: { cellWidth: 90 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 35 },
                    3: { cellWidth: 35 }
                },
                didDrawPage: function (data) {
                    // Totals
                    const finalY = data.cursor.y + 10;

                    doc.setFontSize(12);
                    doc.text(`Subtotal: R${subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}`, 140, finalY);
                    doc.text(`VAT (0%): R${vat.toLocaleString(undefined, { minimumFractionDigits: 2 })}`, 140, finalY + 7);

                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Total: R${total.toLocaleString(undefined, { minimumFractionDigits: 2 })}`, 140, finalY + 17);

                    // Footer
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text('Thank you for your business!', 105, doc.internal.pageSize.height - 20, { align: 'center' });
                    doc.text('Building Dreams, Creating Excellence', 105, doc.internal.pageSize.height - 15, { align: 'center' });
                }
            });

            // Save
            doc.save(`Invoice_${invoiceNumber}.pdf`);
            showNotification('Invoice PDF downloaded', 'success');
            hideModal('invoicePreviewModal');
        }

        // Save invoice
        function saveInvoice() {
            const to = document.getElementById('invoiceTo').value.trim();
            const address = document.getElementById('invoiceAddress').value.trim();
            const date = document.getElementById('invoiceDate').value;
            const dueDate = document.getElementById('invoiceDueDate').value;
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();

            if (!to || !address || !invoiceNumber || currentState.invoiceItems.length === 0) {
                showNotification('Please complete all fields and add items', 'error');
                return;
            }

            // Calculate totals
            let subtotal = 0;
            currentState.invoiceItems.forEach(item => {
                subtotal += item.amount;
            });

            const vat = subtotal * 0;
            const total = subtotal + vat;

            const invoice = {
                id: generateId(),
                to,
                address,
                date,
                dueDate,
                invoiceNumber,
                items: currentState.invoiceItems,
                subtotal,
                vat,
                total,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            appData.invoices.push(invoice);
            saveData();

            // Clear form
            startNewInvoice();

            // Update invoices list
            renderInvoices();

            showNotification('Invoice saved successfully', 'success');
            hideModal('invoicePreviewModal');
        }

        // Render invoices
        function renderInvoices() {
            const tbody = document.getElementById('invoicesTableBody');
            tbody.innerHTML = '';

            appData.invoices
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(invoice => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${invoice.invoiceNumber}</td>
                        <td>${formatDate(invoice.date)}</td>
                        <td>${invoice.to}</td>
                        <td>R${invoice.total.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                        <td><span class="status-badge status-${invoice.status}">${invoice.status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick="viewSavedInvoice('${invoice.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-success" onclick="downloadInvoice('${invoice.id}')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteInvoice('${invoice.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
        }

        // View saved invoice
        function viewSavedInvoice(invoiceId) {
            const invoice = appData.invoices.find(i => i.id === invoiceId);
            if (!invoice) return;

            // Populate form
            document.getElementById('invoiceTo').value = invoice.to;
            document.getElementById('invoiceAddress').value = invoice.address;
            document.getElementById('invoiceDate').value = invoice.date;
            document.getElementById('invoiceDueDate').value = invoice.dueDate;
            document.getElementById('invoiceNumber').value = invoice.invoiceNumber;

            // Set items
            currentState.invoiceItems = [...invoice.items];
            renderInvoiceItems();

            showNotification('Invoice loaded', 'success');
            switchTab('invoices');
        }

        // Download invoice
        function downloadInvoice(invoiceId) {
            const invoice = appData.invoices.find(i => i.id === invoiceId);
            if (!invoice) return;

            // Set current invoice
            document.getElementById('invoiceTo').value = invoice.to;
            document.getElementById('invoiceAddress').value = invoice.address;
            document.getElementById('invoiceDate').value = invoice.date;
            document.getElementById('invoiceDueDate').value = invoice.dueDate;
            document.getElementById('invoiceNumber').value = invoice.invoiceNumber;
            currentState.invoiceItems = [...invoice.items];

            // Generate PDF
            generateInvoicePDF();
        }

        // Delete invoice
        function deleteInvoice(invoiceId) {
            if (!confirm('Delete this invoice?')) return;

            appData.invoices = appData.invoices.filter(i => i.id !== invoiceId);
            saveData();
            renderInvoices();
            showNotification('Invoice deleted', 'success');
        }

        // ======================
        // BACKUP & RESTORE
        // ======================

        // Backup data
        function backupData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', `tonnylays_backup_${new Date().toISOString().split('T')[0]}.json`);
            link.click();

            showNotification('Backup downloaded', 'success');
        }

        // Restore backup
        function restoreBackup() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];

            if (!file) {
                showNotification('Please select a backup file', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const backupData = JSON.parse(e.target.result);

                    if (!confirm('This will replace all current data. Continue?')) return;

                    appData = backupData;
                    saveData();
                    renderAll();
                    updateFortnightSelectors();
                    populateRatesTable();

                    hideModal('restoreModal');
                    showNotification('Data restored successfully', 'success');

                    // Clear file input
                    fileInput.value = '';

                } catch (error) {
                    showNotification('Error reading backup file', 'error');
                }
            };

            reader.readAsText(file);
        }

        // ======================
        // UTILITY FUNCTIONS
        // ======================

        // Generate ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-ZA', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Format date short
        function formatDateShort(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-ZA', {
                month: 'short',
                day: 'numeric'
            });
        }

        // Initialize the app
        window.onload = initApp;
    </script>
</body>

</html>
