<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tonnylays Construction Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary), #1a2530);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2.5rem;
            color: var(--secondary);
        }

        .logo h1 {
            font-size: 1.8rem;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            flex: 1;
            text-align: center;
        }

        .nav-tab:hover {
            background-color: #f8f9fa;
            color: var(--primary);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--secondary);
            background-color: #f8f9fa;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .card-title {
            font-size: 1.4rem;
            color: var(--primary);
            font-weight: 700;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #229954;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background-color: #d68910;
            transform: translateY(-2px);
        }

        .btn-light {
            background-color: var(--light);
            color: var(--dark);
        }

        .btn-light:hover {
            background-color: #d5dbdb;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn-block {
            width: 100%;
            justify-content: center;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Attendance Grid */
        .attendance-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .attendance-filters {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .attendance-grid-container {
            overflow-x: auto;
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .attendance-grid {
            min-width: 1200px;
            border-collapse: separate;
            border-spacing: 0;
        }

        .attendance-grid th {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .attendance-grid td, .attendance-grid th {
            border: 1px solid #ddd;
            text-align: center;
            padding: 10px;
            min-width: 50px;
        }

        .attendance-cell {
            width: 60px;
            height: 60px;
            cursor: pointer;
            font-weight: bold;
            border: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .attendance-cell:hover {
            border-color: var(--secondary);
            transform: scale(1.05);
        }

        .attendance-cell.present {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .attendance-cell.absent {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .attendance-cell:not(.present):not(.absent) {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .day-header {
            font-size: 0.9rem;
            font-weight: 600;
            background-color: #e9ecef;
            padding: 10px 5px;
        }

        .date-header {
            font-size: 0.8rem;
            color: var(--gray);
        }

        /* Dashboard */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            text-align: center;
            border-top: 5px solid var(--secondary);
        }

        .stat-card.green {
            border-top-color: var(--success);
        }

        .stat-card.red {
            border-top-color: var(--danger);
        }

        .stat-card.orange {
            border-top-color: var(--warning);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .stat-label {
            color: var(--gray);
            font-size: 1rem;
        }

        .role-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .role-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .role-title {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 2px solid var(--light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 700;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 2px solid var(--light);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: var(--success);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background-color: var(--danger);
        }

        .toast.warning {
            background-color: var(--warning);
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .p-20 { padding: 20px; }
        .d-flex { display: flex; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-10 { gap: 10px; }
        .gap-20 { gap: 20px; }
        .w-100 { width: 100%; }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                flex: 1 0 50%;
            }
            
            .header-controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        /* Loan/Credit specific */
        .loan-type {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .loan-type-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
        }

        .loan-type-btn.active {
            border-color: var(--secondary);
            background-color: #e3f2fd;
            color: var(--secondary);
        }

        /* Expense tracker */
        .expense-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .expense-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .expense-summary-item {
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .expense-summary-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .expense-income {
            color: var(--success);
        }

        .expense-expense {
            color: var(--danger);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="logo">
                <i class="fas fa-hard-hat"></i>
                <div>
                    <h1>Tonnylays Construction</h1>
                    <p>Worker Attendance & Payroll System</p>
                </div>
            </div>
            <div class="header-controls">
                <div id="currentSite" class="btn btn-light">
                    <i class="fas fa-map-marker-alt"></i> Select Site
                </div>
                <button id="backupBtn" class="btn btn-warning">
                    <i class="fas fa-database"></i> Backup Data
                </button>
                <button id="restoreBtn" class="btn btn-light">
                    <i class="fas fa-upload"></i> Restore Data
                </button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </div>
            <div class="nav-tab" data-tab="workers">
                <i class="fas fa-users"></i> Workers
            </div>
            <div class="nav-tab" data-tab="attendance">
                <i class="fas fa-clipboard-check"></i> Attendance
            </div>
            <div class="nav-tab" data-tab="payroll">
                <i class="fas fa-money-check-alt"></i> Payroll
            </div>
            <div class="nav-tab" data-tab="loans">
                <i class="fas fa-hand-holding-usd"></i> Loans/Credit
            </div>
            <div class="nav-tab" data-tab="expenses">
                <i class="fas fa-receipt"></i> Expenses/Income
            </div>
            <div class="nav-tab" data-tab="sites">
                <i class="fas fa-map-marked-alt"></i> Sites
            </div>
        </div>

        <!-- Tab Contents -->
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Today's Overview</div>
                    <div class="d-flex gap-10">
                        <select id="dashboardSiteFilter" class="form-control">
                            <option value="all">All Sites</option>
                        </select>
                        <input type="date" id="dashboardDateFilter" class="form-control">
                    </div>
                </div>
                
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-label">Total Workers</div>
                        <div class="stat-number" id="totalWorkers">0</div>
                        <div class="stat-subtext">Active across all sites</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-label">Present Today</div>
                        <div class="stat-number" id="presentToday">0</div>
                        <div class="stat-subtext">Marked as present</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-label">Absent Today</div>
                        <div class="stat-number" id="absentToday">0</div>
                        <div class="stat-subtext">Marked as absent</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-label">Not Marked</div>
                        <div class="stat-number" id="notMarkedToday">0</div>
                        <div class="stat-subtext">Attendance pending</div>
                    </div>
                </div>
                
                <div class="card-title mt-20">Role Breakdown for Selected Site</div>
                <div class="role-breakdown" id="roleBreakdown">
                    <!-- Filled by JavaScript -->
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Recent Activity</div>
                </div>
                <div class="table-container">
                    <table id="recentActivityTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Activity</th>
                                <th>User</th>
                                <th>Site</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivityBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Workers Tab -->
        <div id="workers" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Manage Workers</div>
                    <div class="d-flex gap-10">
                        <button id="exportWorkersBtn" class="btn btn-success">
                            <i class="fas fa-file-excel"></i> Export to Excel
                        </button>
                        <button id="importWorkersBtn" class="btn btn-warning">
                            <i class="fas fa-file-import"></i> Import Excel
                        </button>
                        <button id="addWorkerBtn" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> Add Worker
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="workersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Surname</th>
                                <th>Role</th>
                                <th>Daily Rate</th>
                                <th>Bank</th>
                                <th>Account No.</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="workersTableBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendance" class="tab-content">
            <div class="attendance-controls">
                <div class="attendance-filters">
                    <div class="form-group">
                        <label>Select Site</label>
                        <select id="attendanceSite" class="form-control">
                            <option value="">-- Select Site --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fortnight Start Date</label>
                        <input type="date" id="fortnightStart" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Fortnight End Date</label>
                        <input type="text" id="fortnightEnd" class="form-control" readonly>
                    </div>
                </div>
                <div>
                    <button id="saveAttendanceBtn" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Attendance
                    </button>
                    <button id="exportAttendanceBtn" class="btn btn-primary">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                </div>
            </div>
            
            <div class="attendance-grid-container">
                <div id="attendanceGrid">
                    <!-- Attendance grid will be generated by JavaScript -->
                    <div class="text-center p-20">
                        <i class="fas fa-clipboard-list fa-3x" style="color: #ccc;"></i>
                        <h3>Select a site and fortnight to view attendance</h3>
                        <p>Use the controls above to get started</p>
                    </div>
                </div>
            </div>
            
            <div class="card mt-20">
                <div class="card-header">
                    <div class="card-title">Attendance Summary</div>
                </div>
                <div id="attendanceSummary" class="p-20">
                    <!-- Summary will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Payroll Tab -->
        <div id="payroll" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Generate Payroll</div>
                    <div class="d-flex gap-10">
                        <select id="payrollSite" class="form-control">
                            <option value="">-- Select Site --</option>
                        </select>
                        <input type="date" id="payrollFortnightStart" class="form-control">
                        <button id="generatePayrollBtn" class="btn btn-primary">
                            <i class="fas fa-calculator"></i> Calculate
                        </button>
                        <button id="exportPayrollBtn" class="btn btn-success">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="payrollTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Days</th>
                                <th>Rate</th>
                                <th>Gross Pay</th>
                                <th>Loan</th>
                                <th>Credit</th>
                                <th>Net Pay</th>
                                <th>Bank</th>
                                <th>Account No.</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="payrollTableBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Loans/Credit Tab -->
        <div id="loans" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Manage Loans & Credit</div>
                    <button id="addLoanBtn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Loan/Credit
                    </button>
                </div>
                
                <div class="loan-type" id="loanTypeFilter">
                    <div class="loan-type-btn active" data-type="all">All</div>
                    <div class="loan-type-btn" data-type="loan">Loans (They owe us)</div>
                    <div class="loan-type-btn" data-type="credit">Credit (We owe them)</div>
                </div>
                
                <div class="table-container">
                    <table id="loansTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Worker</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Deduct Next</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="loansTableBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Expenses/Income Tab -->
        <div id="expenses" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Expense & Income Tracker</div>
                    <div class="d-flex gap-10">
                        <button id="addExpenseBtn" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Expense
                        </button>
                        <button id="addIncomeBtn" class="btn btn-success">
                            <i class="fas fa-plus"></i> Add Income
                        </button>
                    </div>
                </div>
                
                <div class="expense-filters">
                    <select id="expenseSiteFilter" class="form-control">
                        <option value="all">All Sites</option>
                    </select>
                    <select id="expenseTypeFilter" class="form-control">
                        <option value="all">All Types</option>
                        <option value="expense">Expenses</option>
                        <option value="income">Income</option>
                    </select>
                    <select id="expensePeriodFilter" class="form-control">
                        <option value="today">Today</option>
                        <option value="fortnight">This Fortnight</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                        <option value="all">All Time</option>
                    </select>
                    <input type="date" id="expenseCustomStart" class="form-control" placeholder="Start Date">
                    <input type="date" id="expenseCustomEnd" class="form-control" placeholder="End Date">
                </div>
                
                <div class="expense-summary">
                    <div class="expense-summary-item">
                        <div class="stat-label">Total Income</div>
                        <div class="expense-summary-value expense-income" id="totalIncome">R 0.00</div>
                    </div>
                    <div class="expense-summary-item">
                        <div class="stat-label">Total Expenses</div>
                        <div class="expense-summary-value expense-expense" id="totalExpenses">R 0.00</div>
                    </div>
                    <div class="expense-summary-item">
                        <div class="stat-label">Net Balance</div>
                        <div class="expense-summary-value" id="netBalance">R 0.00</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="expensesTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Site</th>
                                <th>Type</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Entered By</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sites Tab -->
        <div id="sites" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Manage Sites</div>
                    <button id="addSiteBtn" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Site
                    </button>
                </div>
                
                <div class="table-container">
                    <table id="sitesTable">
                        <thead>
                            <tr>
                                <th>Site Name</th>
                                <th>Foreman</th>
                                <th>Active Workers</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sitesTableBody">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card mt-20">
                <div class="card-header">
                    <div class="card-title">Site Notes & Diary</div>
                    <button id="addNoteBtn" class="btn btn-primary">
                        <i class="fas fa-sticky-note"></i> Add Note
                    </button>
                </div>
                <div id="siteNotesContainer" class="p-20">
                    <!-- Site notes will be added here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Add Worker Modal -->
    <div id="workerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add/Edit Worker</div>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="workerForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="workerName">Name *</label>
                            <input type="text" id="workerName" required>
                        </div>
                        <div class="form-group">
                            <label for="workerSurname">Surname *</label>
                            <input type="text" id="workerSurname" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="workerId">ID Number *</label>
                            <input type="text" id="workerId" required>
                        </div>
                        <div class="form-group">
                            <label for="workerPhone">Phone Number</label>
                            <input type="tel" id="workerPhone">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="workerRole">Role *</label>
                            <select id="workerRole" required>
                                <option value="">-- Select Role --</option>
                                <option value="Bricklayer">Bricklayer</option>
                                <option value="Labourer">Labourer</option>
                                <option value="Plasterer">Plasterer</option>
                                <option value="Plaster Operator">Plaster Operator</option>
                                <option value="Plaster Labourer">Plaster Labourer</option>
                                <option value="Foreman">Foreman</option>
                                <option value="Transport">Transport</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="workerRate">Daily Rate (R) *</label>
                            <input type="number" id="workerRate" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="workerBank">Bank Name *</label>
                            <select id="workerBank" required>
                                <option value="">-- Select Bank --</option>
                                <option value="Tymebank">Tymebank</option>
                                <option value="ABSA">ABSA</option>
                                <option value="FNB">FNB</option>
                                <option value="Standard Bank">Standard Bank</option>
                                <option value="Nedbank">Nedbank</option>
                                <option value="Capitec">Capitec</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="workerAccount">Account Number *</label>
                            <input type="text" id="workerAccount" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="workerActive" checked> Active Worker
                        </label>
                    </div>
                    
                    <input type="hidden" id="workerEditId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light close-modal">Cancel</button>
                <button id="saveWorkerBtn" class="btn btn-primary">Save Worker</button>
            </div>
        </div>
    </div>

    <!-- Add Loan Modal -->
    <div id="loanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add Loan/Credit</div>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="loan-type">
                    <div class="loan-type-btn active" data-loan-type="loan">Loan (They owe us)</div>
                    <div class="loan-type-btn" data-loan-type="credit">Credit (We owe them)</div>
                </div>
                
                <form id="loanForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="loanWorker">Worker *</label>
                            <select id="loanWorker" required>
                                <option value="">-- Select Worker --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="loanDate">Date *</label>
                            <input type="date" id="loanDate" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="loanAmount">Amount (R) *</label>
                            <input type="number" id="loanAmount" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="loanStatus">Status</label>
                            <select id="loanStatus">
                                <option value="Pending">Pending</option>
                                <option value="Deducted">Deducted</option>
                                <option value="Paid">Paid</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="loanDescription">Description</label>
                        <textarea id="loanDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="loanDeductNext"> Deduct in next payroll
                        </label>
                    </div>
                    
                    <input type="hidden" id="loanType" value="loan">
                    <input type="hidden" id="loanEditId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light close-modal">Cancel</button>
                <button id="saveLoanBtn" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Expense/Income Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="expenseModalTitle">Add Expense/Income</div>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="expenseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseType">Type *</label>
                            <select id="expenseType" required>
                                <option value="expense">Expense</option>
                                <option value="income">Income</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expenseDate">Date *</label>
                            <input type="date" id="expenseDate" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseSite">Site</label>
                            <select id="expenseSite">
                                <option value="">-- Select Site --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expenseCategory">Category *</label>
                            <select id="expenseCategory" required>
                                <option value="">-- Select Category --</option>
                                <option value="Petrol">Petrol</option>
                                <option value="Vehicle Service">Vehicle Service</option>
                                <option value="Equipment">Equipment Purchase</option>
                                <option value="Materials">Construction Materials</option>
                                <option value="Salaries">Salaries</option>
                                <option value="Office">Office Expenses</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseAmount">Amount (R) *</label>
                            <input type="number" id="expenseAmount" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="expenseStatus">Status</label>
                            <select id="expenseStatus">
                                <option value="Pending">Pending</option>
                                <option value="Paid">Paid</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseDescription">Description *</label>
                        <textarea id="expenseDescription" rows="3" required placeholder="e.g., Petrol for site vehicle"></textarea>
                    </div>
                    
                    <input type="hidden" id="expenseEditId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light close-modal">Cancel</button>
                <button id="saveExpenseBtn" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Site Modal -->
    <div id="siteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add/Edit Site</div>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="siteForm">
                    <div class="form-group">
                        <label for="siteName">Site Name *</label>
                        <input type="text" id="siteName" required placeholder="e.g., Paarl, Cape Town">
                    </div>
                    
                    <div class="form-group">
                        <label for="siteForeman">Foreman</label>
                        <select id="siteForeman">
                            <option value="">-- Select Foreman --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="siteActive" checked> Active Site
                        </label>
                    </div>
                    
                    <input type="hidden" id="siteEditId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light close-modal">Cancel</button>
                <button id="saveSiteBtn" class="btn btn-primary">Save Site</button>
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add Site Note</div>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="noteForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="noteSite">Site *</label>
                            <select id="noteSite" required>
                                <option value="">-- Select Site --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="noteDate">Date</label>
                            <input type="date" id="noteDate">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="noteText">Note *</label>
                        <textarea id="noteText" rows="5" required placeholder="Enter your note here..."></textarea>
                    </div>
                    
                    <input type="hidden" id="noteEditId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light close-modal">Cancel</button>
                <button id="saveNoteBtn" class="btn btn-primary">Save Note</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Operation completed successfully</span>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Import Workers from Excel</div>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Excel File</label>
                    <input type="file" id="excelFile" accept=".xlsx, .xls, .csv">
                </div>
                <div class="form-group">
                    <p><strong>File format should have columns:</strong> Name, Surname, ID Number, Phone, Role, Daily Rate, Bank Name, Account Number, Active</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light close-modal">Cancel</button>
                <button id="processImportBtn" class="btn btn-primary">Import Data</button>
            </div>
        </div>
    </div>

    <!-- Backup/Restore Modal -->
    <div id="backupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Backup/Restore Data</div>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Current Data</label>
                    <textarea id="backupData" rows="10" readonly style="width: 100%; font-family: monospace; padding: 10px;"></textarea>
                </div>
                <div class="d-flex gap-10 mt-20">
                    <button id="downloadBackupBtn" class="btn btn-success">
                        <i class="fas fa-download"></i> Download Backup
                    </button>
                    <button id="uploadBackupBtn" class="btn btn-warning">
                        <i class="fas fa-upload"></i> Restore from File
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light close-modal">Close</button>
            </div>
        </div>
    </div>

    <!-- Site Selection Modal -->
    <div id="siteSelectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Select Current Site</div>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Choose your current site</label>
                    <select id="currentSiteSelect" class="form-control">
                        <option value="">-- Select Site --</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light close-modal">Cancel</button>
                <button id="confirmSiteBtn" class="btn btn-primary">Select Site</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // DATA MANAGEMENT & STORAGE
        // ============================================
        
        // Initialize data structure
        let appData = {
            workers: [],
            sites: [],
            siteAssignments: [],
            fortnights: [],
            attendance: [],
            loans: [],
            expenses: [],
            siteNotes: [],
            equipment: [],
            activityLog: []
        };

        // Load data from localStorage
        function loadData() {
            const savedData = localStorage.getItem('tonnylaysData');
            if (savedData) {
                try {
                    appData = JSON.parse(savedData);
                    
                    // Initialize arrays if they don't exist (for backward compatibility)
                    if (!appData.siteAssignments) appData.siteAssignments = [];
                    if (!appData.fortnights) appData.fortnights = [];
                    if (!appData.attendance) appData.attendance = [];
                    if (!appData.loans) appData.loans = [];
                    if (!appData.expenses) appData.expenses = [];
                    if (!appData.siteNotes) appData.siteNotes = [];
                    if (!appData.equipment) appData.equipment = [];
                    if (!appData.activityLog) appData.activityLog = [];
                    
                    console.log('Data loaded successfully');
                } catch (e) {
                    console.error('Error loading data:', e);
                    initializeSampleData();
                }
            } else {
                initializeSampleData();
            }
            
            updateAllUI();
        }

        // Save data to localStorage
        function saveData() {
            try {
                localStorage.setItem('tonnylaysData', JSON.stringify(appData));
                console.log('Data saved successfully');
            } catch (e) {
                console.error('Error saving data:', e);
                showToast('Error saving data: ' + e.message, 'error');
            }
        }

        // Initialize with sample data for testing
        function initializeSampleData() {
            // Sample workers
            appData.workers = [
                {
                    id: generateId(),
                    name: 'John',
                    surname: 'Doe',
                    idNumber: '8001015000089',
                    phone: '0712345678',
                    role: 'Bricklayer',
                    dailyRate: 1200,
                    bankName: 'Tymebank',
                    accountNumber: '12345678901',
                    active: true,
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateId(),
                    name: 'Peter',
                    surname: 'Smith',
                    idNumber: '9002025000089',
                    phone: '0723456789',
                    role: 'Labourer',
                    dailyRate: 800,
                    bankName: 'ABSA',
                    accountNumber: '23456789012',
                    active: true,
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateId(),
                    name: 'Maria',
                    surname: 'Johnson',
                    idNumber: '8503035000089',
                    phone: '0734567890',
                    role: 'Foreman',
                    dailyRate: 1500,
                    bankName: 'FNB',
                    accountNumber: '34567890123',
                    active: true,
                    createdAt: new Date().toISOString()
                }
            ];

            // Sample sites
            appData.sites = [
                {
                    id: generateId(),
                    name: 'Paarl, Cape Town',
                    foremanId: appData.workers[2].id,
                    active: true,
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateId(),
                    name: 'Sea Point, Cape Town',
                    foremanId: null,
                    active: true,
                    createdAt: new Date().toISOString()
                }
            ];

            // Sample site assignments
            appData.siteAssignments = [
                {
                    id: generateId(),
                    userId: appData.workers[0].id,
                    siteId: appData.sites[0].id,
                    startDate: new Date().toISOString(),
                    endDate: null,
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateId(),
                    userId: appData.workers[1].id,
                    siteId: appData.sites[0].id,
                    startDate: new Date().toISOString(),
                    endDate: null,
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateId(),
                    userId: appData.workers[2].id,
                    siteId: appData.sites[0].id,
                    startDate: new Date().toISOString(),
                    endDate: null,
                    createdAt: new Date().toISOString()
                }
            ];

            // Sample loans
            appData.loans = [
                {
                    id: generateId(),
                    userId: appData.workers[0].id,
                    date: new Date().toISOString(),
                    amount: 2000,
                    description: 'Advance for transport',
                    type: 'loan',
                    status: 'Pending',
                    deductInCurrent: true,
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateId(),
                    userId: appData.workers[1].id,
                    date: new Date().toISOString(),
                    amount: 1500,
                    description: 'Petty cash',
                    type: 'credit',
                    status: 'Pending',
                    deductInCurrent: false,
                    createdAt: new Date().toISOString()
                }
            ];

            // Sample expenses
            appData.expenses = [
                {
                    id: generateId(),
                    siteId: appData.sites[0].id,
                    date: new Date().toISOString(),
                    type: 'expense',
                    category: 'Petrol',
                    description: 'Fuel for site vehicle',
                    amount: 2500,
                    status: 'Paid',
                    enteredById: appData.workers[2].id,
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateId(),
                    siteId: appData.sites[0].id,
                    date: new Date().toISOString(),
                    type: 'income',
                    category: 'Other',
                    description: 'Client payment',
                    amount: 50000,
                    status: 'Paid',
                    enteredById: appData.workers[2].id,
                    createdAt: new Date().toISOString()
                }
            ];

            // Add some activity logs
            logActivity('System initialized with sample data', null, null);
            
            saveData();
        }

        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Log activity
        function logActivity(activity, userId, siteId) {
            appData.activityLog.unshift({
                id: generateId(),
                date: new Date().toISOString(),
                activity: activity,
                userId: userId,
                siteId: siteId
            });
            
            // Keep only last 100 activities
            if (appData.activityLog.length > 100) {
                appData.activityLog.pop();
            }
            
            saveData();
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        // Format currency
        function formatCurrency(amount) {
            return 'R ' + parseFloat(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-ZA', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }

        // Format date for display
        function formatDateOnly(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-ZA', {
                day: '2-digit',
                month: '2-digit'
            });
        }

        // Get worker name by ID
        function getWorkerName(workerId) {
            const worker = appData.workers.find(w => w.id === workerId);
            return worker ? `${worker.name} ${worker.surname}` : 'Unknown';
        }

        // Get site name by ID
        function getSiteName(siteId) {
            const site = appData.sites.find(s => s.id === siteId);
            return site ? site.name : 'Unknown Site';
        }

        // Get workers assigned to a site
        function getWorkersForSite(siteId) {
            const currentAssignments = appData.siteAssignments.filter(
                assignment => assignment.siteId === siteId && 
                assignment.endDate === null
            );
            
            return appData.workers.filter(worker => 
                currentAssignments.some(assignment => assignment.userId === worker.id) &&
                worker.active === true
            );
        }

        // Get fortnight dates
        function getFortnightDates(startDate) {
            const dates = [];
            const start = new Date(startDate);
            
            for (let i = 0; i < 14; i++) {
                const currentDate = new Date(start);
                currentDate.setDate(start.getDate() + i);
                dates.push(new Date(currentDate));
            }
            
            return dates;
        }

        // Calculate fortnight end date
        function getFortnightEnd(startDate) {
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 13);
            return endDate;
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ============================================
        // WORKER MANAGEMENT
        // ============================================

        // Render workers table
        function renderWorkersTable() {
            const tbody = document.getElementById('workersTableBody');
            tbody.innerHTML = '';
            
            appData.workers.forEach(worker => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${worker.idNumber}</td>
                    <td>${worker.name}</td>
                    <td>${worker.surname}</td>
                    <td>${worker.role}</td>
                    <td>${formatCurrency(worker.dailyRate)}</td>
                    <td>${worker.bankName}</td>
                    <td>${worker.accountNumber}</td>
                    <td>
                        <span class="${worker.active ? 'status-active' : 'status-inactive'}">
                            ${worker.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary edit-worker" data-id="${worker.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-worker" data-id="${worker.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-light assign-site" data-id="${worker.id}">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners for worker actions
            document.querySelectorAll('.edit-worker').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const workerId = e.target.closest('button').dataset.id;
                    editWorker(workerId);
                });
            });
            
            document.querySelectorAll('.delete-worker').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const workerId = e.target.closest('button').dataset.id;
                    if (confirm('Are you sure you want to delete this worker?')) {
                        deleteWorker(workerId);
                    }
                });
            });
            
            document.querySelectorAll('.assign-site').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const workerId = e.target.closest('button').dataset.id;
                    assignWorkerToSite(workerId);
                });
            });
        }

        // Add new worker
        function addWorker() {
            const worker = {
                id: generateId(),
                name: document.getElementById('workerName').value.trim(),
                surname: document.getElementById('workerSurname').value.trim(),
                idNumber: document.getElementById('workerId').value.trim(),
                phone: document.getElementById('workerPhone').value.trim(),
                role: document.getElementById('workerRole').value,
                dailyRate: parseFloat(document.getElementById('workerRate').value),
                bankName: document.getElementById('workerBank').value,
                accountNumber: document.getElementById('workerAccount').value.trim(),
                active: document.getElementById('workerActive').checked,
                createdAt: new Date().toISOString()
            };
            
            // Check for duplicate ID number
            if (appData.workers.some(w => w.idNumber === worker.idNumber)) {
                showToast('Worker with this ID number already exists', 'error');
                return;
            }
            
            appData.workers.push(worker);
            saveData();
            renderWorkersTable();
            updateDashboard();
            closeModal('workerModal');
            
            logActivity(`Added worker: ${worker.name} ${worker.surname}`, null, null);
            showToast('Worker added successfully');
        }

        // Edit existing worker
        function editWorker(workerId) {
            const worker = appData.workers.find(w => w.id === workerId);
            if (!worker) return;
            
            // Populate form
            document.getElementById('workerName').value = worker.name;
            document.getElementById('workerSurname').value = worker.surname;
            document.getElementById('workerId').value = worker.idNumber;
            document.getElementById('workerPhone').value = worker.phone;
            document.getElementById('workerRole').value = worker.role;
            document.getElementById('workerRate').value = worker.dailyRate;
            document.getElementById('workerBank').value = worker.bankName;
            document.getElementById('workerAccount').value = worker.accountNumber;
            document.getElementById('workerActive').checked = worker.active;
            document.getElementById('workerEditId').value = workerId;
            
            openModal('workerModal');
        }

        // Save worker (add or edit)
        function saveWorker() {
            const editId = document.getElementById('workerEditId').value;
            
            if (editId) {
                // Edit existing worker
                const workerIndex = appData.workers.findIndex(w => w.id === editId);
                if (workerIndex === -1) return;
                
                const worker = appData.workers[workerIndex];
                const originalIdNumber = worker.idNumber;
                const newIdNumber = document.getElementById('workerId').value.trim();
                
                // Check for duplicate ID number (if changed)
                if (newIdNumber !== originalIdNumber && 
                    appData.workers.some(w => w.idNumber === newIdNumber && w.id !== editId)) {
                    showToast('Another worker already has this ID number', 'error');
                    return;
                }
                
                // Update worker
                appData.workers[workerIndex] = {
                    ...worker,
                    name: document.getElementById('workerName').value.trim(),
                    surname: document.getElementById('workerSurname').value.trim(),
                    idNumber: newIdNumber,
                    phone: document.getElementById('workerPhone').value.trim(),
                    role: document.getElementById('workerRole').value,
                    dailyRate: parseFloat(document.getElementById('workerRate').value),
                    bankName: document.getElementById('workerBank').value,
                    accountNumber: document.getElementById('workerAccount').value.trim(),
                    active: document.getElementById('workerActive').checked
                };
                
                logActivity(`Updated worker: ${worker.name} ${worker.surname}`, null, null);
                showToast('Worker updated successfully');
            } else {
                // Add new worker
                addWorker();
                return;
            }
            
            saveData();
            renderWorkersTable();
            updateDashboard();
            closeModal('workerModal');
        }

        // Delete worker
        function deleteWorker(workerId) {
            const workerIndex = appData.workers.findIndex(w => w.id === workerId);
            if (workerIndex === -1) return;
            
            const worker = appData.workers[workerIndex];
            
            // Check if worker has any active assignments
            const activeAssignments = appData.siteAssignments.filter(
                assignment => assignment.userId === workerId && assignment.endDate === null
            );
            
            if (activeAssignments.length > 0) {
                if (!confirm('This worker is currently assigned to sites. Are you sure you want to delete?')) {
                    return;
                }
            }
            
            appData.workers.splice(workerIndex, 1);
            
            // Remove site assignments
            appData.siteAssignments = appData.siteAssignments.filter(
                assignment => assignment.userId !== workerId
            );
            
            saveData();
            renderWorkersTable();
            updateDashboard();
            
            logActivity(`Deleted worker: ${worker.name} ${worker.surname}`, null, null);
            showToast('Worker deleted successfully');
        }

        // Assign worker to site
        function assignWorkerToSite(workerId) {
            const worker = appData.workers.find(w => w.id === workerId);
            if (!worker) return;
            
            // Create a simple assignment interface
            let siteOptions = '<option value="">-- Select Site --</option>';
            appData.sites.forEach(site => {
                siteOptions += `<option value="${site.id}">${site.name}</option>`;
            });
            
            const assignmentHtml = `
                <h3>Assign ${worker.name} ${worker.surname} to Site</h3>
                <div class="form-group">
                    <label>Site</label>
                    <select id="assignSiteSelect" class="form-control">
                        ${siteOptions}
                    </select>
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="assignStartDate" class="form-control" value="${new Date().toISOString().split('T')[0]}">
                </div>
            `;
            
            if (confirm(`Assign ${worker.name} to a site?`)) {
                // Open a simple prompt
                const siteId = prompt('Enter site ID to assign worker to:');
                if (siteId) {
                    const site = appData.sites.find(s => s.id === siteId);
                    if (site) {
                        // Check if already assigned
                        const existingAssignment = appData.siteAssignments.find(
                            assignment => assignment.userId === workerId && 
                            assignment.siteId === siteId && 
                            assignment.endDate === null
                        );
                        
                        if (existingAssignment) {
                            showToast('Worker is already assigned to this site', 'warning');
                            return;
                        }
                        
                        // End any existing assignments
                        appData.siteAssignments.forEach(assignment => {
                            if (assignment.userId === workerId && assignment.endDate === null) {
                                assignment.endDate = new Date().toISOString();
                            }
                        });
                        
                        // Add new assignment
                        appData.siteAssignments.push({
                            id: generateId(),
                            userId: workerId,
                            siteId: siteId,
                            startDate: new Date().toISOString(),
                            endDate: null,
                            createdAt: new Date().toISOString()
                        });
                        
                        saveData();
                        showToast(`Assigned ${worker.name} to ${site.name}`);
                        logActivity(`Assigned ${worker.name} ${worker.surname} to ${site.name}`, null, siteId);
                    }
                }
            }
        }

        // Export workers to Excel
        function exportWorkersToExcel() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Headers
            const headers = ["Name", "Surname", "ID Number", "Phone", "Role", "Daily Rate", "Bank Name", "Account Number", "Active"];
            csvContent += headers.join(",") + "\n";
            
            // Data
            appData.workers.forEach(worker => {
                const row = [
                    worker.name,
                    worker.surname,
                    worker.idNumber,
                    worker.phone,
                    worker.role,
                    worker.dailyRate,
                    worker.bankName,
                    worker.accountNumber,
                    worker.active ? "Yes" : "No"
                ];
                csvContent += row.join(",") + "\n";
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "tonnylays_workers.csv");
            document.body.appendChild(link);
            
            link.click();
            document.body.removeChild(link);
            
            showToast('Workers exported to CSV file');
            logActivity('Exported workers to Excel', null, null);
        }

        // ============================================
        // SITE MANAGEMENT
        // ============================================

        // Render sites table
        function renderSitesTable() {
            const tbody = document.getElementById('sitesTableBody');
            tbody.innerHTML = '';
            
            // Update site dropdowns
            updateSiteDropdowns();
            
            appData.sites.forEach(site => {
                const assignedWorkers = getWorkersForSite(site.id).length;
                const foreman = site.foremanId ? getWorkerName(site.foremanId) : 'Not assigned';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${site.name}</td>
                    <td>${foreman}</td>
                    <td>${assignedWorkers}</td>
                    <td>
                        <span class="${site.active ? 'status-active' : 'status-inactive'}">
                            ${site.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>${formatDate(site.createdAt)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary edit-site" data-id="${site.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-site" data-id="${site.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-light view-site-workers" data-id="${site.id}">
                            <i class="fas fa-users"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.edit-site').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const siteId = e.target.closest('button').dataset.id;
                    editSite(siteId);
                });
            });
            
            document.querySelectorAll('.delete-site').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const siteId = e.target.closest('button').dataset.id;
                    if (confirm('Are you sure you want to delete this site?')) {
                        deleteSite(siteId);
                    }
                });
            });
            
            document.querySelectorAll('.view-site-workers').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const siteId = e.target.closest('button').dataset.id;
                    viewSiteWorkers(siteId);
                });
            });
        }

        // Add new site
        function addSite() {
            const site = {
                id: generateId(),
                name: document.getElementById('siteName').value.trim(),
                foremanId: document.getElementById('siteForeman').value || null,
                active: document.getElementById('siteActive').checked,
                createdAt: new Date().toISOString()
            };
            
            appData.sites.push(site);
            saveData();
            renderSitesTable();
            updateDashboard();
            closeModal('siteModal');
            
            logActivity(`Added site: ${site.name}`, null, site.id);
            showToast('Site added successfully');
        }

        // Edit site
        function editSite(siteId) {
            const site = appData.sites.find(s => s.id === siteId);
            if (!site) return;
            
            // Populate form
            document.getElementById('siteName').value = site.name;
            document.getElementById('siteForeman').value = site.foremanId || '';
            document.getElementById('siteActive').checked = site.active;
            document.getElementById('siteEditId').value = siteId;
            
            openModal('siteModal');
        }

        // Save site
        function saveSite() {
            const editId = document.getElementById('siteEditId').value;
            
            if (editId) {
                // Edit existing site
                const siteIndex = appData.sites.findIndex(s => s.id === editId);
                if (siteIndex === -1) return;
                
                const site = appData.sites[siteIndex];
                
                appData.sites[siteIndex] = {
                    ...site,
                    name: document.getElementById('siteName').value.trim(),
                    foremanId: document.getElementById('siteForeman').value || null,
                    active: document.getElementById('siteActive').checked
                };
                
                logActivity(`Updated site: ${site.name}`, null, site.id);
                showToast('Site updated successfully');
            } else {
                // Add new site
                addSite();
                return;
            }
            
            saveData();
            renderSitesTable();
            updateDashboard();
            closeModal('siteModal');
        }

        // Delete site
        function deleteSite(siteId) {
            const siteIndex = appData.sites.findIndex(s => s.id === siteId);
            if (siteIndex === -1) return;
            
            const site = appData.sites[siteIndex];
            
            // Check if site has workers assigned
            const assignedWorkers = getWorkersForSite(siteId).length;
            if (assignedWorkers > 0) {
                if (!confirm(`This site has ${assignedWorkers} workers assigned. Are you sure you want to delete?`)) {
                    return;
                }
            }
            
            appData.sites.splice(siteIndex, 1);
            
            // Remove site assignments
            appData.siteAssignments = appData.siteAssignments.filter(
                assignment => assignment.siteId !== siteId
            );
            
            saveData();
            renderSitesTable();
            updateDashboard();
            
            logActivity(`Deleted site: ${site.name}`, null, null);
            showToast('Site deleted successfully');
        }

        // View workers assigned to site
        function viewSiteWorkers(siteId) {
            const site = appData.sites.find(s => s.id === siteId);
            if (!site) return;
            
            const workers = getWorkersForSite(siteId);
            let workerList = `<h3>Workers at ${site.name}</h3>`;
            
            if (workers.length === 0) {
                workerList += '<p>No workers assigned to this site.</p>';
            } else {
                workerList += '<ul>';
                workers.forEach(worker => {
                    workerList += `<li>${worker.name} ${worker.surname} - ${worker.role}</li>`;
                });
                workerList += '</ul>';
            }
            
            alert(workerList);
        }

        // Update site dropdowns
        function updateSiteDropdowns() {
            const siteDropdowns = [
                'attendanceSite', 'payrollSite', 'expenseSiteFilter', 
                'noteSite', 'expenseSite', 'currentSiteSelect', 'dashboardSiteFilter'
            ];
            
            siteDropdowns.forEach(dropdownId => {
                const select = document.getElementById(dropdownId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '';
                    
                    if (dropdownId === 'expenseSiteFilter' || dropdownId === 'dashboardSiteFilter') {
                        select.innerHTML = '<option value="all">All Sites</option>';
                    } else if (dropdownId === 'attendanceSite' || dropdownId === 'expenseSite' || dropdownId === 'noteSite') {
                        select.innerHTML = '<option value="">-- Select Site --</option>';
                    }
                    
                    appData.sites.forEach(site => {
                        if (site.active) {
                            const option = document.createElement('option');
                            option.value = site.id;
                            option.textContent = site.name;
                            select.appendChild(option);
                        }
                    });
                    
                    // Try to restore previous value
                    if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                        select.value = currentValue;
                    }
                }
            });
        }

        // ============================================
        // ATTENDANCE MANAGEMENT
        // ============================================

        // Render attendance grid
        function renderAttendanceGrid() {
            const siteId = document.getElementById('attendanceSite').value;
            const startDate = document.getElementById('fortnightStart').value;
            
            if (!siteId || !startDate) {
                document.getElementById('attendanceGrid').innerHTML = `
                    <div class="text-center p-20">
                        <i class="fas fa-clipboard-list fa-3x" style="color: #ccc;"></i>
                        <h3>Select a site and fortnight to view attendance</h3>
                        <p>Use the controls above to get started</p>
                    </div>
                `;
                return;
            }
            
            const site = appData.sites.find(s => s.id === siteId);
            if (!site) return;
            
            const workers = getWorkersForSite(siteId);
            const dates = getFortnightDates(startDate);
            const endDate = getFortnightEnd(startDate);
            
            // Update end date display
            document.getElementById('fortnightEnd').value = endDate.toISOString().split('T')[0];
            
            // Create table header
            let html = `
                <table class="attendance-grid">
                    <thead>
                        <tr>
                            <th rowspan="2" style="min-width: 150px;">Worker Name</th>
                            <th rowspan="2">Role</th>
            `;
            
            // Add date headers
            dates.forEach((date, index) => {
                const dayName = date.toLocaleDateString('en-ZA', { weekday: 'short' });
                html += `
                    <th colspan="1" class="day-header">
                        <div>${dayName}</div>
                        <div class="date-header">${formatDateOnly(date.toISOString())}</div>
                    </th>
                `;
            });
            
            html += `
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Add worker rows
            workers.forEach(worker => {
                html += `<tr data-worker-id="${worker.id}">`;
                html += `<td style="text-align: left; padding-left: 15px;">${worker.name} ${worker.surname}</td>`;
                html += `<td>${worker.role}</td>`;
                
                // Add attendance cells
                dates.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    const attendanceRecord = appData.attendance.find(
                        record => record.userId === worker.id && 
                        record.siteId === siteId && 
                        record.date === dateStr
                    );
                    
                    let status = '';
                    let cellClass = '';
                    
                    if (attendanceRecord) {
                        status = attendanceRecord.status;
                        cellClass = status === 'P' ? 'present' : (status === 'A' ? 'absent' : '');
                    }
                    
                    html += `
                        <td class="attendance-cell ${cellClass}" 
                            data-worker-id="${worker.id}"
                            data-date="${dateStr}"
                            data-site="${siteId}"
                            data-status="${status || ''}">
                            ${status || ''}
                        </td>
                    `;
                });
                
                html += `</tr>`;
            });
            
            html += `</tbody></table>`;
            
            document.getElementById('attendanceGrid').innerHTML = html;
            
            // Add click handlers for attendance cells
            document.querySelectorAll('.attendance-cell').forEach(cell => {
                cell.addEventListener('click', function() {
                    toggleAttendance(this);
                });
            });
            
            // Update attendance summary
            updateAttendanceSummary();
        }

        // Toggle attendance status
        function toggleAttendance(cell) {
            const workerId = cell.dataset.workerId;
            const date = cell.dataset.date;
            const siteId = cell.dataset.site;
            let currentStatus = cell.dataset.status;
            
            // Cycle through statuses: empty -> P -> A -> empty
            let newStatus = '';
            if (currentStatus === '') {
                newStatus = 'P';
            } else if (currentStatus === 'P') {
                newStatus = 'A';
            }
            // else goes back to empty
                
            // Update cell display
            cell.dataset.status = newStatus;
            cell.textContent = newStatus;
            cell.className = 'attendance-cell';
            
            if (newStatus === 'P') {
                cell.classList.add('present');
            } else if (newStatus === 'A') {
                cell.classList.add('absent');
            }
            
            // Update or create attendance record
            const existingIndex = appData.attendance.findIndex(
                record => record.userId === workerId && 
                record.siteId === siteId && 
                record.date === date
            );
            
            if (newStatus === '') {
                // Remove record if status is empty
                if (existingIndex !== -1) {
                    appData.attendance.splice(existingIndex, 1);
                }
            } else {
                if (existingIndex !== -1) {
                    // Update existing record
                    appData.attendance[existingIndex].status = newStatus;
                } else {
                    // Create new record
                    appData.attendance.push({
                        id: generateId(),
                        userId: workerId,
                        siteId: siteId,
                        date: date,
                        status: newStatus,
                        notes: '',
                        createdAt: new Date().toISOString()
                    });
                }
            }
            
            saveData();
            updateAttendanceSummary();
            
            // Log activity
            const worker = appData.workers.find(w => w.id === workerId);
            if (worker) {
                logActivity(`Marked ${worker.name} as ${newStatus === 'P' ? 'Present' : 'Absent'} on ${formatDate(date)}`, null, siteId);
            }
        }

        // Update attendance summary
        function updateAttendanceSummary() {
            const siteId = document.getElementById('attendanceSite').value;
            const startDate = document.getElementById('fortnightStart').value;
            
            if (!siteId || !startDate) {
                document.getElementById('attendanceSummary').innerHTML = `
                    <p class="text-center">Select a site and fortnight to see summary</p>
                `;
                return;
            }
            
            const dates = getFortnightDates(startDate);
            const workers = getWorkersForSite(siteId);
            
            let totalPresent = 0;
            let totalAbsent = 0;
            let totalDays = workers.length * 14;
            
            // Calculate totals
            workers.forEach(worker => {
                dates.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    const record = appData.attendance.find(
                        r => r.userId === worker.id && 
                        r.siteId === siteId && 
                        r.date === dateStr
                    );
                    
                    if (record) {
                        if (record.status === 'P') totalPresent++;
                        if (record.status === 'A') totalAbsent++;
                    }
                });
            });
            
            const notMarked = totalDays - totalPresent - totalAbsent;
            const percentage = totalDays > 0 ? ((totalPresent / totalDays) * 100).toFixed(1) : 0;
            
            document.getElementById('attendanceSummary').innerHTML = `
                <div class="d-flex justify-between">
                    <div class="text-center">
                        <div class="stat-number" style="color: var(--success);">${totalPresent}</div>
                        <div class="stat-label">Present Days</div>
                    </div>
                    <div class="text-center">
                        <div class="stat-number" style="color: var(--danger);">${totalAbsent}</div>
                        <div class="stat-label">Absent Days</div>
                    </div>
                    <div class="text-center">
                        <div class="stat-number" style="color: var(--warning);">${notMarked}</div>
                        <div class="stat-label">Not Marked</div>
                    </div>
                    <div class="text-center">
                        <div class="stat-number">${percentage}%</div>
                        <div class="stat-label">Attendance Rate</div>
                    </div>
                </div>
            `;
        }

        // Save attendance
        function saveAttendance() {
            // Attendance is saved automatically when toggled
            showToast('Attendance saved automatically');
        }

        // Export attendance to PDF (simulated)
        function exportAttendanceToPDF() {
            const siteId = document.getElementById('attendanceSite').value;
            const startDate = document.getElementById('fortnightStart').value;
            
            if (!siteId || !startDate) {
                showToast('Please select a site and fortnight first', 'error');
                return;
            }
            
            const site = appData.sites.find(s => s.id === siteId);
            const siteName = site ? site.name : 'Unknown Site';
            
            // In a real app, this would generate a PDF
            // For now, we'll create a downloadable HTML file that looks like a PDF
            
            let pdfContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Attendance Report - ${siteName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #2c3e50; }
                        .header { margin-bottom: 30px; }
                        .info { margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                        th { background-color: #2c3e50; color: white; }
                        .present { background-color: #d4edda; }
                        .absent { background-color: #f8d7da; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Tonnylays Construction</h1>
                        <h2>Attendance Report</h2>
                    </div>
                    <div class="info">
                        <p><strong>Site:</strong> ${siteName}</p>
                        <p><strong>Fortnight:</strong> ${startDate} to ${document.getElementById('fortnightEnd').value}</p>
                        <p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
            `;
            
            // Get data for PDF
            const workers = getWorkersForSite(siteId);
            const dates = getFortnightDates(startDate);
            
            pdfContent += '<table>';
            pdfContent += '<tr><th>Worker</th><th>Role</th>';
            dates.forEach(date => {
                pdfContent += `<th>${formatDateOnly(date.toISOString())}</th>`;
            });
            pdfContent += '</tr>';
            
            workers.forEach(worker => {
                pdfContent += `<tr><td>${worker.name} ${worker.surname}</td><td>${worker.role}</td>`;
                
                dates.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    const record = appData.attendance.find(
                        r => r.userId === worker.id && 
                        r.siteId === siteId && 
                        r.date === dateStr
                    );
                    
                    const status = record ? record.status : '';
                    const cellClass = status === 'P' ? 'present' : (status === 'A' ? 'absent' : '');
                    
                    pdfContent += `<td class="${cellClass}">${status}</td>`;
                });
                
                pdfContent += '</tr>';
            });
            
            pdfContent += '</table></body></html>';
            
            // Create download link
            const blob = new Blob([pdfContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `attendance_${siteName.replace(/\s+/g, '_')}_${startDate}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Attendance report generated');
            logActivity('Exported attendance report', null, siteId);
        }

        // ============================================
        // PAYROLL MANAGEMENT
        // ============================================

        // Render payroll table
        function renderPayrollTable() {
            const tbody = document.getElementById('payrollTableBody');
            tbody.innerHTML = '';
            
            const siteId = document.getElementById('payrollSite').value;
            const startDate = document.getElementById('payrollFortnightStart').value;
            
            if (!siteId || !startDate) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center">
                            <i class="fas fa-calculator fa-2x" style="color: #ccc; margin: 20px 0;"></i>
                            <p>Select a site and fortnight to calculate payroll</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const site = appData.sites.find(s => s.id === siteId);
            if (!site) return;
            
            const workers = getWorkersForSite(siteId);
            const dates = getFortnightDates(startDate);
            const endDate = getFortnightEnd(startDate);
            
            workers.forEach(worker => {
                // Calculate days present
                let daysPresent = 0;
                dates.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    const record = appData.attendance.find(
                        r => r.userId === worker.id && 
                        r.siteId === siteId && 
                        r.date === dateStr
                    );
                    
                    if (record && record.status === 'P') {
                        daysPresent++;
                    }
                });
                
                // Calculate gross pay
                const grossPay = daysPresent * worker.dailyRate;
                
                // Calculate loans (they owe us)
                const loans = appData.loans.filter(
                    loan => loan.userId === worker.id && 
                    loan.type === 'loan' && 
                    loan.status === 'Pending' &&
                    loan.deductInCurrent === true
                ).reduce((sum, loan) => sum + loan.amount, 0);
                
                // Calculate credit (we owe them)
                const credit = appData.loans.filter(
                    loan => loan.userId === worker.id && 
                    loan.type === 'credit' && 
                    loan.status === 'Pending'
                ).reduce((sum, loan) => sum + loan.amount, 0);
                
                // Calculate net pay
                const netPay = grossPay - loans + credit;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${worker.name} ${worker.surname}</td>
                    <td>${daysPresent}</td>
                    <td>${formatCurrency(worker.dailyRate)}</td>
                    <td>${formatCurrency(grossPay)}</td>
                    <td>${formatCurrency(loans)}</td>
                    <td>${formatCurrency(credit)}</td>
                    <td>${formatCurrency(netPay)}</td>
                    <td>${worker.bankName}</td>
                    <td>${worker.accountNumber}</td>
                    <td>
                        <button class="btn btn-sm btn-light view-details" data-worker-id="${worker.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.view-details').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const workerId = e.target.closest('button').dataset.workerId;
                    viewPayrollDetails(workerId, siteId, startDate);
                });
            });
        }

        // View payroll details
        function viewPayrollDetails(workerId, siteId, startDate) {
            const worker = appData.workers.find(w => w.id === workerId);
            if (!worker) return;
            
            const dates = getFortnightDates(startDate);
            
            // Calculate attendance
            let attendanceDetails = '';
            dates.forEach(date => {
                const dateStr = date.toISOString().split('T')[0];
                const record = appData.attendance.find(
                    r => r.userId === workerId && 
                    r.siteId === siteId && 
                    r.date === dateStr
                );
                
                const status = record ? record.status : '-';
                attendanceDetails += `${formatDateOnly(dateStr)}: ${status}\n`;
            });
            
            // Get loans
            const loans = appData.loans.filter(
                loan => loan.userId === workerId && 
                loan.type === 'loan' && 
                loan.status === 'Pending'
            );
            
            let loansDetails = '';
            loans.forEach(loan => {
                loansDetails += `${formatCurrency(loan.amount)} - ${loan.description}\n`;
            });
            
            // Get credits
            const credits = appData.loans.filter(
                loan => loan.userId === workerId && 
                loan.type === 'credit' && 
                loan.status === 'Pending'
            );
            
            let creditsDetails = '';
            credits.forEach(credit => {
                creditsDetails += `${formatCurrency(credit.amount)} - ${credit.description}\n`;
            });
            
            const message = `
                Payroll Details for ${worker.name} ${worker.surname}
                
                Attendance:
                ${attendanceDetails}
                
                Pending Loans:
                ${loansDetails || 'None'}
                
                Pending Credits:
                ${creditsDetails || 'None'}
            `;
            
            alert(message);
        }

        // Generate payroll
        function generatePayroll() {
            renderPayrollTable();
            showToast('Payroll calculated');
        }

        // Export payroll to PDF
        function exportPayrollToPDF() {
            const siteId = document.getElementById('payrollSite').value;
            const startDate = document.getElementById('payrollFortnightStart').value;
            
            if (!siteId || !startDate) {
                showToast('Please select a site and fortnight first', 'error');
                return;
            }
            
            const site = appData.sites.find(s => s.id === siteId);
            const siteName = site ? site.name : 'Unknown Site';
            const workers = getWorkersForSite(siteId);
            const dates = getFortnightDates(startDate);
            const endDate = getFortnightEnd(startDate);
            
            // Calculate totals
            let totalGross = 0;
            let totalLoans = 0;
            let totalCredit = 0;
            let totalNet = 0;
            
            workers.forEach(worker => {
                // Calculate days present
                let daysPresent = 0;
                dates.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    const record = appData.attendance.find(
                        r => r.userId === worker.id && 
                        r.siteId === siteId && 
                        r.date === dateStr
                    );
                    
                    if (record && record.status === 'P') {
                        daysPresent++;
                    }
                });
                
                const grossPay = daysPresent * worker.dailyRate;
                const loans = appData.loans.filter(
                    loan => loan.userId === worker.id && 
                    loan.type === 'loan' && 
                    loan.status === 'Pending' &&
                    loan.deductInCurrent === true
                ).reduce((sum, loan) => sum + loan.amount, 0);
                
                const credit = appData.loans.filter(
                    loan => loan.userId === worker.id && 
                    loan.type === 'credit' && 
                    loan.status === 'Pending'
                ).reduce((sum, loan) => sum + loan.amount, 0);
                
                const netPay = grossPay - loans + credit;
                
                totalGross += grossPay;
                totalLoans += loans;
                totalCredit += credit;
                totalNet += netPay;
            });
            
            // Create PDF content
            let pdfContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Payroll Report - ${siteName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #2c3e50; }
                        .header { margin-bottom: 30px; }
                        .info { margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #2c3e50; color: white; }
                        .totals { margin-top: 30px; font-weight: bold; }
                        .footer { margin-top: 50px; font-size: 0.9em; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Tonnylays Construction</h1>
                        <h2>Payroll Report</h2>
                    </div>
                    <div class="info">
                        <p><strong>Site:</strong> ${siteName}</p>
                        <p><strong>Fortnight:</strong> ${startDate} to ${endDate.toISOString().split('T')[0]}</p>
                        <p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Days</th>
                                <th>Rate</th>
                                <th>Gross Pay</th>
                                <th>Loan</th>
                                <th>Credit</th>
                                <th>Net Pay</th>
                                <th>Bank Name</th>
                                <th>Account No.</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            workers.forEach(worker => {
                // Calculate for each worker
                let daysPresent = 0;
                dates.forEach(date => {
                    const dateStr = date.toISOString().split('T')[0];
                    const record = appData.attendance.find(
                        r => r.userId === worker.id && 
                        r.siteId === siteId && 
                        r.date === dateStr
                    );
                    
                    if (record && record.status === 'P') {
                        daysPresent++;
                    }
                });
                
                const grossPay = daysPresent * worker.dailyRate;
                const loans = appData.loans.filter(
                    loan => loan.userId === worker.id && 
                    loan.type === 'loan' && 
                    loan.status === 'Pending' &&
                    loan.deductInCurrent === true
                ).reduce((sum, loan) => sum + loan.amount, 0);
                
                const credit = appData.loans.filter(
                    loan => loan.userId === worker.id && 
                    loan.type === 'credit' && 
                    loan.status === 'Pending'
                ).reduce((sum, loan) => sum + loan.amount, 0);
                
                const netPay = grossPay - loans + credit;
                
                if (daysPresent > 0) {
                    pdfContent += `
                        <tr>
                            <td>${worker.name} ${worker.surname}</td>
                            <td>${daysPresent}</td>
                            <td>R ${worker.dailyRate.toFixed(2)}</td>
                            <td>R ${grossPay.toFixed(2)}</td>
                            <td>R ${loans.toFixed(2)}</td>
                            <td>R ${credit.toFixed(2)}</td>
                            <td>R ${netPay.toFixed(2)}</td>
                            <td>${worker.bankName}</td>
                            <td>${worker.accountNumber}</td>
                        </tr>
                    `;
                }
            });
            
            pdfContent += `
                        </tbody>
                        <tfoot>
                            <tr class="totals">
                                <td colspan="3">TOTALS:</td>
                                <td>R ${totalGross.toFixed(2)}</td>
                                <td>R ${totalLoans.toFixed(2)}</td>
                                <td>R ${totalCredit.toFixed(2)}</td>
                                <td>R ${totalNet.toFixed(2)}</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                    <div class="footer">
                        <p>Generated by Tonnylays Construction Management System</p>
                        <p>This is a computer-generated document. No signature required.</p>
                    </div>
                </body>
                </html>
            `;
            
            // Create download link
            const blob = new Blob([pdfContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `payroll_${siteName.replace(/\s+/g, '_')}_${startDate}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Payroll report generated');
            logActivity('Exported payroll report', null, siteId);
        }

        // ============================================
        // LOANS & CREDIT MANAGEMENT
        // ============================================

        // Render loans table
        function renderLoansTable(filterType = 'all') {
            const tbody = document.getElementById('loansTableBody');
            tbody.innerHTML = '';
            
            let filteredLoans = appData.loans;
            
            if (filterType !== 'all') {
                filteredLoans = appData.loans.filter(loan => loan.type === filterType);
            }
            
            // Sort by date (newest first)
            filteredLoans.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            filteredLoans.forEach(loan => {
                const worker = appData.workers.find(w => w.id === loan.userId);
                const workerName = worker ? `${worker.name} ${worker.surname}` : 'Unknown';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(loan.date)}</td>
                    <td>${workerName}</td>
                    <td>
                        <span class="${loan.type === 'loan' ? 'status-active' : 'status-inactive'}">
                            ${loan.type === 'loan' ? 'Loan' : 'Credit'}
                        </span>
                    </td>
                    <td>${formatCurrency(loan.amount)}</td>
                    <td>${loan.description}</td>
                    <td>
                        <span class="${loan.status === 'Pending' ? 'status-inactive' : 'status-active'}">
                            ${loan.status}
                        </span>
                    </td>
                    <td>
                        <span class="${loan.deductInCurrent ? 'status-active' : ''}">
                            ${loan.deductInCurrent ? 'Yes' : 'No'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary edit-loan" data-id="${loan.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-loan" data-id="${loan.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-light toggle-deduct" data-id="${loan.id}">
                            <i class="fas ${loan.deductInCurrent ? 'fa-toggle-on' : 'fa-toggle-off'}"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.edit-loan').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const loanId = e.target.closest('button').dataset.id;
                    editLoan(loanId);
                });
            });
            
            document.querySelectorAll('.delete-loan').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const loanId = e.target.closest('button').dataset.id;
                    if (confirm('Are you sure you want to delete this loan/credit record?')) {
                        deleteLoan(loanId);
                    }
                });
            });
            
            document.querySelectorAll('.toggle-deduct').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const loanId = e.target.closest('button').dataset.id;
                    toggleLoanDeduction(loanId);
                });
            });
        }

        // Add new loan/credit
        function addLoan() {
            const loan = {
                id: generateId(),
                userId: document.getElementById('loanWorker').value,
                date: document.getElementById('loanDate').value,
                amount: parseFloat(document.getElementById('loanAmount').value),
                description: document.getElementById('loanDescription').value.trim(),
                type: document.getElementById('loanType').value,
                status: document.getElementById('loanStatus').value,
                deductInCurrent: document.getElementById('loanDeductNext').checked,
                createdAt: new Date().toISOString()
            };
            
            appData.loans.push(loan);
            saveData();
            renderLoansTable();
            closeModal('loanModal');
            
            const worker = appData.workers.find(w => w.id === loan.userId);
            const workerName = worker ? `${worker.name} ${worker.surname}` : 'Unknown';
            
            logActivity(`Added ${loan.type} for ${workerName}: ${formatCurrency(loan.amount)}`, null, null);
            showToast(`${loan.type === 'loan' ? 'Loan' : 'Credit'} added successfully`);
        }

        // Edit loan/credit
        function editLoan(loanId) {
            const loan = appData.loans.find(l => l.id === loanId);
            if (!loan) return;
            
            // Populate form
            document.getElementById('loanWorker').value = loan.userId;
            document.getElementById('loanDate').value = loan.date.split('T')[0];
            document.getElementById('loanAmount').value = loan.amount;
            document.getElementById('loanDescription').value = loan.description;
            document.getElementById('loanStatus').value = loan.status;
            document.getElementById('loanDeductNext').checked = loan.deductInCurrent;
            document.getElementById('loanType').value = loan.type;
            document.getElementById('loanEditId').value = loanId;
            
            // Set active loan type button
            document.querySelectorAll('[data-loan-type]').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.loanType === loan.type) {
                    btn.classList.add('active');
                }
            });
            
            openModal('loanModal');
        }

        // Save loan
        function saveLoan() {
            const editId = document.getElementById('loanEditId').value;
            
            if (editId) {
                // Edit existing loan
                const loanIndex = appData.loans.findIndex(l => l.id === editId);
                if (loanIndex === -1) return;
                
                const loan = appData.loans[loanIndex];
                
                appData.loans[loanIndex] = {
                    ...loan,
                    userId: document.getElementById('loanWorker').value,
                    date: document.getElementById('loanDate').value,
                    amount: parseFloat(document.getElementById('loanAmount').value),
                    description: document.getElementById('loanDescription').value.trim(),
                    type: document.getElementById('loanType').value,
                    status: document.getElementById('loanStatus').value,
                    deductInCurrent: document.getElementById('loanDeductNext').checked
                };
                
                const worker = appData.workers.find(w => w.id === loan.userId);
                const workerName = worker ? `${worker.name} ${worker.surname}` : 'Unknown';
                
                logActivity(`Updated ${loan.type} for ${workerName}`, null, null);
                showToast(`${loan.type === 'loan' ? 'Loan' : 'Credit'} updated successfully`);
            } else {
                // Add new loan
                addLoan();
                return;
            }
            
            saveData();
            renderLoansTable();
            closeModal('loanModal');
        }

        // Delete loan
        function deleteLoan(loanId) {
            const loanIndex = appData.loans.findIndex(l => l.id === loanId);
            if (loanIndex === -1) return;
            
            const loan = appData.loans[loanIndex];
            appData.loans.splice(loanIndex, 1);
            
            saveData();
            renderLoansTable();
            
            const worker = appData.workers.find(w => w.id === loan.userId);
            const workerName = worker ? `${worker.name} ${worker.surname}` : 'Unknown';
            
            logActivity(`Deleted ${loan.type} for ${workerName}`, null, null);
            showToast(`${loan.type === 'loan' ? 'Loan' : 'Credit'} deleted successfully`);
        }

        // Toggle loan deduction
        function toggleLoanDeduction(loanId) {
            const loanIndex = appData.loans.findIndex(l => l.id === loanId);
            if (loanIndex === -1) return;
            
            appData.loans[loanIndex].deductInCurrent = !appData.loans[loanIndex].deductInCurrent;
            
            saveData();
            renderLoansTable();
            
            showToast(`Deduction setting updated`);
        }

        // Update worker dropdown for loans
        function updateWorkerDropdowns() {
            const workerDropdowns = ['loanWorker', 'siteForeman'];
            
            workerDropdowns.forEach(dropdownId => {
                const select = document.getElementById(dropdownId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '';
                    
                    if (dropdownId === 'loanWorker') {
                        select.innerHTML = '<option value="">-- Select Worker --</option>';
                    } else if (dropdownId === 'siteForeman') {
                        select.innerHTML = '<option value="">-- Select Foreman --</option>';
                    }
                    
                    appData.workers.forEach(worker => {
                        if (worker.active) {
                            const option = document.createElement('option');
                            option.value = worker.id;
                            option.textContent = `${worker.name} ${worker.surname} (${worker.role})`;
                            select.appendChild(option);
                        }
                    });
                    
                    // Try to restore previous value
                    if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                        select.value = currentValue;
                    }
                }
            });
        }

        // ============================================
        // EXPENSES & INCOME MANAGEMENT
        // ============================================

        // Render expenses table
        function renderExpensesTable() {
            const tbody = document.getElementById('expensesTableBody');
            tbody.innerHTML = '';
            
            const siteFilter = document.getElementById('expenseSiteFilter').value;
            const typeFilter = document.getElementById('expenseTypeFilter').value;
            const periodFilter = document.getElementById('expensePeriodFilter').value;
            const startDate = document.getElementById('expenseCustomStart').value;
            const endDate = document.getElementById('expenseCustomEnd').value;
            
            let filteredExpenses = appData.expenses;
            
            // Apply filters
            if (siteFilter !== 'all') {
                filteredExpenses = filteredExpenses.filter(expense => expense.siteId === siteFilter);
            }
            
            if (typeFilter !== 'all') {
                filteredExpenses = filteredExpenses.filter(expense => expense.type === typeFilter);
            }
            
            // Apply period filter
            const now = new Date();
            let periodStart, periodEnd;
            
            switch (periodFilter) {
                case 'today':
                    periodStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    periodEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    break;
                case 'fortnight':
                    periodStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 13);
                    periodEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    break;
                case 'month':
                    periodStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    periodEnd = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    break;
                case 'year':
                    periodStart = new Date(now.getFullYear(), 0, 1);
                    periodEnd = new Date(now.getFullYear() + 1, 0, 1);
                    break;
                case 'all':
                    // No date filtering
                    break;
                default:
                    // Custom date range
                    if (startDate && endDate) {
                        periodStart = new Date(startDate);
                        periodEnd = new Date(endDate);
                        periodEnd.setDate(periodEnd.getDate() + 1);
                    }
            }
            
            if (periodStart && periodEnd) {
                filteredExpenses = filteredExpenses.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= periodStart && expenseDate < periodEnd;
                });
            }
            
            // Sort by date (newest first)
            filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Calculate totals
            let totalIncome = 0;
            let totalExpenses = 0;
            
            filteredExpenses.forEach(expense => {
                if (expense.type === 'income') {
                    totalIncome += expense.amount;
                } else {
                    totalExpenses += expense.amount;
                }
            });
            
            const netBalance = totalIncome - totalExpenses;
            
            // Update summary
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('netBalance').textContent = formatCurrency(netBalance);
            
            // Render table
            filteredExpenses.forEach(expense => {
                const site = appData.sites.find(s => s.id === expense.siteId);
                const siteName = site ? site.name : 'N/A';
                const enteredBy = appData.workers.find(w => w.id === expense.enteredById);
                const enteredByName = enteredBy ? `${enteredBy.name} ${enteredBy.surname}` : 'System';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(expense.date)}</td>
                    <td>${siteName}</td>
                    <td>
                        <span class="${expense.type === 'income' ? 'status-active' : 'status-inactive'}">
                            ${expense.type === 'income' ? 'Income' : 'Expense'}
                        </span>
                    </td>
                    <td>${expense.category}</td>
                    <td>${expense.description}</td>
                    <td>${formatCurrency(expense.amount)}</td>
                    <td>${enteredByName}</td>
                    <td>
                        <span class="${expense.status === 'Paid' ? 'status-active' : 'status-inactive'}">
                            ${expense.status}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary edit-expense" data-id="${expense.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-expense" data-id="${expense.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners
            document.querySelectorAll('.edit-expense').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const expenseId = e.target.closest('button').dataset.id;
                    editExpense(expenseId);
                });
            });
            
            document.querySelectorAll('.delete-expense').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const expenseId = e.target.closest('button').dataset.id;
                    if (confirm('Are you sure you want to delete this expense/income record?')) {
                        deleteExpense(expenseId);
                    }
                });
            });
        }

        // Add expense/income
        function addExpense(type) {
            const expense = {
                id: generateId(),
                siteId: document.getElementById('expenseSite').value || null,
                date: document.getElementById('expenseDate').value,
                type: type,
                category: document.getElementById('expenseCategory').value,
                description: document.getElementById('expenseDescription').value.trim(),
                amount: parseFloat(document.getElementById('expenseAmount').value),
                status: document.getElementById('expenseStatus').value,
                enteredById: 'system', // In a real app, this would be the logged-in user
                createdAt: new Date().toISOString()
            };
            
            appData.expenses.push(expense);
            saveData();
            renderExpensesTable();
            closeModal('expenseModal');
            
            logActivity(`Added ${type}: ${expense.description} (${formatCurrency(expense.amount)})`, null, expense.siteId);
            showToast(`${type === 'income' ? 'Income' : 'Expense'} added successfully`);
        }

        // Edit expense/income
        function editExpense(expenseId) {
            const expense = appData.expenses.find(e => e.id === expenseId);
            if (!expense) return;
            
            // Populate form
            document.getElementById('expenseType').value = expense.type;
            document.getElementById('expenseDate').value = expense.date.split('T')[0];
            document.getElementById('expenseSite').value = expense.siteId || '';
            document.getElementById('expenseCategory').value = expense.category;
            document.getElementById('expenseDescription').value = expense.description;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseStatus').value = expense.status;
            document.getElementById('expenseEditId').value = expenseId;
            
            // Update modal title
            document.getElementById('expenseModalTitle').textContent = `Edit ${expense.type === 'income' ? 'Income' : 'Expense'}`;
            
            openModal('expenseModal');
        }

        // Save expense/income
        function saveExpense() {
            const editId = document.getElementById('expenseEditId').value;
            
            if (editId) {
                // Edit existing expense
                const expenseIndex = appData.expenses.findIndex(e => e.id === editId);
                if (expenseIndex === -1) return;
                
                const expense = appData.expenses[expenseIndex];
                
                appData.expenses[expenseIndex] = {
                    ...expense,
                    siteId: document.getElementById('expenseSite').value || null,
                    date: document.getElementById('expenseDate').value,
                    type: document.getElementById('expenseType').value,
                    category: document.getElementById('expenseCategory').value,
                    description: document.getElementById('expenseDescription').value.trim(),
                    amount: parseFloat(document.getElementById('expenseAmount').value),
                    status: document.getElementById('expenseStatus').value
                };
                
                logActivity(`Updated ${expense.type}: ${expense.description}`, null, expense.siteId);
                showToast(`${expense.type === 'income' ? 'Income' : 'Expense'} updated successfully`);
            } else {
                // Add new expense
                const type = document.getElementById('expenseType').value;
                addExpense(type);
                return;
            }
            
            saveData();
            renderExpensesTable();
            closeModal('expenseModal');
        }

        // Delete expense
        function deleteExpense(expenseId) {
            const expenseIndex = appData.expenses.findIndex(e => e.id === expenseId);
            if (expenseIndex === -1) return;
            
            const expense = appData.expenses[expenseIndex];
            appData.expenses.splice(expenseIndex, 1);
            
            saveData();
            renderExpensesTable();
            
            logActivity(`Deleted ${expense.type}: ${expense.description}`, null, expense.siteId);
            showToast(`${expense.type === 'income' ? 'Income' : 'Expense'} deleted successfully`);
        }

        // ============================================
        // DASHBOARD
        // ============================================

        // Update dashboard
        function updateDashboard() {
            // Update worker count
            const activeWorkers = appData.workers.filter(w => w.active).length;
            document.getElementById('totalWorkers').textContent = activeWorkers;
            
            // Get selected site for dashboard
            const selectedSiteId = document.getElementById('dashboardSiteFilter').value;
            const selectedDate = document.getElementById('dashboardDateFilter').value || new Date().toISOString().split('T')[0];
            
            // Calculate today's attendance
            let presentToday = 0;
            let absentToday = 0;
            let notMarkedToday = 0;
            
            if (selectedSiteId === 'all') {
                // All sites
                appData.sites.forEach(site => {
                    if (site.active) {
                        const workers = getWorkersForSite(site.id);
                        workers.forEach(worker => {
                            const attendance = appData.attendance.find(
                                a => a.userId === worker.id && 
                                a.siteId === site.id && 
                                a.date === selectedDate
                            );
                            
                            if (attendance) {
                                if (attendance.status === 'P') presentToday++;
                                if (attendance.status === 'A') absentToday++;
                            } else {
                                notMarkedToday++;
                            }
                        });
                    }
                });
            } else {
                // Specific site
                const workers = getWorkersForSite(selectedSiteId);
                workers.forEach(worker => {
                    const attendance = appData.attendance.find(
                        a => a.userId === worker.id && 
                        a.siteId === selectedSiteId && 
                        a.date === selectedDate
                    );
                    
                    if (attendance) {
                        if (attendance.status === 'P') presentToday++;
                        if (attendance.status === 'A') absentToday++;
                    } else {
                        notMarkedToday++;
                    }
                });
            }
            
            document.getElementById('presentToday').textContent = presentToday;
            document.getElementById('absentToday').textContent = absentToday;
            document.getElementById('notMarkedToday').textContent = notMarkedToday;
            
            // Update role breakdown
            updateRoleBreakdown(selectedSiteId);
            
            // Update recent activity
            updateRecentActivity();
        }

        // Update role breakdown
        function updateRoleBreakdown(siteId) {
            const container = document.getElementById('roleBreakdown');
            container.innerHTML = '';
            
            if (siteId === 'all' || !siteId) {
                container.innerHTML = '<p class="text-center">Select a site to see role breakdown</p>';
                return;
            }
            
            const workers = getWorkersForSite(siteId);
            const roles = {};
            
            // Group workers by role
            workers.forEach(worker => {
                if (!roles[worker.role]) {
                    roles[worker.role] = {
                        workers: [],
                        totalSalary: 0
                    };
                }
                roles[worker.role].workers.push(worker);
                
                // Calculate salary for this fortnight (assuming 10 working days as average)
                const avgWorkingDays = 10;
                roles[worker.role].totalSalary += worker.dailyRate * avgWorkingDays;
            });
            
            // Create role cards
            for (const [role, data] of Object.entries(roles)) {
                const card = document.createElement('div');
                card.className = 'role-card';
                card.innerHTML = `
                    <div class="role-title">
                        <span>${role}s</span>
                        <span>${formatCurrency(data.totalSalary)}</span>
                    </div>
                    <p><strong>${data.workers.length}</strong> workers</p>
                    <p>Avg. daily rate: ${formatCurrency(data.workers.reduce((sum, w) => sum + w.dailyRate, 0) / data.workers.length)}</p>
                `;
                container.appendChild(card);
            }
        }

        // Update recent activity
        function updateRecentActivity() {
            const tbody = document.getElementById('recentActivityBody');
            tbody.innerHTML = '';
            
            // Show last 10 activities
            const recentActivities = appData.activityLog.slice(0, 10);
            
            recentActivities.forEach(activity => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(activity.date)}</td>
                    <td>${activity.activity}</td>
                    <td>${activity.userId ? getWorkerName(activity.userId) : 'System'}</td>
                    <td>${activity.siteId ? getSiteName(activity.siteId) : 'N/A'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // ============================================
        // BACKUP & RESTORE
        // ============================================

        // Show backup modal
        function showBackupModal() {
            document.getElementById('backupData').value = JSON.stringify(appData, null, 2);
            openModal('backupModal');
        }

        // Download backup
        function downloadBackup() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `tonnylays_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Backup downloaded successfully');
            logActivity('Downloaded system backup', null, null);
        }

        // Restore from backup
        function restoreBackup() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backupData = JSON.parse(event.target.result);
                        
                        // Basic validation
                        if (!backupData.workers || !backupData.sites) {
                            showToast('Invalid backup file format', 'error');
                            return;
                        }
                        
                        if (confirm('This will replace all current data. Are you sure?')) {
                            appData = backupData;
                            saveData();
                            updateAllUI();
                            showToast('Data restored successfully');
                            logActivity('Restored system from backup', null, null);
                        }
                    } catch (error) {
                        showToast('Error reading backup file: ' + error.message, 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            fileInput.click();
        }

        // ============================================
        // MODAL MANAGEMENT
        // ============================================

        // Open modal
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            
            // Reset form if it exists
            const form = document.querySelector(`#${modalId} form`);
            if (form) {
                form.reset();
            }
            
            // Clear edit IDs
            document.getElementById('workerEditId') && (document.getElementById('workerEditId').value = '');
            document.getElementById('loanEditId') && (document.getElementById('loanEditId').value = '');
            document.getElementById('expenseEditId') && (document.getElementById('expenseEditId').value = '');
            document.getElementById('siteEditId') && (document.getElementById('siteEditId').value = '');
            document.getElementById('noteEditId') && (document.getElementById('noteEditId').value = '');
        }

        // ============================================
        // UI INITIALIZATION
        // ============================================

        // Update all UI components
        function updateAllUI() {
            renderWorkersTable();
            renderSitesTable();
            renderAttendanceGrid();
            renderPayrollTable();
            renderLoansTable();
            renderExpensesTable();
            updateDashboard();
            updateWorkerDropdowns();
            updateSiteDropdowns();
        }

        // Set default dates
        function setDefaultDates() {
            const today = new Date();
            const fortnightStart = new Date(today);
            
            // Set to Monday of current week
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is Sunday
            fortnightStart.setDate(diff);
            
            const formattedDate = fortnightStart.toISOString().split('T')[0];
            
            document.getElementById('fortnightStart').value = formattedDate;
            document.getElementById('payrollFortnightStart').value = formattedDate;
            document.getElementById('dashboardDateFilter').value = today.toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today.toISOString().split('T')[0];
            document.getElementById('loanDate').value = today.toISOString().split('T')[0];
            document.getElementById('noteDate').value = today.toISOString().split('T')[0];
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Show corresponding content
                    const tabId = this.dataset.tab;
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Close modal buttons
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    modal.classList.remove('active');
                });
            });
            
            // Click outside modal to close
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
            
            // Worker management
            document.getElementById('addWorkerBtn').addEventListener('click', () => {
                document.getElementById('workerEditId').value = '';
                openModal('workerModal');
            });
            
            document.getElementById('saveWorkerBtn').addEventListener('click', saveWorker);
            
            // Site management
            document.getElementById('addSiteBtn').addEventListener('click', () => {
                document.getElementById('siteEditId').value = '';
                openModal('siteModal');
            });
            
            document.getElementById('saveSiteBtn').addEventListener('click', saveSite);
            
            // Loan management
            document.getElementById('addLoanBtn').addEventListener('click', () => {
                document.getElementById('loanEditId').value = '';
                openModal('loanModal');
            });
            
            document.getElementById('saveLoanBtn').addEventListener('click', saveLoan);
            
            // Loan type buttons
            document.querySelectorAll('[data-loan-type]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-loan-type]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('loanType').value = this.dataset.loanType;
                });
            });
            
            // Loan type filter
            document.querySelectorAll('#loanTypeFilter .loan-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#loanTypeFilter .loan-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const filterType = this.dataset.type;
                    renderLoansTable(filterType);
                });
            });
            
            // Expense management
            document.getElementById('addExpenseBtn').addEventListener('click', () => {
                document.getElementById('expenseModalTitle').textContent = 'Add Expense';
                document.getElementById('expenseType').value = 'expense';
                document.getElementById('expenseEditId').value = '';
                openModal('expenseModal');
            });
            
            document.getElementById('addIncomeBtn').addEventListener('click', () => {
                document.getElementById('expenseModalTitle').textContent = 'Add Income';
                document.getElementById('expenseType').value = 'income';
                document.getElementById('expenseEditId').value = '';
                openModal('expenseModal');
            });
            
            document.getElementById('saveExpenseBtn').addEventListener('click', saveExpense);
            
            // Note management
            document.getElementById('addNoteBtn').addEventListener('click', () => {
                document.getElementById('noteEditId').value = '';
                openModal('noteModal');
            });
            
            document.getElementById('saveNoteBtn').addEventListener('click', () => {
                // Note functionality would be added here
                showToast('Note functionality to be implemented');
                closeModal('noteModal');
            });
            
            // Attendance
            document.getElementById('attendanceSite').addEventListener('change', renderAttendanceGrid);
            document.getElementById('fortnightStart').addEventListener('change', renderAttendanceGrid);
            document.getElementById('saveAttendanceBtn').addEventListener('click', saveAttendance);
            document.getElementById('exportAttendanceBtn').addEventListener('click', exportAttendanceToPDF);
            
            // Payroll
            document.getElementById('payrollSite').addEventListener('change', renderPayrollTable);
            document.getElementById('payrollFortnightStart').addEventListener('change', renderPayrollTable);
            document.getElementById('generatePayrollBtn').addEventListener('click', generatePayroll);
            document.getElementById('exportPayrollBtn').addEventListener('click', exportPayrollToPDF);
            
            // Expenses filters
            document.getElementById('expenseSiteFilter').addEventListener('change', renderExpensesTable);
            document.getElementById('expenseTypeFilter').addEventListener('change', renderExpensesTable);
            document.getElementById('expensePeriodFilter').addEventListener('change', renderExpensesTable);
            document.getElementById('expenseCustomStart').addEventListener('change', renderExpensesTable);
            document.getElementById('expenseCustomEnd').addEventListener('change', renderExpensesTable);
            
            // Dashboard filters
            document.getElementById('dashboardSiteFilter').addEventListener('change', updateDashboard);
            document.getElementById('dashboardDateFilter').addEventListener('change', updateDashboard);
            
            // Backup/Restore
            document.getElementById('backupBtn').addEventListener('click', showBackupModal);
            document.getElementById('restoreBtn').addEventListener('click', restoreBackup);
            document.getElementById('downloadBackupBtn').addEventListener('click', downloadBackup);
            document.getElementById('uploadBackupBtn').addEventListener('click', () => {
                // Trigger file input for restore
                restoreBackup();
                closeModal('backupModal');
            });
            
            // Export/Import
            document.getElementById('exportWorkersBtn').addEventListener('click', exportWorkersToExcel);
            document.getElementById('importWorkersBtn').addEventListener('click', () => {
                openModal('importModal');
            });
            
            document.getElementById('processImportBtn').addEventListener('click', () => {
                // Import functionality would be added here
                showToast('Excel import functionality to be implemented');
                closeModal('importModal');
            });
            
            // Site selection
            document.getElementById('currentSite').addEventListener('click', () => {
                openModal('siteSelectModal');
            });
            
            document.getElementById('confirmSiteBtn').addEventListener('click', () => {
                const selectedSiteId = document.getElementById('currentSiteSelect').value;
                if (selectedSiteId) {
                    const site = appData.sites.find(s => s.id === selectedSiteId);
                    if (site) {
                        document.getElementById('currentSite').innerHTML = `
                            <i class="fas fa-map-marker-alt"></i> ${site.name}
                        `;
                        closeModal('siteSelectModal');
                        showToast(`Site set to: ${site.name}`);
                    }
                }
            });
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        // Initialize the application
        function initializeApp() {
            loadData();
            setDefaultDates();
            initializeEventListeners();
            updateAllUI();
            
            // Show welcome message
            setTimeout(() => {
                showToast('Tonnylays Construction Management System loaded successfully');
            }, 1000);
        }

        // Start the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>